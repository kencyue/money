<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å£è¢‹è¨˜å¸³ Pro - ç§äººé™å®šç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&family=JetBrains+Mono:wght@700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; -webkit-tap-highlight-color: transparent; }
        .num-font { font-family: 'JetBrains Mono', monospace; }
        .glass-effect { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); }
        .calc-btn { transition: all 0.1s ease; border: 1px solid rgba(0,0,0,0.05); }
        .calc-btn:active { transform: scale(0.92); background-color: #f1f5f9; }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-slide-up { animation: slideUp 0.4s cubic-bezier(0, 0, 0.2, 1); }
    </style>
</head>
<body class="bg-slate-100 text-slate-900">

    <div id="login-screen" class="fixed inset-0 bg-indigo-900 z-[200] flex flex-col items-center justify-center p-8 text-white">
        <div class="bg-white/10 p-8 rounded-[3rem] mb-8 shadow-2xl animate-pulse">
            <i data-lucide="shield-check" class="w-16 h-16 text-indigo-300"></i>
        </div>
        <h1 class="text-3xl font-black mb-2 tracking-tight">ç§äººè²¡å‹™ç³»çµ±</h1>
        <p class="text-indigo-300 mb-12 text-center text-sm opacity-80 uppercase tracking-widest">Authorized Access Only</p>
        
        <div class="w-full max-w-xs space-y-4">
            <button id="google-login-btn" class="w-full bg-white text-indigo-900 font-black py-4 rounded-2xl flex items-center justify-center gap-3 shadow-2xl hover:bg-indigo-50 transition">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5" alt="google">
                ç®¡ç†å“¡ç™»å…¥
            </button>
            <p id="auth-error-msg" class="text-rose-400 text-xs text-center hidden font-bold bg-rose-950/30 p-4 rounded-xl border border-rose-500/30 animate-slide-up"></p>
        </div>
    </div>

    <div id="loading-screen" class="fixed inset-0 bg-slate-50/80 backdrop-blur-sm z-[300] hidden flex flex-col items-center justify-center">
        <div class="w-10 h-10 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin"></div>
    </div>

    <div id="app-content" class="max-w-md mx-auto h-screen flex flex-col hidden bg-slate-50 relative shadow-2xl overflow-hidden">
        
        <header class="glass-effect px-6 py-4 flex justify-between items-center border-b sticky top-0 z-50">
            <div>
                <h1 class="text-lg font-black text-slate-800 italic">POCKET PRO</h1>
                <div class="flex items-center gap-1">
                    <span class="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></span>
                    <p id="user-display" class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Admin</p>
                </div>
            </div>
            <button id="logout-btn" class="p-2.5 bg-slate-100 rounded-xl text-slate-500 hover:text-rose-500 transition"><i data-lucide="log-out" class="w-5 h-5"></i></button>
        </header>

        <main id="main-view" class="flex-1 overflow-y-auto pb-32">
            </main>

        <nav class="glass-effect border-t flex justify-around p-3 pb-8 shadow-2xl fixed bottom-0 left-0 right-0 max-w-md mx-auto z-40">
            <button onclick="switchTab('home')" class="nav-btn flex flex-col items-center p-2 rounded-2xl transition-all" data-tab="home">
                <i data-lucide="plus-circle" class="w-6 h-6"></i>
                <span class="text-[10px] font-black mt-1 uppercase">è¨˜å¸³</span>
            </button>
            <button onclick="switchTab('history')" class="nav-btn flex flex-col items-center p-2 rounded-2xl transition-all" data-tab="history">
                <i data-lucide="layout-list" class="w-6 h-6"></i>
                <span class="text-[10px] font-black mt-1 uppercase">æ˜ç´°</span>
            </button>
            <button onclick="switchTab('stats')" class="nav-btn flex flex-col items-center p-2 rounded-2xl transition-all" data-tab="stats">
                <i data-lucide="bar-chart-3" class="w-6 h-6"></i>
                <span class="text-[10px] font-black mt-1 uppercase">åˆ†æ</span>
            </button>
            <button onclick="switchTab('settings')" class="nav-btn flex flex-col items-center p-2 rounded-2xl transition-all" data-tab="settings">
                <i data-lucide="layers" class="w-6 h-6"></i>
                <span class="text-[10px] font-black mt-1 uppercase">åˆ†é¡</span>
            </button>
        </nav>
    </div>

    <div id="modal-container" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[100] hidden flex items-end"></div>
    <div id="confirm-container" class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-[110] hidden flex items-center justify-center p-8"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        // --- Firebase è¨­å®š ---
        const firebaseConfig = {
            apiKey: "AIzaSyAC6VEkioGi-VC8MHXW3-nl4ngWwPRsMyw",
            authDomain: "money-c5f6e.firebaseapp.com",
            projectId: "money-c5f6e",
            storageBucket: "money-c5f6e.firebasestorage.app",
            messagingSenderId: "965877863338",
            appId: "1:965877863338:web:59c5078c04bc4c9458d1d3",
            measurementId: "G-P2HGWB7W62"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();
        const ALLOWED_USER = "jingsyuan@gmail.com";
        const appId = 'pocket-account-pro-v2';

        const DEFAULT_CATEGORIES = [
            { id: 'cat_food', name: 'é¤é£²é£²é£Ÿ', icon: 'ğŸ½ï¸', type: 'expense', subCategories: ['æ—©é¤', 'åˆé¤', 'æ™šé¤', 'å¤–é€'] },
            { id: 'cat_transport', name: 'äº¤é€šé‹è¼¸', icon: 'ğŸš—', type: 'expense', subCategories: ['æ·é‹', 'å…¬è»Š', 'è¨ˆç¨‹è»Š'] },
            { id: 'cat_shopping', name: 'è³¼ç‰©æ¶ˆè²»', icon: 'ğŸ›ï¸', type: 'expense', subCategories: ['æ—¥ç”¨å“', 'æœé£¾', 'é›»å­ç”¢å“'] },
            { id: 'cat_income', name: 'è–ªè³‡æ”¶å…¥', icon: 'ğŸ’°', type: 'income', subCategories: ['æœˆè–ª', 'çé‡‘', 'æŠ•è³‡'] },
        ];

        let state = {
            user: null,
            activeTab: 'home',
            transactions: [],
            categories: [],
            homeStep: 1, 
            amount: '0',
            note: '',
            type: 'expense',
            selectedMainCat: null,
            statsType: 'expense'
        };

        // --- æ ¸å¿ƒæ¬Šé™æª¢æŸ¥ ---
        onAuthStateChanged(auth, async (user) => {
            const loginScreen = document.getElementById('login-screen');
            const appContent = document.getElementById('app-content');
            const errorMsg = document.getElementById('auth-error-msg');

            if (user) {
                if (user.email === ALLOWED_USER) {
                    state.user = user;
                    loginScreen.classList.add('hidden');
                    appContent.classList.remove('hidden');
                    document.getElementById('user-display').innerText = user.email;
                    initDataListeners();
                } else {
                    errorMsg.innerText = "âš ï¸ å­˜å–æ‹’çµ•ï¼šæ­¤ç³»çµ±åƒ…é™ç®¡ç†å“¡ä½¿ç”¨ã€‚";
                    errorMsg.classList.remove('hidden');
                    await signOut(auth);
                }
            } else {
                state.user = null;
                loginScreen.classList.remove('hidden');
                appContent.classList.add('hidden');
            }
            render();
        });

        // --- è³‡æ–™ç›£è½ ---
        function initDataListeners() {
            if (!state.user) return;
            const userId = state.user.uid;
            
            onSnapshot(collection(db, 'artifacts', appId, 'users', userId, 'transactions'), (snap) => {
                state.transactions = snap.docs.map(d => ({ id: d.id, ...d.data() }))
                    .sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                render();
            });

            onSnapshot(collection(db, 'artifacts', appId, 'users', userId, 'categories'), (snap) => {
                if (snap.empty) {
                    DEFAULT_CATEGORIES.forEach(c => setDoc(doc(db, 'artifacts', appId, 'users', userId, 'categories', c.id), c));
                } else {
                    state.categories = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    render();
                }
            });
        }

        // --- ä»‹é¢åˆ‡æ› ---
        window.switchTab = (tab) => {
            state.activeTab = tab;
            render();
        };

        // --- è¨ˆç®—æ©Ÿé‚è¼¯ ---
        window.handleCalculator = (val) => {
            if (val === 'C') state.amount = '0';
            else if (val === 'âŒ«') state.amount = state.amount.length > 1 ? state.amount.slice(0, -1) : '0';
            else if (val === '=') {
                try { state.amount = String(eval(state.amount.replace(/[^-()\d/*+.]/g, ''))); } catch(e) { state.amount = '0'; }
            } else {
                state.amount = (state.amount === '0' && !isNaN(val)) ? val : state.amount + val;
            }
            render();
        };

        // --- å„²å­˜å¸³ç›® ---
        window.saveRecord = async (sub) => {
            const data = {
                amount: parseFloat(state.amount),
                note: state.note,
                mainCatId: state.selectedMainCat.id,
                mainCatName: state.selectedMainCat.name,
                subCat: sub,
                type: state.type,
                timestamp: Date.now(),
                dateString: new Date().toLocaleDateString('zh-TW')
            };
            await addDoc(collection(db, 'artifacts', appId, 'users', state.user.uid, 'transactions'), data);
            state.amount = '0'; state.note = ''; state.homeStep = 1; state.activeTab = 'history';
            render();
        };

        // --- æ¸²æŸ“å‡½æ•¸ ---
        function render() {
            const main = document.getElementById('main-view');
            if (!main) return;

            document.querySelectorAll('.nav-btn').forEach(btn => {
                const isActive = btn.dataset.tab === state.activeTab;
                btn.className = `nav-btn flex flex-col items-center p-2 rounded-2xl transition-all ${isActive ? 'bg-indigo-50 text-indigo-600 scale-105' : 'text-slate-400'}`;
            });

            if (state.activeTab === 'home') renderHome(main);
            else if (state.activeTab === 'history') renderHistory(main);
            else if (state.activeTab === 'stats') renderStats(main);
            else if (state.activeTab === 'settings') renderSettings(main);

            lucide.createIcons();
        }

        // --- è¼¸å…¥å€æ”¹ç‰ˆ UI ---
        function renderHome(container) {
            if (state.homeStep === 1) {
                container.innerHTML = `
                    <div class="animate-slide-up flex flex-col h-full">
                        <div class="p-6 bg-white border-b mb-4">
                            <div class="flex gap-2 mb-6 bg-slate-100 p-1.5 rounded-2xl">
                                <button onclick="state.type='expense'; render();" class="flex-1 py-2.5 rounded-xl font-bold text-sm transition ${state.type === 'expense' ? 'bg-white text-rose-500 shadow-sm' : 'text-slate-400'}">æ”¯å‡º</button>
                                <button onclick="state.type='income'; render();" class="flex-1 py-2.5 rounded-xl font-bold text-sm transition ${state.type === 'income' ? 'bg-white text-emerald-500 shadow-sm' : 'text-slate-400'}">æ”¶å…¥</button>
                            </div>
                            <div class="num-font text-6xl font-bold text-right py-4 truncate text-slate-800">$${state.amount}</div>
                            <div class="relative mt-2">
                                <i data-lucide="pencil" class="absolute left-4 top-4 w-4 h-4 text-slate-300"></i>
                                <input type="text" placeholder="è¼¸å…¥å‚™è¨»..." value="${state.note}" oninput="state.note=this.value" 
                                    class="w-full bg-slate-50 border-2 border-slate-100 rounded-2xl py-4 pl-12 pr-4 text-sm font-bold focus:border-indigo-500 transition outline-none" />
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-4 gap-2 px-4 pb-4">
                            ${['7','8','9','âŒ«','4','5','6','/','1','2','3','*','0','.','C','-'].map(b => 
                                `<button onclick="handleCalculator('${b}')" class="calc-btn h-16 bg-white rounded-2xl font-bold text-xl text-slate-700 shadow-sm">${b}</button>`
                            ).join('')}
                            <button onclick="handleCalculator('+')" class="calc-btn h-16 bg-indigo-50 text-indigo-600 rounded-2xl font-bold text-2xl">+</button>
                            <button onclick="handleCalculator('=')" class="calc-btn h-16 bg-indigo-50 text-indigo-600 rounded-2xl font-bold text-2xl">=</button>
                            <button onclick="state.homeStep=2; render();" class="col-span-2 h-16 bg-indigo-600 text-white rounded-2xl font-black flex items-center justify-center gap-2 shadow-lg">
                                é¸æ“‡åˆ†é¡ <i data-lucide="arrow-right" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </div>
                `;
            } else {
                const cats = state.categories.filter(c => c.type === state.type);
                container.innerHTML = `
                    <div class="p-6 animate-slide-up">
                        <button onclick="state.homeStep=1; render();" class="flex items-center gap-2 text-indigo-600 font-bold mb-6">
                            <i data-lucide="chevron-left" class="w-5 h-5"></i> è¿”å›ä¿®æ”¹é‡‘é¡
                        </button>
                        <div class="grid grid-cols-3 gap-3 mb-8">
                            ${cats.map(cat => `
                                <button onclick="state.selectedMainCat=${JSON.stringify(cat).replace(/"/g, '&quot;')}; render();" 
                                    class="p-4 rounded-[2rem] border-2 transition flex flex-col items-center gap-2 ${state.selectedMainCat?.id === cat.id ? 'border-indigo-600 bg-indigo-50' : 'border-transparent bg-white shadow-sm'}">
                                    <span class="text-3xl">${cat.icon || 'ğŸ“'}</span>
                                    <span class="text-[10px] font-black text-slate-600">${cat.name}</span>
                                </button>
                            `).join('')}
                        </div>
                        ${state.selectedMainCat ? `
                            <div class="bg-slate-900 p-8 rounded-[3rem] shadow-2xl animate-slide-up">
                                <p class="text-slate-400 text-[10px] font-black mb-6 text-center tracking-widest uppercase">å­é¡åˆ¥ç´°åˆ†</p>
                                <div class="grid grid-cols-2 gap-3">
                                    ${state.selectedMainCat.subCategories?.map(sub => `
                                        <button onclick="saveRecord('${sub}')" class="py-4 bg-white/10 hover:bg-white text-white hover:text-slate-900 rounded-2xl font-bold text-sm transition-all">${sub}</button>
                                    `).join('')}
                                    <button onclick="saveRecord('å…¶ä»–')" class="py-4 bg-white/5 text-slate-500 rounded-2xl font-bold text-sm">å…¶ä»–</button>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }
        }

        // --- å…¶é¤˜é é¢æ¸²æŸ“ (ç°¡åŒ–ç‰ˆæœ¬) ---
        function renderHistory(container) {
            container.innerHTML = `<div class="p-6">
                <h2 class="text-2xl font-black mb-6">æ”¶æ”¯æ˜ç´°</h2>
                <div class="space-y-3">
                    ${state.transactions.map(tx => `
                        <div class="bg-white p-4 rounded-2xl flex items-center gap-4 shadow-sm border border-slate-100">
                            <div class="w-12 h-12 bg-slate-50 rounded-xl flex items-center justify-center text-xl">${state.categories.find(c => c.id === tx.mainCatId)?.icon || 'ğŸ“'}</div>
                            <div class="flex-1">
                                <div class="flex justify-between font-black">
                                    <span>${tx.subCat}</span>
                                    <span class="${tx.type === 'income' ? 'text-emerald-500' : 'text-rose-500'}">${tx.type === 'income' ? '+' : '-'}${tx.amount}</span>
                                </div>
                                <div class="text-[10px] text-slate-400 font-bold uppercase tracking-tight">${tx.dateString} Â· ${tx.mainCatName}</div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>`;
        }

        function renderStats(container) { container.innerHTML = '<div class="p-20 text-center text-slate-300 font-bold italic">åˆ†æåŠŸèƒ½è¼‰å…¥ä¸­...</div>'; }
        function renderSettings(container) { container.innerHTML = '<div class="p-20 text-center text-slate-300 font-bold italic">è¨­å®šåŠŸèƒ½è¼‰å…¥ä¸­...</div>'; }

        // --- ç™»å…¥ ---
        document.getElementById('google-login-btn').onclick = async () => {
            try { await signInWithPopup(auth, provider); } catch (e) { console.error(e); }
        };
        document.getElementById('logout-btn').onclick = () => signOut(auth);

    </script>
</body>
</html>
