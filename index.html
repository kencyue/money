<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å£è¢‹è¨˜å¸³ Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; -webkit-tap-highlight-color: transparent; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
        .modal-enter { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .scale-in { animation: scaleIn 0.2s ease-out; }
        @keyframes scaleIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">

    <!-- ç™»å…¥ç•«é¢ -->
    <div id="login-screen" class="fixed inset-0 bg-indigo-700 z-[200] flex flex-col items-center justify-center p-8 text-white">
        <div class="bg-white/10 p-8 rounded-[3rem] mb-10 shadow-2xl">
            <i data-lucide="calculator" class="w-16 h-16 text-white opacity-90"></i>
        </div>
        <h1 class="text-4xl font-black mb-2 tracking-tight">å£è¢‹è¨˜å¸³ PRO</h1>
        <p class="text-indigo-200 mb-12 text-center text-lg opacity-80">æ‚¨çš„é›²ç«¯è²¡å‹™ç®¡å®¶</p>
        
        <div class="w-full space-y-3">
            <button id="google-login-btn" class="w-full bg-white text-indigo-700 font-black py-5 rounded-2xl flex items-center justify-center gap-4 shadow-2xl active:scale-95 transition">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-6" alt="google">
                é€é Google ç™»å…¥
            </button>
            <p id="auth-error-msg" class="text-rose-300 text-xs text-center hidden font-bold bg-rose-900/20 p-3 rounded-xl"></p>
        </div>
    </div>

    <!-- è¼‰å…¥ä¸­é®ç½© -->
    <div id="loading-screen" class="fixed inset-0 bg-white/90 z-[300] hidden flex flex-col items-center justify-center">
        <div class="w-12 h-12 border-[6px] border-indigo-600 border-t-transparent rounded-full animate-spin mb-4"></div>
        <p class="text-indigo-600 font-black animate-pulse uppercase tracking-widest text-xs">åŒæ­¥é›²ç«¯è³‡æ–™ä¸­...</p>
    </div>

    <!-- ä¸»æ‡‰ç”¨ç¨‹å¼çµæ§‹ -->
    <div id="app-content" class="max-w-md mx-auto h-screen flex flex-col hidden relative overflow-hidden bg-white shadow-2xl">
        
        <!-- Header -->
        <header class="bg-white px-6 py-4 flex justify-between items-center border-b">
            <div>
                <h1 class="text-xl font-black text-slate-800 tracking-tight italic">POCKET PRO</h1>
                <p id="user-display" class="text-[10px] font-bold text-indigo-500 uppercase tracking-widest">USER</p>
            </div>
            <button id="logout-btn" class="p-2 text-slate-400 hover:text-rose-500 transition"><i data-lucide="log-out" class="w-5 h-5"></i></button>
        </header>

        <!-- Main Viewport -->
        <main id="main-view" class="flex-1 overflow-y-auto pb-24">
            <!-- è¦–åœ–å…§å®¹æœƒç”± JS å‹•æ…‹æ³¨å…¥ -->
        </main>

        <!-- Bottom Nav -->
        <nav class="bg-white border-t flex justify-around p-4 pb-8 shadow-[0_-10px_30px_rgba(0,0,0,0.03)] fixed bottom-0 left-0 right-0 max-w-md mx-auto z-40">
            <button onclick="switchTab('home')" class="nav-btn flex flex-col items-center gap-1.5 transition-all text-indigo-600" data-tab="home">
                <i data-lucide="plus" class="w-6 h-6"></i>
                <span class="text-[10px] font-black uppercase tracking-widest">è¨˜å¸³</span>
            </button>
            <button onclick="switchTab('history')" class="nav-btn flex flex-col items-center gap-1.5 transition-all text-slate-300" data-tab="history">
                <i data-lucide="history" class="w-6 h-6"></i>
                <span class="text-[10px] font-black uppercase tracking-widest">æ˜ç´°</span>
            </button>
            <button onclick="switchTab('stats')" class="nav-btn flex flex-col items-center gap-1.5 transition-all text-slate-300" data-tab="stats">
                <i data-lucide="pie-chart" class="w-6 h-6"></i>
                <span class="text-[10px] font-black uppercase tracking-widest">åˆ†æ</span>
            </button>
            <button onclick="switchTab('settings')" class="nav-btn flex flex-col items-center gap-1.5 transition-all text-slate-300" data-tab="settings">
                <i data-lucide="settings" class="w-6 h-6"></i>
                <span class="text-[10px] font-black uppercase tracking-widest">åˆ†é¡</span>
            </button>
        </nav>
    </div>

    <!-- Modals & Overlays -->
    <div id="modal-container" class="fixed inset-0 bg-slate-900/60 backdrop-blur-md z-[100] hidden flex items-end">
        <!-- å…§å®¹ç”± JS å‹•æ…‹ç”Ÿæˆ -->
    </div>

    <div id="confirm-container" class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-[110] hidden flex items-center justify-center p-8">
        <!-- å…§å®¹ç”± JS å‹•æ…‹ç”Ÿæˆ -->
    </div>

    <!-- Firebase & Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, onSnapshot, setDoc, query, where } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        // --- Firebase é…ç½® ---
        const firebaseConfig = {
            apiKey: "AIzaSyAC6VEkioGi-VC8MHXW3-nl4ngWwPRsMyw",
            authDomain: "money-c5f6e.firebaseapp.com",
            projectId: "money-c5f6e",
            storageBucket: "money-c5f6e.firebasestorage.app",
            messagingSenderId: "965877863338",
            appId: "1:965877863338:web:59c5078c04bc4c9458d1d3",
            measurementId: "G-P2HGWB7W62"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'pocket-account-pro-v2';

        const DEFAULT_CATEGORIES = [
            { id: 'cat_food', name: 'é¤é£²é£²é£Ÿ', icon: 'ğŸ½ï¸', type: 'expense', subCategories: ['æ—©é¤', 'åˆé¤', 'æ™šé¤', 'é£²æ–™'] },
            { id: 'cat_transport', name: 'äº¤é€šé‹è¼¸', icon: 'ğŸš—', type: 'expense', subCategories: ['æ·é‹', 'å…¬è»Š', 'åŠ æ²¹'] },
            { id: 'cat_income', name: 'è–ªè³‡æ”¶å…¥', icon: 'ğŸ’°', type: 'income', subCategories: ['è–ªè³‡', 'çé‡‘'] },
        ];

        // --- ç‹€æ…‹ç®¡ç† ---
        let state = {
            user: null,
            activeTab: 'home',
            transactions: [],
            categories: [],
            homeStep: 1, 
            amount: '0',
            note: '',
            type: 'expense',
            selectedMainCat: null,
            editItem: null,
            statsType: 'expense'
        };

        // --- é©—è­‰æµç¨‹ (éµå¾ªç’°å¢ƒè¦å‰‡ 3) ---
        const initAuth = async () => {
            try {
                // å„ªå…ˆä½¿ç”¨ç’°å¢ƒæä¾›çš„ Token
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                }
                // å¦‚æœæ²’æœ‰ Token ä¸”ç›®å‰æ²’æœ‰ä½¿ç”¨è€…ï¼Œä¿æŒç™»å…¥ç•«é¢ä¾›ä½¿ç”¨è€…æ‰‹å‹•æ“ä½œ
            } catch (e) {
                console.error("é©—è­‰åˆå§‹åŒ–å¤±æ•—:", e);
            }
        };

        onAuthStateChanged(auth, (user) => {
            state.user = user;
            const loginScreen = document.getElementById('login-screen');
            const appContent = document.getElementById('app-content');
            
            if (user) {
                loginScreen.classList.add('hidden');
                appContent.classList.remove('hidden');
                document.getElementById('user-display').innerText = user.email ? user.email.split('@')[0] : 'åŒ¿åç”¨æˆ¶';
                initDataListeners();
            } else {
                loginScreen.classList.remove('hidden');
                appContent.classList.add('hidden');
            }
            render();
        });

        function initDataListeners() {
            if (!state.user) return;
            showLoading(true);
            const userId = state.user.uid;
            
            // ç›£è½äº¤æ˜“ç´€éŒ„
            const txRef = collection(db, 'artifacts', appId, 'users', userId, 'transactions');
            onSnapshot(txRef, (snapshot) => {
                state.transactions = snapshot.docs.map(d => ({ id: d.id, ...d.data() }))
                    .sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                render();
                showLoading(false);
            }, (err) => {
                console.error("è®€å–äº¤æ˜“ç´€éŒ„å‡ºéŒ¯:", err);
                showLoading(false);
            });

            // ç›£è½åˆ†é¡
            const catRef = collection(db, 'artifacts', appId, 'users', userId, 'categories');
            onSnapshot(catRef, (snapshot) => {
                if (snapshot.empty) {
                    DEFAULT_CATEGORIES.forEach(c => setDoc(doc(db, 'artifacts', appId, 'users', userId, 'categories', c.id), c));
                } else {
                    state.categories = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                    render();
                }
            }, (err) => console.error("è®€å–åˆ†é¡å‡ºéŒ¯:", err));
        }

        // --- æ“ä½œå‡½æ•¸ ---
        window.switchTab = (tab) => {
            state.activeTab = tab;
            render();
        };

        window.handleCalculator = (val) => {
            if (val === 'C') state.amount = '0';
            else if (val === 'âŒ«') state.amount = state.amount.length > 1 ? state.amount.slice(0, -1) : '0';
            else if (val === '=') {
                try {
                    const res = Function('"use strict";return (' + state.amount.replace(/[^-()\d/*+.]/g, '') + ')')();
                    state.amount = String(Math.round(res * 100) / 100);
                } catch (e) { state.amount = 'Error'; }
            } else {
                state.amount = (state.amount === '0' && !isNaN(val)) ? val : state.amount + val;
            }
            render();
        };

        window.saveRecord = async (sub) => {
            if (!state.user) return;
            const data = {
                amount: parseFloat(state.amount),
                note: state.note,
                mainCatId: state.selectedMainCat.id,
                mainCatName: state.selectedMainCat.name,
                subCat: sub,
                type: state.type,
                timestamp: Date.now(),
                dateString: new Date().toLocaleDateString('zh-TW')
            };
            try {
                await addDoc(collection(db, 'artifacts', appId, 'users', state.user.uid, 'transactions'), data);
                resetForm();
                state.activeTab = 'history';
                render();
            } catch (e) {
                console.error("å„²å­˜ç´€éŒ„å¤±æ•—:", e);
            }
        };

        window.resetForm = () => {
            state.amount = '0';
            state.note = '';
            state.homeStep = 1;
            state.selectedMainCat = null;
        };

        window.openDeleteConfirm = (type, id, name) => {
            const container = document.getElementById('confirm-container');
            container.innerHTML = `
                <div class="bg-white rounded-[2.5rem] p-8 w-full max-w-xs text-center space-y-6 shadow-2xl scale-in">
                    <div class="w-20 h-20 bg-rose-100 text-rose-600 rounded-full flex items-center justify-center mx-auto">
                        <i data-lucide="alert-circle" class="w-10 h-10"></i>
                    </div>
                    <div>
                        <h4 class="text-xl font-black text-slate-800">ç¢ºå®šåˆªé™¤ï¼Ÿ</h4>
                        <p class="text-slate-500 text-sm mt-2 font-medium">æ‚¨æ­£æº–å‚™åˆªé™¤ã€Œ${name}ã€ï¼Œæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚</p>
                    </div>
                    <div class="flex flex-col gap-2">
                        <button onclick="executeDelete('${type}', '${id}')" class="w-full bg-rose-600 text-white py-4 rounded-2xl font-black shadow-lg shadow-rose-100">æ˜¯çš„ï¼Œæˆ‘è¦åˆªé™¤</button>
                        <button onclick="closeConfirm()" class="w-full bg-slate-100 text-slate-500 py-4 rounded-2xl font-black">å–æ¶ˆ</button>
                    </div>
                </div>
            `;
            container.classList.remove('hidden');
            lucide.createIcons();
        };

        window.executeDelete = async (type, id) => {
            if (!state.user) return;
            const coll = type === 'record' ? 'transactions' : 'categories';
            try {
                await deleteDoc(doc(db, 'artifacts', appId, 'users', state.user.uid, coll, id));
                closeConfirm();
                closeModal();
                render();
            } catch (e) {
                console.error("åˆªé™¤å¤±æ•—:", e);
            }
        };

        window.closeConfirm = () => document.getElementById('confirm-container').classList.add('hidden');
        window.closeModal = () => {
            state.editItem = null;
            document.getElementById('modal-container').classList.add('hidden');
        };

        window.showLoading = (show) => document.getElementById('loading-screen').classList[show ? 'remove' : 'add']('hidden');

        // --- æ¸²æŸ“å¼•æ“ ---
        function render() {
            const main = document.getElementById('main-view');
            if (!main) return;
            
            const navBtns = document.querySelectorAll('.nav-btn');
            navBtns.forEach(btn => {
                const isActive = btn.dataset.tab === state.activeTab;
                btn.className = `nav-btn flex flex-col items-center gap-1.5 transition-all ${isActive ? 'text-indigo-600 scale-110' : 'text-slate-300'}`;
            });

            if (state.activeTab === 'home') renderHome(main);
            else if (state.activeTab === 'history') renderHistory(main);
            else if (state.activeTab === 'stats') renderStats(main);
            else if (state.activeTab === 'settings') renderSettings(main);

            lucide.createIcons();
        }

        function renderHome(container) {
            if (state.homeStep === 1) {
                container.innerHTML = `
                    <div class="h-full flex flex-col">
                        <div class="bg-indigo-600 p-8 text-white shadow-inner">
                            <div class="flex gap-2 mb-6">
                                <button onclick="state.type='expense'; render();" class="flex-1 py-3 rounded-2xl text-sm font-black transition ${state.type === 'expense' ? 'bg-white text-indigo-600 shadow-lg' : 'bg-indigo-500/50 text-indigo-100'}">æ”¯å‡º</button>
                                <button onclick="state.type='income'; render();" class="flex-1 py-3 rounded-2xl text-sm font-black transition ${state.type === 'income' ? 'bg-white text-indigo-600 shadow-lg' : 'bg-indigo-500/50 text-indigo-100'}">æ”¶å…¥</button>
                            </div>
                            <div class="text-6xl font-mono font-bold mb-6 truncate tracking-tighter">$${state.amount}</div>
                            <input type="text" id="note-input" placeholder="é»æ“Šè¼¸å…¥å‚™è¨»..." value="${state.note}" oninput="state.note=this.value" class="w-full bg-indigo-500/30 border-none rounded-2xl p-4 text-white placeholder-indigo-200 focus:ring-2 focus:ring-white/50" />
                        </div>
                        <div class="grid grid-cols-4 gap-1.5 p-3 bg-slate-200 flex-1">
                            ${['7','8','9','âŒ«','4','5','6','/','1','2','3','*','0','.','C','-'].map(b => `<button onclick="handleCalculator('${b}')" class="bg-white rounded-2xl h-14 font-bold text-xl text-slate-700 shadow-sm active:bg-indigo-50 active:scale-95 transition">${b}</button>`).join('')}
                            <button onclick="handleCalculator('+')" class="bg-indigo-100 text-indigo-700 rounded-2xl font-black text-xl">+</button>
                            <button onclick="handleCalculator('=')" class="bg-indigo-100 text-indigo-700 rounded-2xl font-black text-xl">=</button>
                            <button onclick="state.homeStep=2; render();" class="col-span-2 bg-indigo-600 text-white font-black rounded-2xl flex items-center justify-center gap-2 shadow-lg active:scale-95">ä¸‹ä¸€æ­¥ <i data-lucide="chevron-right" class="w-5 h-5"></i></button>
                        </div>
                    </div>
                `;
            } else {
                const cats = state.categories.filter(c => c.type === state.type);
                container.innerHTML = `
                    <div class="p-5 space-y-6 fade-in">
                        <button onclick="state.homeStep=1; render();" class="flex items-center gap-2 text-indigo-600 font-black"><i data-lucide="arrow-left" class="w-5 h-5"></i> è¿”å›ä¿®æ”¹é‡‘é¡</button>
                        <div class="grid grid-cols-3 gap-4">
                            ${cats.map(cat => `
                                <button onclick="state.selectedMainCat=${JSON.stringify(cat).replace(/"/g, '&quot;')}; render();" 
                                    class="p-5 rounded-3xl border-4 transition flex flex-col items-center gap-2 ${state.selectedMainCat?.id === cat.id ? 'border-indigo-600 bg-white shadow-xl' : 'border-transparent bg-white shadow-sm'}">
                                    <span class="text-3xl">${cat.icon || 'ğŸ“'}</span>
                                    <span class="text-xs font-black text-slate-700">${cat.name}</span>
                                </button>
                            `).join('')}
                        </div>
                        ${state.selectedMainCat ? `
                            <div class="bg-indigo-600 p-6 rounded-[2.5rem] shadow-2xl modal-enter">
                                <p class="text-indigo-100 text-xs font-black mb-4 uppercase tracking-widest text-center opacity-70">é¸æ“‡å­åˆ†é¡</p>
                                <div class="grid grid-cols-2 gap-3">
                                    ${state.selectedMainCat.subCategories?.map(sub => `
                                        <button onclick="saveRecord('${sub}')" class="p-4 bg-white/10 hover:bg-white text-white hover:text-indigo-600 rounded-2xl font-black transition-all">${sub}</button>
                                    `).join('')}
                                    <button onclick="saveRecord('å…¶ä»–')" class="p-4 bg-white/5 text-indigo-200 rounded-2xl font-black italic">å…¶ä»–</button>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }
        }

        function renderHistory(container) {
            container.innerHTML = `
                <div class="p-5 space-y-4">
                    <h2 class="text-2xl font-black text-slate-800 mb-6 tracking-tight">æ”¶æ”¯æ˜ç´°</h2>
                    ${state.transactions.map(tx => `
                        <div onclick="openEditModal('${tx.id}')" class="bg-white p-5 rounded-[2rem] shadow-sm flex items-center gap-4 active:bg-slate-50 border border-slate-100">
                            <div class="w-14 h-14 bg-indigo-50 rounded-2xl flex items-center justify-center text-2xl">
                                ${state.categories.find(c => c.id === tx.mainCatId)?.icon || 'ğŸ“'}
                            </div>
                            <div class="flex-1">
                                <div class="flex justify-between items-start mb-1">
                                    <span class="font-black text-slate-800 text-lg">${tx.subCat}</span>
                                    <span class="font-mono font-black text-lg ${tx.type === 'income' ? 'text-emerald-500' : 'text-rose-500'}">
                                        ${tx.type === 'income' ? '+' : '-'}${tx.amount.toLocaleString()}
                                    </span>
                                </div>
                                <div class="flex justify-between items-center text-xs text-slate-400 font-bold">
                                    <span>${tx.dateString} Â· ${tx.mainCatName}</span>
                                    <span class="bg-slate-100 px-2 py-0.5 rounded-full truncate max-w-[80px]">${tx.note || 'ç„¡å‚™è¨»'}</span>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                    ${state.transactions.length === 0 ? '<div class="text-center py-20 text-slate-300 font-bold italic">å°šç„¡ä»»ä½•äº¤æ˜“ç´€éŒ„</div>' : ''}
                </div>
            `;
        }

        window.openEditModal = (id) => {
            const tx = state.transactions.find(t => t.id === id);
            state.editItem = tx;
            const modal = document.getElementById('modal-container');
            modal.innerHTML = `
                <div class="w-full bg-white rounded-t-[3rem] p-8 space-y-8 modal-enter shadow-2xl">
                    <div class="flex justify-between items-center">
                        <h3 class="font-black text-2xl text-slate-800">ä¿®æ”¹å¸³ç›®</h3>
                        <button onclick="closeModal()" class="p-3 bg-slate-100 rounded-full text-slate-400"><i data-lucide="x"></i></button>
                    </div>
                    <div class="space-y-6">
                        <div class="bg-slate-50 p-6 rounded-3xl border-2 border-indigo-50 focus-within:border-indigo-600 transition">
                            <label class="text-[10px] font-black text-indigo-400 uppercase tracking-widest mb-2 block">é‡‘é¡</label>
                            <input type="number" id="edit-amount" class="text-5xl font-mono font-black w-full bg-transparent border-none p-0 focus:ring-0 text-slate-800" value="${tx.amount}" />
                        </div>
                        <div class="bg-slate-50 p-6 rounded-3xl">
                            <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2 block">å‚™è¨»</label>
                            <input type="text" id="edit-note" class="w-full bg-transparent text-xl font-bold border-none p-0 focus:ring-0" value="${tx.note || ''}" />
                        </div>
                    </div>
                    <div class="flex gap-3">
                        <button onclick="updateRecord('${tx.id}')" class="flex-[3] bg-indigo-600 text-white py-5 rounded-[2rem] font-black text-lg shadow-xl shadow-indigo-100 active:scale-95 transition">å„²å­˜è®Šæ›´</button>
                        <button onclick="openDeleteConfirm('record', '${tx.id}', 'æ­¤ç­†å¸³å‹™')" class="flex-1 bg-rose-50 text-rose-500 p-5 rounded-[2rem] flex items-center justify-center active:scale-95 transition"><i data-lucide="trash-2" class="w-7 h-7"></i></button>
                    </div>
                </div>
            `;
            modal.classList.remove('hidden');
            lucide.createIcons();
        };

        window.updateRecord = async (id) => {
            if (!state.user) return;
            const amount = parseFloat(document.getElementById('edit-amount').value);
            const note = document.getElementById('edit-note').value;
            try {
                await updateDoc(doc(db, 'artifacts', appId, 'users', state.user.uid, 'transactions', id), { amount, note });
                closeModal();
                render();
            } catch (e) {
                console.error("æ›´æ–°å¤±æ•—:", e);
            }
        };

        function renderStats(container) {
            const type = state.statsType;
            const filtered = state.transactions.filter(t => t.type === type);
            const total = filtered.reduce((s, t) => s + t.amount, 0);
            const groups = filtered.reduce((acc, t) => {
                acc[t.mainCatName] = (acc[t.mainCatName] || 0) + t.amount;
                return acc;
            }, {});
            const sorted = Object.entries(groups).sort((a,b) => b[1] - a[1]);

            container.innerHTML = `
                <div class="p-6 space-y-6">
                    <div class="bg-white p-2 rounded-[2rem] flex shadow-sm border border-slate-100">
                        <button onclick="state.statsType='expense'; render();" class="flex-1 py-4 rounded-[1.5rem] font-black transition ${type === 'expense' ? 'bg-rose-600 text-white shadow-lg shadow-rose-100' : 'text-slate-400'}">æ”¯å‡ºæ’è¡Œ</button>
                        <button onclick="state.statsType='income'; render();" class="flex-1 py-4 rounded-[1.5rem] font-black transition ${type === 'income' ? 'bg-emerald-600 text-white shadow-lg shadow-emerald-100' : 'text-slate-400'}">æ”¶å…¥æ’è¡Œ</button>
                    </div>
                    <div class="bg-indigo-600 p-10 rounded-[3rem] shadow-2xl text-center relative overflow-hidden">
                        <div class="absolute top-0 right-0 w-32 h-32 bg-white/5 rounded-full -mr-10 -mt-10"></div>
                        <p class="text-indigo-200 text-xs font-black mb-2 uppercase tracking-[0.3em] opacity-80">æœ¬æœˆç¸½é¡</p>
                        <p class="text-5xl font-mono font-black text-white tracking-tighter">$${total.toLocaleString()}</p>
                    </div>
                    <div class="space-y-6">
                        ${sorted.map(([name, val]) => {
                            const pct = total > 0 ? Math.round(val/total*100) : 0;
                            return `
                                <div class="space-y-2">
                                    <div class="flex justify-between items-end">
                                        <span class="font-black text-slate-700">${name}</span>
                                        <div class="text-right">
                                            <span class="text-sm font-black text-slate-900 block">$${val.toLocaleString()}</span>
                                            <span class="text-[10px] font-bold text-slate-400 uppercase">${pct}% of total</span>
                                        </div>
                                    </div>
                                    <div class="w-full bg-slate-200 h-3 rounded-full overflow-hidden">
                                        <div class="h-full rounded-full transition-all duration-1000 ${type === 'income' ? 'bg-emerald-500' : 'bg-rose-500'}" style="width: ${pct}%"></div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                        ${sorted.length === 0 ? '<div class="text-center py-20 text-slate-300 font-bold italic">å°šç„¡åˆ†æè³‡æ–™</div>' : ''}
                    </div>
                </div>
            `;
        }

        function renderSettings(container) {
            container.innerHTML = `
                <div class="p-6 space-y-6">
                    <div class="flex justify-between items-center">
                        <h2 class="font-black text-2xl text-slate-800">åˆ†é¡è¨­å®š</h2>
                        <button onclick="toggleAddCat(true)" class="bg-indigo-600 text-white p-3 rounded-2xl shadow-lg shadow-indigo-100 active:scale-95"><i data-lucide="plus"></i></button>
                    </div>
                    <div id="add-cat-form" class="bg-white p-6 rounded-[2rem] shadow-2xl border-2 border-indigo-100 space-y-5 hidden fade-in">
                        <div class="flex bg-slate-100 p-1.5 rounded-2xl">
                            <button onclick="setNewCatType('expense')" id="btn-new-expense" class="flex-1 py-3 rounded-xl font-black text-xs transition bg-white text-rose-600 shadow-sm">æ”¯å‡ºé¡åˆ¥</button>
                            <button onclick="setNewCatType('income')" id="btn-new-income" class="flex-1 py-3 rounded-xl font-black text-xs transition text-slate-400">æ”¶å…¥é¡åˆ¥</button>
                        </div>
                        <input id="new-cat-name" placeholder="ä¸»é¡åˆ¥åç¨± (å¦‚: é‹å‹•)" class="w-full bg-slate-50 p-4 rounded-2xl border-none font-bold" />
                        <input id="new-cat-subs" placeholder="å­é¡åˆ¥ (å¦‚: æœˆè²», æ•™ç·´, å™¨æ)" class="w-full bg-slate-50 p-4 rounded-2xl border-none font-bold text-sm" />
                        <div class="flex gap-2">
                            <button onclick="executeAddCat()" class="flex-[2] bg-indigo-600 text-white py-4 rounded-2xl font-black">æ–°å¢åˆ†é¡</button>
                            <button onclick="toggleAddCat(false)" class="flex-1 bg-slate-100 text-slate-500 py-4 rounded-2xl font-black">å–æ¶ˆ</button>
                        </div>
                    </div>
                    <div class="space-y-3">
                        ${state.categories.map(cat => `
                            <div class="bg-white p-5 rounded-[2rem] flex items-center gap-4 group border border-slate-100 shadow-sm">
                                <span class="text-3xl">${cat.icon || 'ğŸ“'}</span>
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 mb-1">
                                        <span class="font-black text-slate-700">${cat.name}</span>
                                        <span class="text-[8px] px-2 py-0.5 rounded-full font-black uppercase tracking-tighter ${cat.type === 'income' ? 'bg-emerald-100 text-emerald-600' : 'bg-rose-100 text-rose-600'}">${cat.type === 'income' ? 'æ”¶å…¥' : 'æ”¯å‡º'}</span>
                                    </div>
                                    <p class="text-[10px] font-bold text-slate-400 truncate">${cat.subCategories?.join(' Â· ') || 'ç„¡å­é¡åˆ¥'}</p>
                                </div>
                                <button onclick="openDeleteConfirm('category', '${cat.id}', '${cat.name}')" class="p-2 text-slate-200 hover:text-rose-500 transition"><i data-lucide="trash-2" class="w-6 h-6"></i></button>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        let newCatType = 'expense';
        window.toggleAddCat = (show) => document.getElementById('add-cat-form').classList[show ? 'remove' : 'add']('hidden');
        window.setNewCatType = (type) => {
            newCatType = type;
            document.getElementById('btn-new-expense').className = `flex-1 py-3 rounded-xl font-black text-xs transition ${type === 'expense' ? 'bg-white text-rose-600 shadow-sm' : 'text-slate-400'}`;
            document.getElementById('btn-new-income').className = `flex-1 py-3 rounded-xl font-black text-xs transition ${type === 'income' ? 'bg-white text-emerald-600 shadow-sm' : 'text-slate-400'}`;
        };
        window.executeAddCat = async () => {
            const name = document.getElementById('new-cat-name').value;
            const subsStr = document.getElementById('new-cat-subs').value;
            if (!name || !state.user) return;
            const id = 'cat_' + Date.now();
            const data = {
                id,
                name,
                icon: 'ğŸ“',
                type: newCatType,
                subCategories: subsStr.split(/[,ï¼Œ]/).map(s => s.trim()).filter(Boolean)
            };
            try {
                await setDoc(doc(db, 'artifacts', appId, 'users', state.user.uid, 'categories', id), data);
                toggleAddCat(false);
                render();
            } catch (e) {
                console.error("æ–°å¢åˆ†é¡å¤±æ•—:", e);
            }
        };

        // --- ç™»å…¥èˆ‡ç™»å‡ºäº‹ä»¶ ---
        document.getElementById('google-login-btn').onclick = async () => {
            const errorMsg = document.getElementById('auth-error-msg');
            errorMsg.classList.add('hidden');
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Login Error", error);
                if (error.code === 'auth/unauthorized-domain') {
                    errorMsg.innerText = "ç™»å…¥å¤±æ•—ï¼šç•¶å‰ç¶²åŸŸæœªç²æˆæ¬Šã€‚è«‹åœ¨ Firebase æ§åˆ¶å°å°‡æ­¤ç¶²åŸŸæ–°å¢è‡³ã€Œæˆæ¬Šç¶²åŸŸã€ï¼Œæˆ–æ”¹ç”¨åŒ¿åæ¨¡å¼æ¸¬è©¦ã€‚";
                    errorMsg.classList.remove('hidden');
                    // ç•¶ Google ç™»å…¥å› ç¶²åŸŸå•é¡Œå¤±æ•—æ™‚ï¼Œæä¾›åŒ¿åç™»å…¥ä½œç‚ºå‚™é¸æ–¹æ¡ˆä»¥ç¢ºä¿ App å¯ç”¨
                    setTimeout(async () => {
                        if (confirm("åµæ¸¬åˆ°ç¶²åŸŸæˆæ¬Šå•é¡Œã€‚æ˜¯å¦æ”¹ç”¨åŒ¿åæ¨¡å¼ç™»å…¥ä»¥ç¹¼çºŒä½¿ç”¨ Appï¼Ÿ")) {
                            await signInAnonymously(auth);
                        }
                    }, 1000);
                }
            }
        };
        
        document.getElementById('logout-btn').onclick = () => signOut(auth);

        // å•Ÿå‹•èº«ä»½é©—è­‰åˆå§‹åŒ–
        initAuth();

    </script>
</body>
</html>
