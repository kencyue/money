<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å£è¢‹è¨˜å¸³ Pro - å°ˆæ¥­ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&family=JetBrains+Mono:wght@700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; -webkit-tap-highlight-color: transparent; }
        .num-font { font-family: 'JetBrains Mono', monospace; }
        .glass-effect { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
        .calc-btn { transition: all 0.1s ease; border: 1px solid rgba(0,0,0,0.05); }
        .calc-btn:active { transform: scale(0.92); background-color: #f1f5f9; }
        .animate-slide { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(15px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body class="bg-slate-100 text-slate-900">

    <div id="login-screen" class="fixed inset-0 bg-indigo-950 z-[200] flex flex-col items-center justify-center p-8 text-white">
        <div class="bg-white/10 p-8 rounded-[3rem] mb-6 shadow-2xl animate-pulse"><i data-lucide="shield-check" class="w-16 h-16 text-indigo-300"></i></div>
        <h1 class="text-3xl font-black mb-10">ç§äººè²¡å‹™ç³»çµ±</h1>
        <button id="google-login-btn" class="w-full max-w-xs bg-white text-indigo-900 font-black py-4 rounded-2xl flex items-center justify-center gap-3">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5"> ç®¡ç†å“¡ç™»å…¥
        </button>
        <p id="auth-error-msg" class="mt-4 text-rose-400 text-xs hidden font-bold"></p>
    </div>

    <div id="app-content" class="max-w-md mx-auto h-screen flex flex-col hidden bg-slate-50 relative shadow-2xl overflow-hidden">
        <header class="glass-effect px-6 py-4 flex justify-between items-center border-b sticky top-0 z-50">
            <div>
                <h1 class="text-lg font-black text-slate-800 italic leading-none">POCKET PRO</h1>
                <p id="user-display" class="text-[10px] font-bold text-indigo-500 tracking-widest uppercase mt-1">Admin</p>
            </div>
            <button id="logout-btn" class="p-2.5 bg-slate-100 rounded-xl text-slate-500 hover:text-rose-500 transition"><i data-lucide="log-out" class="w-5 h-5"></i></button>
        </header>

        <main id="main-view" class="flex-1 overflow-y-auto pb-32"></main>

        <nav class="glass-effect border-t flex justify-around p-3 pb-8 fixed bottom-0 left-0 right-0 max-w-md mx-auto z-40">
            <button onclick="window.app.switchTab('home')" class="nav-btn flex flex-col items-center p-2 rounded-2xl transition-all" data-tab="home"><i data-lucide="plus-circle" class="w-6 h-6"></i><span class="text-[10px] font-black mt-1 uppercase">è¨˜å¸³</span></button>
            <button onclick="window.app.switchTab('history')" class="nav-btn flex flex-col items-center p-2 rounded-2xl transition-all" data-tab="history"><i data-lucide="layout-list" class="w-6 h-6"></i><span class="text-[10px] font-black mt-1 uppercase">æ˜ç´°</span></button>
            <button onclick="window.app.switchTab('stats')" class="nav-btn flex flex-col items-center p-2 rounded-2xl transition-all" data-tab="stats"><i data-lucide="bar-chart-3" class="w-6 h-6"></i><span class="text-[10px] font-black mt-1 uppercase">åˆ†æ</span></button>
            <button onclick="window.app.switchTab('settings')" class="nav-btn flex flex-col items-center p-2 rounded-2xl transition-all" data-tab="settings"><i data-lucide="layers" class="w-6 h-6"></i><span class="text-[10px] font-black mt-1 uppercase">åˆ†é¡</span></button>
        </nav>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAC6VEkioGi-VC8MHXW3-nl4ngWwPRsMyw",
            authDomain: "money-c5f6e.firebaseapp.com",
            projectId: "money-c5f6e",
            storageBucket: "money-c5f6e.firebasestorage.app",
            messagingSenderId: "965877863338",
            appId: "1:965877863338:web:59c5078c04bc4c9458d1d3",
            measurementId: "G-P2HGWB7W62"
        };

        const fApp = initializeApp(firebaseConfig);
        const auth = getAuth(fApp);
        const db = getFirestore(fApp);
        const provider = new GoogleAuthProvider();
        const ALLOWED_USER = "jingsyuan@gmail.com";
        const appId = 'pocket-account-pro-v2';

        // ç”¨æ–¼æ‰‹å‹•éŠ·æ¯€ç›£è½
        let unsubTransactions = null;
        let unsubCategories = null;

        window.app = {
            state: {
                user: null, activeTab: 'home', transactions: [], categories: [],
                homeStep: 1, amount: '0', note: '', type: 'expense',
                selectedMainCat: null, statsType: 'expense', 
                isAdding: false, editingCatId: null // ç”¨æ–¼è¿½è¹¤ç·¨è¼¯ç‹€æ…‹
            },

            switchTab(tab) {
                this.state.activeTab = tab;
                this.state.isAdding = false;
                this.state.editingCatId = null;
                this.render();
            },

            handleCalc(val) {
                let s = this.state;
                if (val === 'C') s.amount = '0';
                else if (val === 'âŒ«') s.amount = s.amount.length > 1 ? s.amount.slice(0, -1) : '0';
                else if (val === '=') { try { s.amount = String(eval(s.amount.replace(/[^-()\d/*+.]/g, ''))); } catch(e) { s.amount = '0'; } }
                else s.amount = (s.amount === '0' && !isNaN(val)) ? val : s.amount + val;
                this.render();
            },

            selectCat(catJson) {
                this.state.selectedMainCat = catJson;
                this.render();
            },

            async saveRecord(sub) {
                const s = this.state;
                await addDoc(collection(db, 'artifacts', appId, 'users', s.user.uid, 'transactions'), {
                    amount: parseFloat(s.amount), note: s.note,
                    mainCatId: s.selectedMainCat.id, mainCatName: s.selectedMainCat.name,
                    subCat: sub, type: s.type, timestamp: Date.now(),
                    dateString: new Date().toLocaleDateString('zh-TW')
                });
                s.amount = '0'; s.note = ''; s.homeStep = 1; s.selectedMainCat = null;
                this.switchTab('history');
            },

            // --- ç·¨è¼¯åŠŸèƒ½å…¥å£ ---
            editCat(cat) {
                this.state.isAdding = true;
                this.state.editingCatId = cat.id;
                this.render();
                // å¡«å……æ•¸æ“š
                document.getElementById('new-cat-icon').value = cat.icon;
                document.getElementById('new-cat-name').value = cat.name;
                document.getElementById('new-cat-type').value = cat.type;
                document.getElementById('new-cat-subs').value = cat.subCategories.join(',');
            },

            async saveCategory() {
                const name = document.getElementById('new-cat-name').value;
                const icon = document.getElementById('new-cat-icon').value || 'ğŸ“';
                const subs = document.getElementById('new-cat-subs').value;
                const type = document.getElementById('new-cat-type').value;
                if (!name) return alert('è«‹è¼¸å…¥åç¨±');
                
                const id = this.state.editingCatId || ('cat_' + Date.now());
                await setDoc(doc(db, 'artifacts', appId, 'users', this.state.user.uid, 'categories', id), {
                    id, name, type, icon,
                    subCategories: subs.split(/[,ï¼Œ]/).map(s => s.trim()).filter(Boolean)
                });
                this.state.isAdding = false;
                this.state.editingCatId = null;
                this.render();
            },

            async deleteCat(id) {
                event.stopPropagation(); // é˜²æ­¢è§¸ç™¼ç·¨è¼¯æŒ‰éˆ•
                if (confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) {
                    await deleteDoc(doc(db, 'artifacts', appId, 'users', this.state.user.uid, 'categories', id));
                }
            },

            async deleteTx(id) {
                if (confirm('ç¢ºå®šåˆªé™¤æ­¤å¸³ç›®ï¼Ÿ')) {
                    await deleteDoc(doc(db, 'artifacts', appId, 'users', this.state.user.uid, 'transactions', id));
                }
            },

            render() {
                const main = document.getElementById('main-view');
                const s = this.state;
                document.querySelectorAll('.nav-btn').forEach(b => {
                    const active = b.dataset.tab === s.activeTab;
                    b.className = `nav-btn flex flex-col items-center p-2 rounded-2xl transition-all ${active ? 'bg-indigo-50 text-indigo-600' : 'text-slate-400'}`;
                });
                if (s.activeTab === 'home') this.renderHome(main);
                else if (s.activeTab === 'history') this.renderHistory(main);
                else if (s.activeTab === 'stats') this.renderStats(main);
                else if (s.activeTab === 'settings') this.renderSettings(main);
                lucide.createIcons();
            },

            renderHome(container) {
                const s = this.state;
                if (s.homeStep === 1) {
                    container.innerHTML = `
                        <div class="animate-slide p-6">
                            <div class="bg-white rounded-[2.5rem] p-6 shadow-sm border mb-4">
                                <div class="flex gap-2 mb-6 bg-slate-100 p-1 rounded-xl">
                                    <button onclick="window.app.state.type='expense'; window.app.render();" class="flex-1 py-2 rounded-lg font-bold text-xs ${s.type==='expense'?'bg-white text-rose-500 shadow-sm':'text-slate-400'}">æ”¯å‡º</button>
                                    <button onclick="window.app.state.type='income'; window.app.render();" class="flex-1 py-2 rounded-lg font-bold text-xs ${s.type==='income'?'bg-white text-emerald-500 shadow-sm':'text-slate-400'}">æ”¶å…¥</button>
                                </div>
                                <div class="num-font text-5xl font-bold text-right py-4 text-slate-800 tracking-tighter">$${s.amount}</div>
                                <input type="text" placeholder="ğŸ“ è¼¸å…¥å‚™è¨»..." oninput="window.app.state.note=this.value" value="${s.note}" class="w-full bg-slate-50 rounded-xl py-3 px-4 text-sm font-bold border-none outline-none focus:ring-2 focus:ring-indigo-500" />
                            </div>
                            <div class="grid grid-cols-4 gap-2">
                                ${['7','8','9','âŒ«','4','5','6','/','1','2','3','*','0','.','C','-'].map(b=>`<button onclick="window.app.handleCalc('${b}')" class="calc-btn h-14 bg-white rounded-xl font-bold text-lg text-slate-600 shadow-sm">${b}</button>`).join('')}
                                <button onclick="window.app.handleCalc('+')" class="calc-btn h-14 bg-indigo-50 text-indigo-600 rounded-xl font-bold text-xl">+</button>
                                <button onclick="window.app.handleCalc('=')" class="calc-btn h-14 bg-indigo-50 text-indigo-600 rounded-xl font-bold text-xl">=</button>
                                <button onclick="window.app.state.homeStep=2; window.app.render();" class="col-span-2 h-14 bg-indigo-600 text-white rounded-xl font-black shadow-lg active:scale-95 transition">ä¸‹ä¸€æ­¥</button>
                            </div>
                        </div>`;
                } else {
                    const filteredCats = s.categories.filter(c => c.type === s.type);
                    container.innerHTML = `
                        <div class="p-6 animate-slide">
                            <button onclick="window.app.state.homeStep=1; window.app.render();" class="flex items-center gap-2 text-indigo-600 font-bold mb-6"><i data-lucide="chevron-left" class="w-4 h-4"></i> è¿”å›é‡‘é¡</button>
                            <div class="grid grid-cols-3 gap-3 mb-6">
                                ${filteredCats.map(c => `<button onclick='window.app.selectCat(${JSON.stringify(c)})' class="p-4 rounded-3xl border-2 transition flex flex-col items-center gap-1 ${s.selectedMainCat?.id===c.id?'border-indigo-600 bg-indigo-50':'border-transparent bg-white shadow-sm'}"><span class="text-3xl">${c.icon}</span><span class="text-[10px] font-bold text-slate-500">${c.name}</span></button>`).join('')}
                            </div>
                            ${s.selectedMainCat ? `
                                <div class="bg-slate-900 p-6 rounded-[2.5rem] shadow-xl animate-slide"><div class="grid grid-cols-2 gap-2">${s.selectedMainCat.subCategories.map(sub=>`<button onclick="window.app.saveRecord('${sub}')" class="py-3 bg-white/10 text-white rounded-xl font-bold text-xs hover:bg-white hover:text-slate-900 transition">${sub}</button>`).join('')}</div></div>` : ''}
                        </div>`;
                }
            },

            renderHistory(container) {
                container.innerHTML = `<div class="p-6 animate-slide"><h2 class="text-xl font-black mb-4">å¸³ç›®æ˜ç´°</h2><div class="space-y-2">
                    ${this.state.transactions.map(t=>`
                        <div class="bg-white p-4 rounded-2xl flex justify-between items-center shadow-sm border border-slate-50">
                            <div><p class="font-black text-slate-800 text-sm">${t.subCat}</p><p class="text-[10px] text-slate-400 font-bold">${t.dateString} Â· ${t.mainCatName}</p></div>
                            <div class="flex items-center gap-4">
                                <div class="text-right"><p class="font-black ${t.type==='income'?'text-emerald-500':'text-rose-500'}">${t.type==='income'?'+':'-'}${t.amount.toLocaleString()}</p></div>
                                <button onclick="window.app.deleteTx('${t.id}')" class="text-slate-200 hover:text-rose-400 transition"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                            </div>
                        </div>`).join('')}
                </div></div>`;
            },

            renderStats(container) {
                const s = this.state;
                const filtered = s.transactions.filter(t => t.type === s.statsType);
                const total = filtered.reduce((acc, t) => acc + t.amount, 0);
                const groups = filtered.reduce((acc, t) => { acc[t.mainCatName] = (acc[t.mainCatName] || 0) + t.amount; return acc; }, {});
                const sorted = Object.entries(groups).sort((a,b) => b[1] - a[1]);
                container.innerHTML = `<div class="p-6 animate-slide">
                    <div class="flex gap-2 mb-6 bg-white p-1 rounded-xl shadow-sm">
                        <button onclick="window.app.state.statsType='expense'; window.app.render();" class="flex-1 py-2 rounded-lg font-bold text-xs ${s.statsType==='expense'?'bg-rose-500 text-white':'text-slate-400'}">æ”¯å‡ºåˆ†æ</button>
                        <button onclick="window.app.state.statsType='income'; window.app.render();" class="flex-1 py-2 rounded-lg font-bold text-xs ${s.statsType==='income'?'bg-emerald-500 text-white':'text-slate-400'}">æ”¶å…¥åˆ†æ</button>
                    </div>
                    <div class="bg-indigo-600 p-8 rounded-[2rem] text-white mb-8 shadow-xl text-center"><p class="text-4xl num-font font-black">$${total.toLocaleString()}</p></div>
                    <div class="space-y-4">${sorted.map(([n, v]) => `<div class="space-y-1"><div class="flex justify-between text-xs font-black text-slate-600"><span>${n}</span><span>$${v.toLocaleString()}</span></div><div class="w-full bg-slate-200 h-2 rounded-full"><div class="h-full rounded-full ${s.statsType==='income'?'bg-emerald-500':'bg-rose-500'}" style="width: ${(v/total*100)||0}%"></div></div></div>`).join('')}</div>
                </div>`;
            },

            renderSettings(container) {
                const s = this.state;
                container.innerHTML = `
                    <div class="p-6 animate-slide">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-xl font-black">é¡åˆ¥è¨­å®š</h2>
                            <button onclick="window.app.state.isAdding=true; window.app.state.editingCatId=null; window.app.render();" class="bg-indigo-600 text-white p-2 rounded-lg shadow-lg"><i data-lucide="plus" class="w-5 h-5"></i></button>
                        </div>
                        
                        ${s.isAdding ? `
                            <div class="bg-white p-5 rounded-2xl shadow-xl border-2 border-indigo-100 mb-6 space-y-3">
                                <h3 class="text-xs font-black text-indigo-500 uppercase tracking-widest">${s.editingCatId ? 'ç·¨è¼¯é¡åˆ¥' : 'æ–°å¢é¡åˆ¥'}</h3>
                                <div class="flex gap-2">
                                    <input id="new-cat-icon" placeholder="Emoji" class="w-16 bg-slate-50 p-3 rounded-lg text-center text-xl border-none" maxlength="2" />
                                    <input id="new-cat-name" placeholder="ä¸»é¡åˆ¥åç¨±" class="flex-1 bg-slate-50 p-3 rounded-lg text-sm font-bold border-none" />
                                </div>
                                <select id="new-cat-type" class="w-full bg-slate-50 p-3 rounded-lg text-sm font-bold border-none">
                                    <option value="expense">æ”¯å‡ºé …ç›®</option><option value="income">æ”¶å…¥é …ç›®</option>
                                </select>
                                <input id="new-cat-subs" placeholder="å­é¡åˆ¥ (é€—è™Ÿéš”é–‹)" class="w-full bg-slate-50 p-3 rounded-lg text-sm font-bold border-none" />
                                <div class="flex gap-2 pt-2">
                                    <button onclick="window.app.saveCategory()" class="flex-1 bg-indigo-600 text-white py-2 rounded-lg font-bold text-sm">å„²å­˜</button>
                                    <button onclick="window.app.state.isAdding=false; window.app.render();" class="flex-1 bg-slate-100 text-slate-500 py-2 rounded-lg font-bold text-sm">å–æ¶ˆ</button>
                                </div>
                            </div>
                        ` : ''}

                        <div class="space-y-3">
                            ${s.categories.map(c => `
                                <div onclick='window.app.editCat(${JSON.stringify(c).replace(/'/g, "&apos;")})' class="bg-white p-4 rounded-2xl flex items-center justify-between shadow-sm border border-slate-50 active:scale-[0.98] transition cursor-pointer">
                                    <div class="flex items-center gap-3">
                                        <span class="text-2xl">${c.icon}</span>
                                        <div>
                                            <p class="font-bold text-sm">${c.name} <span class="text-[8px] px-1 py-0.5 rounded ${c.type==='income'?'bg-emerald-100 text-emerald-600':'bg-rose-100 text-rose-600'}">${c.type==='income'?'æ”¶':'æ”¯'}</span></p>
                                            <p class="text-[9px] text-slate-400 font-bold uppercase tracking-tight">${c.subCategories.join(' Â· ')}</p>
                                        </div>
                                    </div>
                                    <button onclick="window.app.deleteCat('${c.id}')" class="text-slate-200 hover:text-rose-500 transition p-2"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                </div>
                            `).join('')}
                        </div>
                    </div>`;
            }
        };

        onAuthStateChanged(auth, async (user) => {
            if (user && user.email === ALLOWED_USER) {
                window.app.state.user = user;
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('app-content').classList.remove('hidden');
                document.getElementById('user-display').innerText = user.email;
                
                // å•Ÿå‹•ç›£è½ä¸¦ä¿å­˜éŠ·æ¯€å‡½æ•¸
                unsubTransactions = onSnapshot(collection(db, 'artifacts', appId, 'users', user.uid, 'transactions'), (snap) => {
                    window.app.state.transactions = snap.docs.map(d => ({ id: d.id, ...d.data() })).sort((a,b)=>b.timestamp-a.timestamp);
                    window.app.render();
                });
                unsubCategories = onSnapshot(collection(db, 'artifacts', appId, 'users', user.uid, 'categories'), (snap) => {
                    window.app.state.categories = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    window.app.render();
                });
            } else {
                // å¦‚æœç™»å‡ºæˆ–éæ³•ï¼Œå…ˆéŠ·æ¯€ç›£è½
                if(unsubTransactions) unsubTransactions();
                if(unsubCategories) unsubCategories();
                window.app.state.user = null;
                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('app-content').classList.add('hidden');
                if (user) { alert("æœªç¶“æˆæ¬Šçš„å¸³è™Ÿ"); await signOut(auth); }
            }
        });

        document.getElementById('google-login-btn').onclick = () => signInWithPopup(auth, provider);
        document.getElementById('logout-btn').onclick = async () => {
            if(unsubTransactions) unsubTransactions();
            if(unsubCategories) unsubCategories();
            await signOut(auth);
        };

    </script>
</body>
</html>
