<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å£è¢‹è¨˜å¸³ Pro - ç§äººç®¡ç†ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&family=JetBrains+Mono:wght@700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; -webkit-tap-highlight-color: transparent; }
        .num-font { font-family: 'JetBrains Mono', monospace; }
        .glass-effect { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
        .calc-btn { transition: all 0.1s ease; }
        .calc-btn:active { transform: scale(0.9); background-color: #f1f5f9; }
        .animate-up { animation: slideUp 0.3s cubic-bezier(0, 0, 0.2, 1); }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="bg-slate-100 text-slate-900">

    <div id="login-screen" class="fixed inset-0 bg-indigo-950 z-[200] flex flex-col items-center justify-center p-8 text-white">
        <div class="bg-white/10 p-8 rounded-[3rem] mb-6 shadow-2xl"><i data-lucide="shield-check" class="w-16 h-16 text-indigo-300"></i></div>
        <h1 class="text-3xl font-black mb-10 text-center">ç§äººè²¡å‹™ç³»çµ±</h1>
        <button id="google-login-btn" class="w-full max-w-xs bg-white text-indigo-900 font-black py-4 rounded-2xl flex items-center justify-center gap-3">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5" alt="google"> ç®¡ç†å“¡ç™»å…¥
        </button>
        <p id="auth-error-msg" class="mt-4 text-rose-400 text-xs hidden font-bold"></p>
    </div>

    <div id="app-content" class="max-w-md mx-auto h-screen flex flex-col hidden bg-slate-50 relative shadow-2xl overflow-hidden">
        <header class="glass-effect px-6 py-4 flex justify-between items-center border-b sticky top-0 z-50">
            <div>
                <h1 class="text-lg font-black text-slate-800 italic">POCKET PRO</h1>
                <p id="user-display" class="text-[10px] font-bold text-indigo-500 uppercase tracking-widest">Admin</p>
            </div>
            <button id="logout-btn" class="p-2.5 bg-slate-100 rounded-xl text-slate-500 hover:text-rose-500 transition"><i data-lucide="log-out" class="w-5 h-5"></i></button>
        </header>

        <main id="main-view" class="flex-1 overflow-y-auto pb-32 scrollbar-hide"></main>

        <nav class="glass-effect border-t flex justify-around p-3 pb-8 fixed bottom-0 left-0 right-0 max-w-md mx-auto z-40">
            <button onclick="window.switchTab('home')" class="nav-btn flex flex-col items-center p-2 rounded-2xl transition-all" data-tab="home"><i data-lucide="plus-circle" class="w-6 h-6"></i><span class="text-[10px] font-black mt-1 uppercase">è¨˜å¸³</span></button>
            <button onclick="window.switchTab('history')" class="nav-btn flex flex-col items-center p-2 rounded-2xl transition-all" data-tab="history"><i data-lucide="layout-list" class="w-6 h-6"></i><span class="text-[10px] font-black mt-1 uppercase">æ˜ç´°</span></button>
            <button onclick="window.switchTab('stats')" class="nav-btn flex flex-col items-center p-2 rounded-2xl transition-all" data-tab="stats"><i data-lucide="bar-chart-3" class="w-6 h-6"></i><span class="text-[10px] font-black mt-1 uppercase">åˆ†æ</span></button>
            <button onclick="window.switchTab('settings')" class="nav-btn flex flex-col items-center p-2 rounded-2xl transition-all" data-tab="settings"><i data-lucide="layers" class="w-6 h-6"></i><span class="text-[10px] font-black mt-1 uppercase">åˆ†é¡</span></button>
        </nav>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAC6VEkioGi-VC8MHXW3-nl4ngWwPRsMyw",
            authDomain: "money-c5f6e.firebaseapp.com",
            projectId: "money-c5f6e",
            storageBucket: "money-c5f6e.firebasestorage.app",
            messagingSenderId: "965877863338",
            appId: "1:965877863338:web:59c5078c04bc4c9458d1d3",
            measurementId: "G-P2HGWB7W62"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();
        const ALLOWED_USER = "jingsyuan@gmail.com";
        const appId = 'pocket-account-pro-v2';

        let state = {
            user: null, activeTab: 'home', transactions: [], categories: [],
            homeStep: 1, amount: '0', note: '', type: 'expense',
            selectedMainCat: null, statsType: 'expense',
            isAddingCat: false
        };

        // --- æ›è¼‰å…¨åŸŸå‡½æ•¸ ---
        window.switchTab = (tab) => { state.activeTab = tab; render(); };
        window.setType = (type) => { state.type = type; render(); };
        window.updateNote = (v) => { state.note = v; };
        window.goStep = (n) => { state.homeStep = n; render(); };
        window.setStatsType = (t) => { state.statsType = t; render(); };
        window.toggleAddCat = (v) => { state.isAddingCat = v; render(); };

        window.handleCalculator = (val) => {
            if (val === 'C') state.amount = '0';
            else if (val === 'âŒ«') state.amount = state.amount.length > 1 ? state.amount.slice(0, -1) : '0';
            else if (val === '=') { try { state.amount = String(eval(state.amount.replace(/[^-()\d/*+.]/g, ''))); } catch(e) { state.amount = '0'; } }
            else state.amount = (state.amount === '0' && !isNaN(val)) ? val : state.amount + val;
            render();
        };

        // --- Firebase ç›£è½ ---
        onAuthStateChanged(auth, async (user) => {
            if (user && user.email === ALLOWED_USER) {
                state.user = user;
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('app-content').classList.remove('hidden');
                document.getElementById('user-display').innerText = user.email;
                initData();
            } else if (user) {
                document.getElementById('auth-error-msg').innerText = "åƒ…é™ç®¡ç†å“¡å­˜å–";
                document.getElementById('auth-error-msg').classList.remove('hidden');
                await signOut(auth);
            }
        });

        function initData() {
            onSnapshot(collection(db, 'artifacts', appId, 'users', state.user.uid, 'transactions'), (s) => {
                state.transactions = s.docs.map(d => ({ id: d.id, ...d.data() })).sort((a,b) => b.timestamp - a.timestamp);
                render();
            });
            onSnapshot(collection(db, 'artifacts', appId, 'users', state.user.uid, 'categories'), (s) => {
                state.categories = s.docs.map(d => ({ id: d.id, ...d.data() }));
                render();
            });
        }

        // --- åˆ†é¡æ“ä½œ ---
        window.addCategory = async () => {
            const name = document.getElementById('new-cat-name').value;
            const subs = document.getElementById('new-cat-subs').value;
            const type = document.getElementById('new-cat-type').value;
            if (!name) return alert('è«‹è¼¸å…¥åç¨±');
            const id = 'cat_' + Date.now();
            await setDoc(doc(db, 'artifacts', appId, 'users', state.user.uid, 'categories', id), {
                id, name, type, icon: 'ğŸ“',
                subCategories: subs.split(/[,ï¼Œ]/).map(s => s.trim()).filter(Boolean)
            });
            state.isAddingCat = false;
            render();
        };

        window.deleteCat = async (id) => {
            if (confirm('ç¢ºå®šåˆªé™¤æ­¤é¡åˆ¥ï¼Ÿç›¸é—œå­é¡åˆ¥ä¹Ÿæœƒæ¶ˆå¤±ã€‚')) {
                await deleteDoc(doc(db, 'artifacts', appId, 'users', state.user.uid, 'categories', id));
            }
        };

        window.saveRecord = async (sub) => {
            await addDoc(collection(db, 'artifacts', appId, 'users', state.user.uid, 'transactions'), {
                amount: parseFloat(state.amount), note: state.note,
                mainCatId: state.selectedMainCat.id, mainCatName: state.selectedMainCat.name,
                subCat: sub, type: state.type, timestamp: Date.now(),
                dateString: new Date().toLocaleDateString('zh-TW')
            });
            state.amount = '0'; state.note = ''; state.homeStep = 1; state.activeTab = 'history';
            render();
        };

        // --- é é¢æ¸²æŸ“ ---
        function render() {
            const main = document.getElementById('main-view');
            document.querySelectorAll('.nav-btn').forEach(b => {
                const active = b.dataset.tab === state.activeTab;
                b.className = `nav-btn flex flex-col items-center p-2 rounded-2xl transition-all ${active ? 'bg-indigo-50 text-indigo-600 scale-105' : 'text-slate-400'}`;
            });

            if (state.activeTab === 'home') renderHome(main);
            else if (state.activeTab === 'history') renderHistory(main);
            else if (state.activeTab === 'stats') renderStats(main);
            else if (state.activeTab === 'settings') renderSettings(main);
            lucide.createIcons();
        }

        function renderHome(container) {
            if (state.homeStep === 1) {
                container.innerHTML = `
                    <div class="animate-up flex flex-col p-6">
                        <div class="bg-white rounded-[2.5rem] p-6 shadow-sm border mb-4">
                            <div class="flex gap-2 mb-6 bg-slate-100 p-1 rounded-xl">
                                <button onclick="window.setType('expense')" class="flex-1 py-2 rounded-lg font-bold text-xs ${state.type==='expense'?'bg-white text-rose-500 shadow-sm':'text-slate-400'}">æ”¯å‡º</button>
                                <button onclick="window.setType('income')" class="flex-1 py-2 rounded-lg font-bold text-xs ${state.type==='income'?'bg-white text-emerald-500 shadow-sm':'text-slate-400'}">æ”¶å…¥</button>
                            </div>
                            <div class="num-font text-5xl font-bold text-right py-4 text-slate-800">$${state.amount}</div>
                            <input type="text" placeholder="ğŸ“ å‚™è¨»..." oninput="window.updateNote(this.value)" value="${state.note}" class="w-full bg-slate-50 rounded-xl py-3 px-4 text-sm font-bold outline-none border-none focus:ring-2 focus:ring-indigo-500" />
                        </div>
                        <div class="grid grid-cols-4 gap-2">
                            ${['7','8','9','âŒ«','4','5','6','/','1','2','3','*','0','.','C','-'].map(b=>`<button onclick="window.handleCalculator('${b}')" class="calc-btn h-14 bg-white rounded-xl font-bold text-lg text-slate-600 shadow-sm border border-slate-100">${b}</button>`).join('')}
                            <button onclick="window.handleCalculator('+')" class="h-14 bg-indigo-50 text-indigo-600 rounded-xl font-bold text-xl">+</button>
                            <button onclick="window.handleCalculator('=')" class="h-14 bg-indigo-50 text-indigo-600 rounded-xl font-bold text-xl">=</button>
                            <button onclick="window.goStep(2)" class="col-span-2 h-14 bg-indigo-600 text-white rounded-xl font-black shadow-lg">ä¸‹ä¸€æ­¥ <i data-lucide="arrow-right" class="inline w-4 h-4"></i></button>
                        </div>
                    </div>
                `;
            } else {
                const cats = state.categories.filter(c => c.type === state.type);
                container.innerHTML = `
                    <div class="p-6 animate-up">
                        <button onclick="window.goStep(1)" class="flex items-center gap-2 text-indigo-600 font-bold mb-6"><i data-lucide="chevron-left" class="w-4 h-4"></i> è¿”å›</button>
                        <div class="grid grid-cols-3 gap-3 mb-6">
                            ${cats.map(c => `<button onclick="state.selectedMainCat=${JSON.stringify(c).replace(/"/g, '&quot;')}; render();" class="p-4 rounded-3xl border-2 transition flex flex-col items-center gap-1 ${state.selectedMainCat?.id===c.id?'border-indigo-600 bg-indigo-50':'border-transparent bg-white shadow-sm'}"><span class="text-2xl">${c.icon}</span><span class="text-[10px] font-bold text-slate-500">${c.name}</span></button>`).join('')}
                        </div>
                        ${state.selectedMainCat ? `<div class="bg-slate-900 p-6 rounded-[2.5rem] shadow-xl animate-up"><div class="grid grid-cols-2 gap-2">${state.selectedMainCat.subCategories.map(s=>`<button onclick="window.saveRecord('${s}')" class="py-3 bg-white/10 text-white rounded-xl font-bold text-xs hover:bg-white hover:text-slate-900 transition">${s}</button>`).join('')}<button onclick="window.saveRecord('å…¶ä»–')" class="py-3 bg-white/5 text-slate-500 rounded-xl font-bold text-xs">å…¶ä»–</button></div></div>`:''}
                    </div>
                `;
            }
        }

        function renderHistory(container) {
            container.innerHTML = `<div class="p-6 animate-up"><h2 class="text-xl font-black mb-4">å¸³ç›®æ˜ç´°</h2><div class="space-y-2">${state.transactions.map(t=>`<div class="bg-white p-4 rounded-2xl flex justify-between items-center shadow-sm border border-slate-50"><div><p class="font-black text-slate-800 text-sm">${t.subCat}</p><p class="text-[10px] text-slate-400 font-bold">${t.dateString} Â· ${t.mainCatName}</p></div><div class="text-right"><p class="font-black ${t.type==='income'?'text-emerald-500':'text-rose-500'}">${t.type==='income'?'+':'-'}${t.amount.toLocaleString()}</p><p class="text-[9px] text-slate-300 italic">${t.note || ''}</p></div></div>`).join('')}</div></div>`;
        }

        function renderStats(container) {
            const filtered = state.transactions.filter(t => t.type === state.statsType);
            const total = filtered.reduce((s, t) => s + t.amount, 0);
            const groups = filtered.reduce((acc, t) => { acc[t.mainCatName] = (acc[t.mainCatName] || 0) + t.amount; return acc; }, {});
            const sorted = Object.entries(groups).sort((a,b) => b[1] - a[1]);

            container.innerHTML = `
                <div class="p-6 animate-up">
                    <div class="flex gap-2 mb-6 bg-white p-1 rounded-xl shadow-sm">
                        <button onclick="window.setStatsType('expense')" class="flex-1 py-2 rounded-lg font-bold text-xs ${state.statsType==='expense'?'bg-rose-500 text-white':'text-slate-400'}">æ”¯å‡ºåˆ†æ</button>
                        <button onclick="window.setStatsType('income')" class="flex-1 py-2 rounded-lg font-bold text-xs ${state.statsType==='income'?'bg-emerald-500 text-white':'text-slate-400'}">æ”¶å…¥åˆ†æ</button>
                    </div>
                    <div class="bg-indigo-600 p-8 rounded-[2rem] text-white mb-8 shadow-lg shadow-indigo-100">
                        <p class="text-indigo-200 text-[10px] font-bold uppercase tracking-widest">Total Amount</p>
                        <p class="text-4xl num-font font-black">$${total.toLocaleString()}</p>
                    </div>
                    <div class="space-y-6">
                        ${sorted.map(([name, val]) => {
                            const pct = total > 0 ? Math.round((val/total)*100) : 0;
                            return `<div class="space-y-1">
                                <div class="flex justify-between text-xs font-black text-slate-600"><span>${name}</span><span>$${val.toLocaleString()} (${pct}%)</span></div>
                                <div class="w-full bg-slate-200 h-2 rounded-full overflow-hidden"><div class="h-full rounded-full ${state.statsType==='income'?'bg-emerald-500':'bg-rose-500'}" style="width: ${pct}%"></div></div>
                            </div>`;
                        }).join('')}
                        ${sorted.length === 0 ? '<p class="text-center text-slate-300 italic py-10">å°šç„¡åˆ†æè³‡æ–™</p>' : ''}
                    </div>
                </div>
            `;
        }

        function renderSettings(container) {
            container.innerHTML = `
                <div class="p-6 animate-up">
                    <div class="flex justify-between items-center mb-6"><h2 class="text-xl font-black">é¡åˆ¥ç®¡ç†</h2><button onclick="window.toggleAddCat(true)" class="bg-indigo-600 text-white p-2 rounded-lg shadow-lg"><i data-lucide="plus" class="w-5 h-5"></i></button></div>
                    
                    ${state.isAddingCat ? `
                        <div class="bg-white p-5 rounded-2xl shadow-xl border-2 border-indigo-100 mb-6 space-y-3">
                            <select id="new-cat-type" class="w-full bg-slate-50 p-3 rounded-lg text-sm font-bold border-none">
                                <option value="expense">æ”¯å‡ºé¡åˆ¥</option>
                                <option value="income">æ”¶å…¥é¡åˆ¥</option>
                            </select>
                            <input id="new-cat-name" placeholder="ä¸»é¡åˆ¥åç¨± (å¦‚: é£²é£Ÿ)" class="w-full bg-slate-50 p-3 rounded-lg text-sm font-bold border-none" />
                            <input id="new-cat-subs" placeholder="å­é¡åˆ¥ (ç”¨é€—è™Ÿéš”é–‹, å¦‚: æ—©é¤,åˆé¤)" class="w-full bg-slate-50 p-3 rounded-lg text-sm font-bold border-none" />
                            <div class="flex gap-2 pt-2">
                                <button onclick="window.addCategory()" class="flex-1 bg-indigo-600 text-white py-2 rounded-lg font-bold text-sm">ç¢ºèªæ–°å¢</button>
                                <button onclick="window.toggleAddCat(false)" class="flex-1 bg-slate-100 text-slate-500 py-2 rounded-lg font-bold text-sm">å–æ¶ˆ</button>
                            </div>
                        </div>
                    ` : ''}

                    <div class="space-y-3">
                        ${state.categories.sort((a,b)=>a.type.localeCompare(b.type)).map(c => `
                            <div class="bg-white p-4 rounded-2xl flex items-center justify-between shadow-sm">
                                <div class="flex items-center gap-3">
                                    <span class="text-2xl">${c.icon}</span>
                                    <div>
                                        <p class="font-bold text-sm text-slate-800">${c.name} <span class="text-[9px] px-1.5 py-0.5 rounded ${c.type==='income'?'bg-emerald-100 text-emerald-600':'bg-rose-100 text-rose-600'}">${c.type==='income'?'æ”¶':'æ”¯'}</span></p>
                                        <p class="text-[9px] text-slate-400 font-medium">${c.subCategories?.join(' Â· ') || 'ç„¡å­é¡åˆ¥'}</p>
                                    </div>
                                </div>
                                <button onclick="window.deleteCat('${c.id}')" class="text-slate-300 hover:text-rose-500 transition p-2"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        document.getElementById('google-login-btn').onclick = () => signInWithPopup(auth, provider);
        document.getElementById('logout-btn').onclick = () => signOut(auth);

    </script>
</body>
</html>
