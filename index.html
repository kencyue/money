<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>å£è¢‹è¨˜å¸³ Pro - å°ˆæ¥­ç®¡ç†ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&family=JetBrains+Mono:wght@700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; -webkit-tap-highlight-color: transparent; overflow: hidden; }
        .num-font { font-family: 'JetBrains Mono', monospace; }
        .glass-effect { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
        .calc-btn { transition: all 0.05s ease; border: 1px solid rgba(0,0,0,0.05); }
        .calc-btn:active { transform: scale(0.95); background-color: #f1f5f9; }
        .animate-slide { animation: slideUp 0.2s ease-out; }
        @keyframes slideUp { from { transform: translateY(10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        /* ç¢ºä¿å…¨è¢å¹•é«˜åº¦ */
        .app-height { height: 100vh; height: -webkit-fill-available; }
    </style>
</head>
<body class="bg-slate-100 text-slate-900">

    <div id="login-screen" class="fixed inset-0 bg-indigo-950 z-[200] flex flex-col items-center justify-center p-8 text-white">
        <div class="bg-white/10 p-8 rounded-[3rem] mb-6 shadow-2xl animate-bounce"><i data-lucide="shield-check" class="w-16 h-16 text-indigo-300"></i></div>
        <h1 class="text-3xl font-black mb-10 text-center">ç§äººè²¡å‹™ç³»çµ±<br><span class="text-indigo-400 text-lg uppercase tracking-widest font-bold">Authorized Only</span></h1>
        <button id="google-login-btn" class="w-full max-w-xs bg-white text-indigo-900 font-black py-4 rounded-2xl flex items-center justify-center gap-3 active:scale-95 transition">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5"> ç®¡ç†å“¡ç™»å…¥
        </button>
    </div>

    <div id="app-content" class="max-w-md mx-auto app-height flex flex-col hidden bg-slate-50 relative shadow-2xl overflow-hidden">
        <header class="glass-effect px-6 py-3 flex justify-between items-center border-b shrink-0">
            <div>
                <h1 class="text-base font-black text-slate-800 italic leading-none">POCKET PRO</h1>
                <p id="user-display" class="text-[9px] font-bold text-indigo-500 tracking-widest uppercase mt-0.5">Admin</p>
            </div>
            <button id="logout-btn" class="p-2 bg-slate-100 rounded-lg text-slate-500 hover:text-rose-500 transition"><i data-lucide="log-out" class="w-4 h-4"></i></button>
        </header>

        <main id="main-view" class="flex-1 overflow-y-auto bg-slate-50"></main>

        <nav class="glass-effect border-t flex justify-around p-1 pb-4 shrink-0">
            <button onclick="window.app.switchTab('home')" class="nav-btn flex flex-col items-center p-2 rounded-xl transition-all" data-tab="home"><i data-lucide="plus-circle" class="w-5 h-5"></i><span class="text-[9px] font-black mt-0.5">è¨˜å¸³</span></button>
            <button onclick="window.app.switchTab('history')" class="nav-btn flex flex-col items-center p-2 rounded-xl transition-all" data-tab="history"><i data-lucide="layout-list" class="w-5 h-5"></i><span class="text-[9px] font-black mt-0.5">æ˜ç´°</span></button>
            <button onclick="window.app.switchTab('stats')" class="nav-btn flex flex-col items-center p-2 rounded-xl transition-all" data-tab="stats"><i data-lucide="bar-chart-3" class="w-5 h-5"></i><span class="text-[9px] font-black mt-0.5">åˆ†æ</span></button>
            <button onclick="window.app.switchTab('settings')" class="nav-btn flex flex-col items-center p-2 rounded-xl transition-all" data-tab="settings"><i data-lucide="layers" class="w-5 h-5"></i><span class="text-[9px] font-black mt-0.5">åˆ†é¡</span></button>
        </nav>
    </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
    import { getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAC6VEkioGi-VC8MHXW3-nl4ngWwPRsMyw",
        authDomain: "money-c5f6e.firebaseapp.com",
        projectId: "money-c5f6e",
        storageBucket: "money-c5f6e.firebasestorage.app",
        messagingSenderId: "965877863338",
        appId: "1:965877863338:web:59c5078c04bc4c9458d1d3"
    };

    const fApp = initializeApp(firebaseConfig);
    const auth = getAuth(fApp);
    const db = getFirestore(fApp);
    const provider = new GoogleAuthProvider();
    const ALLOWED_USER = "jingsyuan@gmail.com";
    const appId = 'pocket-account-pro-v2';

    let unsubTx = null;
    let unsubCat = null;

    window.app = {
        state: {
            user: null, activeTab: 'home', transactions: [], categories: [],
            homeStep: 1, amount: '0', note: '', type: 'expense',
            selectedMainCat: null, statsType: 'expense', 
            isAdding: false, editingCatId: null
        },

        switchTab(tab) {
            this.state.activeTab = tab;
            this.state.isAdding = false;
            this.render();
        },

        render() {
            const main = document.getElementById('main-view');
            if(!main) return;
            const s = this.state;
            
            // æ›´æ–°å°è¦½åˆ—æ¨£å¼
            document.querySelectorAll('.nav-btn').forEach(b => {
                const active = b.dataset.tab === s.activeTab;
                b.className = `nav-btn flex flex-col items-center p-2 rounded-xl transition-all ${active ? 'bg-indigo-50 text-indigo-600' : 'text-slate-400'}`;
            });

            if (s.activeTab === 'home') this.renderHome(main);
            else if (s.activeTab === 'history') this.renderHistory(main);
            else if (s.activeTab === 'stats') this.renderStats(main);
            else if (s.activeTab === 'settings') this.renderSettings(main);
            lucide.createIcons();
        },

        // å±€éƒ¨æ›´æ–°è¨ˆç®—æ©Ÿï¼Œé˜²æ­¢é–ƒçˆ
        updateCalcDisplay() {
            const display = document.getElementById('calc-amount-display');
            if (display) display.innerText = `$${this.state.amount}`;
        },

        handleCalc(val) {
            let s = this.state;
            if (val === 'C') s.amount = '0';
            else if (val === 'âŒ«') s.amount = s.amount.length > 1 ? s.amount.slice(0, -1) : '0';
            else if (val === '=') { 
                try { s.amount = String(eval(s.amount.replace(/[^-()\d/*+.]/g, ''))); } 
                catch(e) { s.amount = '0'; } 
            }
            else s.amount = (s.amount === '0' && !isNaN(val)) ? val : s.amount + val;
            
            this.updateCalcDisplay();
        },

        async saveRecord(sub) {
            const s = this.state;
            const now = new Date();
            await addDoc(collection(db, 'artifacts', appId, 'users', s.user.uid, 'transactions'), {
                amount: parseFloat(s.amount), note: s.note,
                mainCatId: s.selectedMainCat.id, mainCatName: s.selectedMainCat.name,
                subCat: sub, type: s.type, timestamp: now.getTime(),
                dateString: now.toLocaleDateString('zh-TW'),
                timeString: now.toLocaleTimeString('zh-TW', { hour12: false, hour: '2-digit', minute: '2-digit' })
            });
            s.amount = '0'; s.note = ''; s.homeStep = 1; s.selectedMainCat = null;
            this.switchTab('history');
        },

        // çœŸæ­£çš„ XLSX åŒ¯å‡º
        exportToExcel() {
            const s = this.state;
            if (s.transactions.length === 0) return alert('æ²’æœ‰å¸³ç›®');
            
            const data = s.transactions.map(t => ({
                'æ—¥æœŸ': t.dateString,
                'æ™‚é–“': t.timeString || '',
                'é¡å‹': t.type === 'income' ? 'æ”¶å…¥' : 'æ”¯å‡º',
                'ä¸»é¡åˆ¥': t.mainCatName,
                'å­é¡åˆ¥': t.subCat,
                'é‡‘é¡': t.amount,
                'å‚™è¨»': t.note || ''
            }));

            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "å¸³ç›®æ˜ç´°");
            XLSX.writeFile(wb, `å£è¢‹è¨˜å¸³_${new Date().toISOString().slice(0,10)}.xlsx`);
        },

        // --- è¦–åœ–ç”Ÿæˆ ---
        renderHome(container) {
            const s = this.state;
            if (s.homeStep === 1) {
                container.innerHTML = `
                    <div class="animate-slide p-5">
                        <div class="bg-white rounded-[2rem] p-5 shadow-sm border mb-4">
                            <div class="flex gap-2 mb-4 bg-slate-100 p-1 rounded-xl">
                                <button onclick="window.app.state.type='expense'; window.app.render();" class="flex-1 py-1.5 rounded-lg font-bold text-[11px] ${s.type==='expense'?'bg-white text-rose-500 shadow-sm':'text-slate-400'}">æ”¯å‡º</button>
                                <button onclick="window.app.state.type='income'; window.app.render();" class="flex-1 py-1.5 rounded-lg font-bold text-[11px] ${s.type==='income'?'bg-white text-emerald-500 shadow-sm':'text-slate-400'}">æ”¶å…¥</button>
                            </div>
                            <div id="calc-amount-display" class="num-font text-4xl font-bold text-right py-3 text-slate-800 tracking-tighter">$${s.amount}</div>
                            <input type="text" placeholder="ğŸ“ è¼¸å…¥å‚™è¨»..." oninput="window.app.state.note=this.value" value="${s.note}" class="w-full bg-slate-50 rounded-xl py-2.5 px-4 text-xs font-bold border-none outline-none focus:ring-1 focus:ring-indigo-500" />
                        </div>
                        <div class="grid grid-cols-4 gap-2">
                            ${['7','8','9','âŒ«','4','5','6','/','1','2','3','*','0','.','C','-'].map(b=>`<button onclick="window.app.handleCalc('${b}')" class="calc-btn h-12 bg-white rounded-xl font-bold text-base text-slate-600 shadow-sm">${b}</button>`).join('')}
                            <button onclick="window.app.handleCalc('+')" class="calc-btn h-12 bg-indigo-50 text-indigo-600 rounded-xl font-bold text-lg">+</button>
                            <button onclick="window.app.handleCalc('=')" class="calc-btn h-12 bg-indigo-50 text-indigo-600 rounded-xl font-bold text-lg">=</button>
                            <button onclick="window.app.state.homeStep=2; window.app.render();" class="col-span-2 h-12 bg-indigo-600 text-white rounded-xl font-black shadow-lg active:scale-95 transition">ä¸‹ä¸€æ­¥</button>
                        </div>
                    </div>`;
            } else {
                const filteredCats = s.categories.filter(c => c.type === s.type);
                container.innerHTML = `
                    <div class="p-5 animate-slide">
                        <button onclick="window.app.state.homeStep=1; window.app.render();" class="flex items-center gap-1 text-indigo-600 font-bold mb-4 text-sm"><i data-lucide="chevron-left" class="w-4 h-4"></i> è¿”å›</button>
                        <div class="grid grid-cols-3 gap-3">
                            ${filteredCats.map(c => `
                                <button onclick="window.app.state.selectedMainCat={id:'${c.id}', name:'${c.name}', subCategories:${JSON.stringify(c.subCategories)}}; window.app.render();" class="p-4 rounded-2xl border-2 transition flex flex-col items-center gap-1 ${s.selectedMainCat?.id===c.id?'border-indigo-600 bg-indigo-50':'border-transparent bg-white shadow-sm'}">
                                    <span class="text-2xl">${c.icon}</span>
                                    <span class="text-[10px] font-bold text-slate-500">${c.name}</span>
                                </button>
                            `).join('')}
                        </div>
                        ${s.selectedMainCat ? `
                            <div class="mt-5 bg-slate-900 p-5 rounded-[2rem] animate-slide">
                                <div class="grid grid-cols-2 gap-2">
                                    ${s.selectedMainCat.subCategories.map(sub=>`<button onclick="window.app.saveRecord('${sub}')" class="py-2.5 bg-white/10 text-white rounded-xl font-bold text-[11px] hover:bg-white hover:text-slate-900 transition">${sub}</button>`).join('')}
                                </div>
                            </div>` : ''}
                    </div>`;
            }
        },

        renderHistory(container) {
            container.innerHTML = `<div class="p-5 animate-slide">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-black">å¸³ç›®æ˜ç´°</h2>
                    <button onclick="window.app.exportToExcel()" class="bg-emerald-600 text-white px-3 py-1.5 rounded-lg text-[10px] font-bold flex items-center gap-1 shadow-md">
                        <i data-lucide="file-spreadsheet" class="w-3.5 h-3.5"></i> åŒ¯å‡º XLSX
                    </button>
                </div>
                <div class="space-y-2">
                    ${this.state.transactions.map(t=>`
                        <div class="bg-white p-3 rounded-xl flex justify-between items-center shadow-sm border border-slate-100">
                            <div class="flex-1">
                                <div class="flex items-center gap-2">
                                    <span class="font-bold text-slate-800 text-xs">${t.subCat}</span>
                                    <span class="text-[8px] px-1.5 py-0.5 bg-slate-100 text-slate-400 rounded-md font-bold">${t.mainCatName}</span>
                                </div>
                                <p class="text-[9px] text-indigo-400 font-bold num-font mt-0.5">${t.dateString} ${t.timeString || ''}</p>
                            </div>
                            <div class="flex items-center gap-3 text-right">
                                <div>
                                    <p class="font-black text-sm ${t.type==='income'?'text-emerald-500':'text-rose-500'}">${t.type==='income'?'+':'-'}${t.amount.toLocaleString()}</p>
                                    <p class="text-[8px] text-slate-300 italic truncate max-w-[60px]">${t.note || ''}</p>
                                </div>
                                <button onclick="window.app.deleteTx('${t.id}')" class="text-slate-200 hover:text-rose-400"><i data-lucide="trash-2" class="w-3.5 h-3.5"></i></button>
                            </div>
                        </div>`).join('')}
                </div>
            </div>`;
        },

        renderStats(container) {
            const s = this.state;
            const filtered = s.transactions.filter(t => t.type === s.statsType);
            const total = filtered.reduce((acc, t) => acc + t.amount, 0);
            const groups = filtered.reduce((acc, t) => { acc[t.mainCatName] = (acc[t.mainCatName] || 0) + t.amount; return acc; }, {});
            const sorted = Object.entries(groups).sort((a,b) => b[1] - a[1]);
            container.innerHTML = `<div class="p-5 animate-slide">
                <div class="flex gap-2 mb-4 bg-white p-1 rounded-xl shadow-sm">
                    <button onclick="window.app.state.statsType='expense'; window.app.render();" class="flex-1 py-1.5 rounded-lg font-bold text-[11px] ${s.statsType==='expense'?'bg-rose-500 text-white shadow-md':'text-slate-400'}">æ”¯å‡º</button>
                    <button onclick="window.app.state.statsType='income'; window.app.render();" class="flex-1 py-1.5 rounded-lg font-bold text-[11px] ${s.statsType==='income'?'bg-emerald-500 text-white shadow-md':'text-slate-400'}">æ”¶å…¥</button>
                </div>
                <div class="bg-indigo-600 p-6 rounded-[2rem] text-white mb-6 shadow-lg text-center"><p class="text-3xl num-font font-black">$${total.toLocaleString()}</p></div>
                <div class="space-y-4">${sorted.map(([n, v]) => `<div class="space-y-1"><div class="flex justify-between text-[10px] font-black"><span>${n}</span><span>$${v.toLocaleString()}</span></div><div class="w-full bg-slate-200 h-2 rounded-full overflow-hidden"><div class="h-full rounded-full ${s.statsType==='income'?'bg-emerald-500':'bg-rose-500'}" style="width: ${(v/total*100)||0}%"></div></div></div>`).join('')}</div>
            </div>`;
        },

        renderSettings(container) {
            const s = this.state;
            container.innerHTML = `
                <div class="p-5 animate-slide">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-black">é¡åˆ¥è¨­å®š</h2>
                        <button onclick="window.app.state.isAdding=true; window.app.state.editingCatId=null; window.app.render();" class="bg-indigo-600 text-white p-2 rounded-lg"><i data-lucide="plus" class="w-4 h-4"></i></button>
                    </div>
                    ${s.isAdding ? `
                        <div class="bg-white p-4 rounded-2xl shadow-xl border border-indigo-50 mb-4 space-y-3 animate-slide">
                            <div class="flex gap-2">
                                <input id="new-cat-icon" placeholder="åœ–ç¤º" class="w-12 bg-slate-50 p-2 rounded-lg text-center text-lg" maxlength="2" />
                                <input id="new-cat-name" placeholder="ä¸»é¡åˆ¥åç¨±" class="flex-1 bg-slate-50 p-2 rounded-lg text-xs font-bold" />
                            </div>
                            <select id="new-cat-type" class="w-full bg-slate-50 p-2 rounded-lg text-xs font-bold"><option value="expense">æ”¯å‡ºé …ç›®</option><option value="income">æ”¶å…¥é …ç›®</option></select>
                            <input id="new-cat-subs" placeholder="å­é¡åˆ¥ (ç”¨é€—è™Ÿéš”é–‹)" class="w-full bg-slate-50 p-2 rounded-lg text-xs font-bold" />
                            <div class="flex gap-2"><button onclick="window.app.saveCategory()" class="flex-1 bg-indigo-600 text-white py-2 rounded-lg font-bold text-xs">å„²å­˜</button><button onclick="window.app.state.isAdding=false; window.app.render();" class="flex-1 bg-slate-100 text-slate-500 py-2 rounded-lg font-bold text-xs">å–æ¶ˆ</button></div>
                        </div>` : ''}
                    <div class="space-y-2">
                        ${s.categories.map(c => `
                            <div onclick="window.app.editCat('${c.id}')" class="bg-white p-3 rounded-xl flex justify-between items-center shadow-sm border border-slate-100">
                                <div class="flex items-center gap-3">
                                    <span class="text-xl">${c.icon}</span>
                                    <p class="font-bold text-xs">${c.name} <span class="text-[7px] px-1 py-0.5 rounded ${c.type==='income'?'bg-emerald-100 text-emerald-600':'bg-rose-100 text-rose-600'}">${c.type==='income'?'æ”¶':'æ”¯'}</span></p>
                                </div>
                                <button onclick="event.stopPropagation(); window.app.deleteCat('${c.id}')" class="text-slate-200 hover:text-rose-500 p-1"><i data-lucide="trash-2" class="w-3.5 h-3.5"></i></button>
                            </div>`).join('')}
                    </div>
                </div>`;
        },

        editCat(catId) {
            const cat = this.state.categories.find(c => c.id === catId);
            this.state.isAdding = true;
            this.state.editingCatId = cat.id;
            this.render();
            document.getElementById('new-cat-icon').value = cat.icon;
            document.getElementById('new-cat-name').value = cat.name;
            document.getElementById('new-cat-type').value = cat.type;
            document.getElementById('new-cat-subs').value = cat.subCategories.join(',');
        },

        async saveCategory() {
            const name = document.getElementById('new-cat-name').value;
            const icon = document.getElementById('new-cat-icon').value || 'ğŸ“';
            const subs = document.getElementById('new-cat-subs').value;
            const type = document.getElementById('new-cat-type').value;
            if (!name) return alert('è«‹è¼¸å…¥åç¨±');
            const id = this.state.editingCatId || ('cat_' + Date.now());
            await setDoc(doc(db, 'artifacts', appId, 'users', this.state.user.uid, 'categories', id), {
                id, name, type, icon,
                subCategories: subs.split(/[,ï¼Œ]/).map(s => s.trim()).filter(Boolean)
            });
            this.state.isAdding = false; this.state.editingCatId = null;
        },

        async deleteCat(id) { if (confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) await deleteDoc(doc(db, 'artifacts', appId, 'users', this.state.user.uid, 'categories', id)); },
        async deleteTx(id) { if (confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) await deleteDoc(doc(db, 'artifacts', appId, 'users', this.state.user.uid, 'transactions', id)); }
    };

    onAuthStateChanged(auth, async (user) => {
        if (user && user.email === ALLOWED_USER) {
            window.app.state.user = user;
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('app-content').classList.remove('hidden');
            document.getElementById('user-display').innerText = user.email;
            unsubTx = onSnapshot(collection(db, 'artifacts', appId, 'users', user.uid, 'transactions'), snap => { window.app.state.transactions = snap.docs.map(d => ({ id: d.id, ...d.data() })).sort((a,b)=>b.timestamp-a.timestamp); window.app.render(); });
            unsubCat = onSnapshot(collection(db, 'artifacts', appId, 'users', user.uid, 'categories'), snap => { window.app.state.categories = snap.docs.map(d => ({ id: d.id, ...d.data() })); window.app.render(); });
        } else {
            if(unsubTx) unsubTx(); if(unsubCat) unsubCat();
            window.app.state.user = null;
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('app-content').classList.add('hidden');
            if (user) { alert("ç„¡æ¬Šé™"); await signOut(auth); }
        }
    });

    document.getElementById('google-login-btn').onclick = () => signInWithPopup(auth, provider);
    document.getElementById('logout-btn').onclick = async () => { await signOut(auth); };
</script>
</body>
</html>
