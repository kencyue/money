<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å£è¢‹è¨˜å¸³ Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&family=JetBrains+Mono:wght@700&display=swap');
        
        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            -webkit-tap-highlight-color: transparent; 
            height: 100dvh; 
            width: 100vw;
            overflow: hidden; 
            background-color: #f8fafc;
        }
        .num-font { font-family: 'JetBrains Mono', monospace; }
        .glass-effect { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); }
        
        .app-container { 
            height: 100dvh; 
            display: flex; 
            flex-direction: column; 
            position: relative;
        }
        
        .content-area { 
            flex: 1; 
            overflow: hidden; 
            position: relative;
            display: flex;
            flex-direction: column;
        }
        
        .calc-btn { transition: transform 0.05s ease; border: 1px solid rgba(0,0,0,0.03); display: flex; align-items: center; justify-content: center; }
        .calc-btn:active { transform: scale(0.92); background-color: #e2e8f0; }
        .nav-active { color: #4f46e5; background-color: #f5f3ff; }
        .animate-up { animation: slideUp 0.2s ease-out; }
        @keyframes slideUp { from { transform: translateY(8px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        /* è‡ªå®šç¾©æ²è»¸æ¨£å¼ */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* æ—¥æœŸæ™‚é–“è¼¸å…¥æ¡†å„ªåŒ– */
        input[type="date"], input[type="time"] {
            font-family: 'JetBrains Mono', monospace;
            background-color: #f8fafc;
        }
    </style>
</head>
<body>

    <div id="login-screen" class="fixed inset-0 bg-slate-900 z-[200] flex flex-col items-center justify-center p-8">
        <div class="mb-8 p-6 bg-indigo-500/20 rounded-[2.5rem]"><i data-lucide="shield-check" class="w-16 h-16 text-indigo-400"></i></div>
        <h1 class="text-white text-2xl font-black tracking-tight mb-8 text-center">PRIVATE FINANCE</h1>
        <button id="google-login-btn" class="w-full max-w-xs bg-white text-slate-900 font-bold py-4 rounded-2xl flex items-center justify-center gap-3 active:scale-95 transition shadow-xl">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5"> ç®¡ç†å“¡ç™»å…¥
        </button>
    </div>

    <div id="app-content" class="hidden app-container max-w-md mx-auto bg-slate-50 relative">
        <header class="glass-effect shrink-0 px-6 pt-4 pb-3 border-b flex justify-between items-center z-50">
            <div>
                <h1 class="text-sm font-black text-slate-900 italic tracking-tighter">POCKET PRO</h1>
                <p id="user-display" class="text-[8px] font-bold text-indigo-500 uppercase tracking-widest mt-0.5">Admin</p>
            </div>
            <button id="logout-btn" class="p-2 bg-slate-100 rounded-lg text-slate-400"><i data-lucide="log-out" class="w-4 h-4"></i></button>
        </header>

        <main id="main-view" class="content-area"></main>

        <nav class="glass-effect fixed bottom-0 left-0 right-0 max-w-md mx-auto border-t flex justify-around p-1 pb-[calc(env(safe-area-inset-bottom)+4px)] z-50">
            <button onclick="window.app.switchTab('home')" class="nav-btn flex-1 flex flex-col items-center py-2 rounded-xl" data-tab="home"><i data-lucide="plus-circle" class="w-5 h-5"></i><span class="text-[9px] font-bold mt-1">è¨˜å¸³</span></button>
            <button onclick="window.app.switchTab('history')" class="nav-btn flex-1 flex flex-col items-center py-2 rounded-xl" data-tab="history"><i data-lucide="layout-list" class="w-5 h-5"></i><span class="text-[9px] font-bold mt-1">æ˜ç´°</span></button>
            <button onclick="window.app.switchTab('stats')" class="nav-btn flex-1 flex flex-col items-center py-2 rounded-xl" data-tab="stats"><i data-lucide="pie-chart" class="w-5 h-5"></i><span class="text-[9px] font-bold mt-1">åˆ†æ</span></button>
            <button onclick="window.app.switchTab('settings')" class="nav-btn flex-1 flex flex-col items-center py-2 rounded-xl" data-tab="settings"><i data-lucide="layers" class="w-5 h-5"></i><span class="text-[9px] font-bold mt-1">åˆ†é¡</span></button>
        </nav>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
    import { getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAC6VEkioGi-VC8MHXW3-nl4ngWwPRsMyw",
        authDomain: "money-c5f6e.firebaseapp.com",
        projectId: "money-c5f6e",
        storageBucket: "money-c5f6e.firebasestorage.app",
        messagingSenderId: "965877863338",
        appId: "1:965877863338:web:59c5078c04bc4c9458d1d3"
    };

    const fApp = initializeApp(firebaseConfig);
    const auth = getAuth(fApp);
    const db = getFirestore(fApp);
    const provider = new GoogleAuthProvider();
    const appId = 'pocket-account-pro-v2';

    let unsubTx = null, unsubCat = null;
    let chartInstance = null;

    // Helper: Format Date to YYYY-MM-DD
    const formatDateInput = (date) => {
        const d = new Date(date);
        return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
    };

    // Helper: Format Time to HH:MM
    const formatTimeInput = (date) => {
        const d = new Date(date);
        return String(d.getHours()).padStart(2, '0') + ':' + String(d.getMinutes()).padStart(2, '0');
    };

    window.app = {
        state: {
            user: null, 
            activeTab: 'home', 
            transactions: [], 
            categories: [],
            homeStep: 1, 
            amount: '0', 
            note: '', 
            type: 'expense',
            selectedMainCat: null, 
            statsType: 'expense', 
            viewDate: new Date(),
            editingTxId: null,
            editDate: formatDateInput(new Date()), // å„²å­˜ç·¨è¼¯/æ–°å¢æ™‚çš„æ—¥æœŸå­—ä¸² YYYY-MM-DD
            editTime: formatTimeInput(new Date()), // å„²å­˜ç·¨è¼¯/æ–°å¢æ™‚çš„æ™‚é–“å­—ä¸² HH:MM
            statsDetailCategory: null, // åˆ†æé é¢é‘½å–çš„é¡åˆ¥
            editingCatId: null, // ç”¨æ–¼åˆ†é¡è¨­å®šé é¢
            settingsType: 'expense'
        },

        init() {
            onAuthStateChanged(auth, (u) => {
                if (u) {
                    this.state.user = u;
                    document.getElementById('login-screen').classList.add('hidden');
                    document.getElementById('app-content').classList.remove('hidden');
                    document.getElementById('user-display').innerText = u.displayName || 'User';
                    this.loadData();
                } else {
                    document.getElementById('login-screen').classList.remove('hidden');
                    document.getElementById('app-content').classList.add('hidden');
                }
            });

            document.getElementById('google-login-btn').onclick = () => signInWithPopup(auth, provider);
            document.getElementById('logout-btn').onclick = () => signOut(auth).then(() => location.reload());
        },

        loadData() {
            const uid = this.state.user.uid;
            
            // Listen to Categories
            unsubCat = onSnapshot(collection(db, 'artifacts', appId, 'users', uid, 'categories'), (snap) => {
                this.state.categories = snap.docs.map(d => ({id: d.id, ...d.data()}));
                this.render();
            });

            // Listen to Transactions
            unsubTx = onSnapshot(collection(db, 'artifacts', appId, 'users', uid, 'transactions'), (snap) => {
                this.state.transactions = snap.docs.map(d => ({id: d.id, ...d.data()}))
                    .sort((a,b) => b.timestamp - a.timestamp);
                this.render();
            });
        },

        switchTab(tab) {
            this.state.activeTab = tab;
            this.state.statsDetailCategory = null; // åˆ‡æ› Tab æ™‚é‡ç½®åˆ†æé‘½å–
            
            // å¦‚æœä¸æ˜¯åœ¨ Homeï¼Œä¸”æ²’æœ‰æ­£åœ¨ç·¨è¼¯ Txï¼Œå‰‡é‡ç½®ç·¨è¼¯ç‹€æ…‹
            if (tab !== 'home' || !this.state.editingTxId) {
                 this.state.editingTxId = null;
                 if(tab === 'home') {
                     this.resetHomeInput();
                 }
            }
            this.render();
        },

        resetHomeInput() {
            const now = new Date();
            this.state.amount = '0';
            this.state.note = '';
            this.state.homeStep = 1;
            this.state.selectedMainCat = null;
            this.state.editDate = formatDateInput(now);
            this.state.editTime = formatTimeInput(now);
        },

        changeMonth(offset) {
            const d = this.state.viewDate;
            d.setMonth(d.getMonth() + offset);
            this.state.viewDate = new Date(d);
            this.render();
        },

        getFilteredTransactions() {
            const y = this.state.viewDate.getFullYear();
            const m = this.state.viewDate.getMonth();
            return this.state.transactions.filter(t => {
                const td = new Date(t.timestamp);
                return td.getFullYear() === y && td.getMonth() === m;
            });
        },

        render() {
            const main = document.getElementById('main-view');
            const s = this.state;
            
            document.querySelectorAll('.nav-btn').forEach(b => {
                const isActive = b.dataset.tab === s.activeTab;
                b.classList.toggle('nav-active', isActive);
                b.classList.toggle('text-slate-400', !isActive);
            });

            if (s.activeTab === 'home') this.renderHome(main);
            else if (s.activeTab === 'history') this.renderHistory(main);
            else if (s.activeTab === 'stats') this.renderStats(main);
            else if (s.activeTab === 'settings') this.renderSettings(main);
            lucide.createIcons();
        },

        handleCalc(val) {
            let s = this.state;
            if (val === 'C') s.amount = '0';
            else if (val === 'âŒ«') s.amount = s.amount.length > 1 ? s.amount.slice(0, -1) : '0';
            else if (val === '=') { try { s.amount = String(eval(s.amount.replace(/[^-()\d/*+.]/g, ''))); } catch(e) { s.amount = '0'; } }
            else s.amount = (s.amount === '0' && !isNaN(val)) ? val : s.amount + val;
            
            const display = document.getElementById('amount-text');
            if (display) display.innerText = `$${s.amount}`;
        },

        // è§¸ç™¼ç·¨è¼¯ï¼šæ¥æ”¶äº¤æ˜“IDï¼Œåˆ‡æ›åˆ° Home ä¸¦å¡«å……è³‡æ–™
        editTx(txId) {
            const s = this.state;
            const tx = s.transactions.find(t => t.id === txId);
            if (!tx) return;

            s.editingTxId = txId;
            s.amount = String(tx.amount);
            s.note = tx.note || '';
            s.type = tx.type;
            
            // è¨­å®šæ—¥æœŸæ™‚é–“
            const txDate = new Date(tx.timestamp);
            s.editDate = formatDateInput(txDate);
            s.editTime = formatTimeInput(txDate);

            const cat = s.categories.find(c => c.id === tx.mainCatId) || 
                        s.categories.find(c => c.name === tx.mainCatName && c.type === tx.type);
            
            s.selectedMainCat = cat || null;
            s.homeStep = 1;
            s.activeTab = 'home';
            this.render();
        },

        cancelEdit() {
            this.state.editingTxId = null;
            this.resetHomeInput();
            this.render();
        },

        async saveRecord(sub) {
            const s = this.state;
            const collectionRef = collection(db, 'artifacts', appId, 'users', s.user.uid, 'transactions');
            
            // çµ„åˆä½¿ç”¨è€…é¸æ“‡çš„æ—¥æœŸèˆ‡æ™‚é–“
            // å¦‚æœæ˜¯åœ¨ Home ç›´æ¥æŒ‰ï¼ŒæœƒæŠ“åˆ° state è£¡çš„é è¨­å€¼(now)æˆ–ä½¿ç”¨è€…æ”¹éçš„å€¼
            const dateStr = document.getElementById('input-date')?.value || s.editDate;
            const timeStr = document.getElementById('input-time')?.value || s.editTime;
            const finalDate = new Date(`${dateStr}T${timeStr}`);

            const data = {
                amount: parseFloat(s.amount), 
                note: s.note,
                mainCatId: s.selectedMainCat.id, 
                mainCatName: s.selectedMainCat.name,
                subCat: sub, 
                type: s.type,
                timestamp: finalDate.getTime(),
                dateString: finalDate.toLocaleDateString('zh-TW'),
                timeString: finalDate.toLocaleTimeString('zh-TW', { hour12: false, hour: '2-digit', minute: '2-digit' })
            };

            if (s.editingTxId) {
                const docRef = doc(db, 'artifacts', appId, 'users', s.user.uid, 'transactions', s.editingTxId);
                await updateDoc(docRef, data);
                // ç·¨è¼¯å®Œç•¢å¾Œï¼Œæ¸…ç©ºç·¨è¼¯ç‹€æ…‹ä¸¦å°å›æ˜ç´°
                s.editingTxId = null; 
            } else {
                await addDoc(collectionRef, data);
            }

            this.resetHomeInput();
            this.switchTab('history');
        },

        deleteTx(txId, e) {
            e.stopPropagation(); // é˜²æ­¢è§¸ç™¼ç·¨è¼¯
            if(confirm('ç¢ºå®šè¦åˆªé™¤æ­¤ç­†è³‡æ–™å—ï¼Ÿ')) {
                deleteDoc(doc(db, 'artifacts', appId, 'users', this.state.user.uid, 'transactions', txId));
                // å¦‚æœåœ¨åˆ†æé é¢çš„æ˜ç´°ä¸­åˆªé™¤ï¼Œå¯èƒ½éœ€è¦é‡æ–°æ¸²æŸ“
                this.render();
            }
        },

        exportToExcel() {
            const filtered = this.getFilteredTransactions();
            if (filtered.length === 0) return alert('æ­¤æœˆä»½ç„¡å¸³ç›®');
            const data = filtered.map(t => ({
                'æ—¥æœŸ': t.dateString, 'æ™‚é–“': t.timeString, 'é¡å‹': t.type === 'income' ? 'æ”¶å…¥' : 'æ”¯å‡º',
                'ä¸»é¡åˆ¥': t.mainCatName, 'å­é¡åˆ¥': t.subCat, 'é‡‘é¡': t.amount, 'å‚™è¨»': t.note || ''
            }));
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Records");
            const dateStr = this.state.viewDate.toISOString().slice(0,7);
            XLSX.writeFile(wb, `Account_${dateStr}.xlsx`);
        },

        // --- Render Functions ---

        renderHome(container) {
            const s = this.state;
            const cats = s.categories.filter(c=>c.type===s.type).sort((a,b)=>(a.order||0)-(b.order||0));
            const isEditing = !!s.editingTxId;

            // Step 1: é‡‘é¡è¼¸å…¥
            const inner = s.homeStep === 1 ? `
                <div class="bg-white rounded-[2rem] p-5 shadow-sm border ${isEditing ? 'border-amber-400 bg-amber-50' : 'border-slate-100'} mb-4 transition-colors">
                    <div class="flex justify-between items-center mb-2">
                        ${isEditing 
                            ? `<span class="text-[10px] font-black text-amber-600 bg-amber-100 px-2 py-1 rounded flex items-center gap-1"><i data-lucide="edit-3" class="w-3 h-3"></i> ç·¨è¼¯æ¨¡å¼</span>` 
                            : `<span class="text-[10px] font-black text-slate-400 bg-slate-100 px-2 py-1 rounded">æ–°å¢äº¤æ˜“</span>`}
                        ${isEditing ? `<button onclick="window.app.cancelEdit()" class="text-[10px] text-slate-500 underline">å–æ¶ˆ</button>` : ''}
                    </div>

                    <div class="flex gap-2 mb-3">
                        <input type="date" id="input-date" onchange="window.app.state.editDate=this.value" value="${s.editDate}" class="flex-1 bg-slate-100/50 border border-slate-200 text-slate-600 rounded-lg px-2 py-1.5 text-xs font-bold outline-none focus:border-indigo-500">
                        <input type="time" id="input-time" onchange="window.app.state.editTime=this.value" value="${s.editTime}" class="w-20 bg-slate-100/50 border border-slate-200 text-slate-600 rounded-lg px-2 py-1.5 text-xs font-bold outline-none focus:border-indigo-500">
                    </div>
                    
                    <div class="flex gap-2 mb-4 bg-slate-100/50 p-1 rounded-xl">
                        <button onclick="window.app.state.type='expense'; window.app.render();" class="flex-1 py-2 rounded-lg font-bold text-[10px] transition-all ${s.type==='expense'?'bg-white text-rose-500 shadow-sm':'text-slate-400'}">æ”¯å‡º</button>
                        <button onclick="window.app.state.type='income'; window.app.render();" class="flex-1 py-2 rounded-lg font-bold text-[10px] transition-all ${s.type==='income'?'bg-white text-emerald-500 shadow-sm':'text-slate-400'}">æ”¶å…¥</button>
                    </div>
                    <div id="amount-text" class="num-font text-5xl font-bold text-right py-2 text-slate-800 tracking-tighter">$${s.amount}</div>
                    <input type="text" placeholder="ğŸ“ å‚™è¨»..." oninput="window.app.state.note=this.value" value="${s.note}" class="w-full bg-slate-100/50 focus:bg-white transition-colors rounded-xl py-3 px-4 text-xs font-bold border border-transparent focus:border-indigo-200 outline-none" />
                </div>
                <div class="grid grid-cols-4 gap-2">
                    ${['7','8','9','âŒ«','4','5','6','/','1','2','3','*','0','.','C','-'].map(b=>`<button onclick="window.app.handleCalc('${b}')" class="calc-btn h-14 bg-white rounded-xl font-bold text-lg text-slate-600 shadow-sm">${b}</button>`).join('')}
                    <button onclick="window.app.handleCalc('+')" class="calc-btn h-14 bg-indigo-50 text-indigo-600 rounded-xl font-bold text-xl">+</button>
                    <button onclick="window.app.handleCalc('=')" class="calc-btn h-14 bg-indigo-50 text-indigo-600 rounded-xl font-bold text-xl">=</button>
                    <button onclick="window.app.state.homeStep=2; window.app.render();" class="col-span-2 h-14 bg-indigo-600 text-white rounded-xl font-black shadow-lg active:scale-95 transition-transform">${isEditing ? 'ä¸‹ä¸€æ­¥ (ä¿®æ”¹é¡åˆ¥)' : 'ä¸‹ä¸€æ­¥'}</button>
                </div>
            ` : `
            <button onclick="window.app.state.homeStep=1; window.app.render();" class="flex items-center gap-1 text-indigo-600 font-bold mb-5 text-sm"><i data-lucide="chevron-left" class="w-4 h-4"></i> è¿”å›é‡‘é¡</button>
                ${isEditing ? '<div class="mb-4 text-center"><span class="text-[10px] font-black text-amber-600 bg-amber-100 px-3 py-1 rounded-full">è«‹é¸æ“‡é¡åˆ¥ä»¥å®Œæˆä¿®æ”¹</span></div>' : ''}
                <div class="grid grid-cols-3 gap-3 mb-6">
                    ${cats.map(c=>`
                        <button onclick="window.app.state.selectedMainCat=${JSON.stringify(c).replace(/"/g, '&quot;')}; window.app.render();" class="p-4 rounded-3xl border-2 transition flex flex-col items-center gap-1 ${s.selectedMainCat?.id===c.id?'border-indigo-600 bg-indigo-50':'border-transparent bg-white shadow-sm'}">
                            <span class="text-3xl">${c.icon}</span>
                            <span class="text-[10px] font-bold text-slate-500">${c.name}</span>
                        </button>`).join('')}
                </div>
                ${s.selectedMainCat ? `<div class="bg-slate-900 p-5 rounded-[2.5rem] animate-up grid grid-cols-2 gap-2 shadow-xl shadow-slate-300">
                    <div class="col-span-2 text-center text-slate-400 text-[10px] font-bold mb-2">é¸æ“‡å­é¡åˆ¥ä»¥å„²å­˜</div>
                    ${s.selectedMainCat.subCategories.map(sub=>`<button onclick="window.app.saveRecord('${sub}')" class="py-3 bg-white/10 hover:bg-white/20 active:scale-95 transition text-white rounded-xl font-bold text-[11px]">${sub}</button>`).join('')}
                </div>` : ''}
            `;

            container.innerHTML = `<div class="flex-1 overflow-y-auto p-5 animate-up pb-24">${inner}</div>`;
        },

        renderHistory(container) {
            const filtered = this.getFilteredTransactions();
            const totalExp = filtered.filter(t=>t.type==='expense').reduce((a,b)=>a+b.amount,0);
            const totalInc = filtered.filter(t=>t.type==='income').reduce((a,b)=>a+b.amount,0);

            const dateStr = this.state.viewDate.toLocaleDateString('zh-TW', { year: 'numeric', month: 'long' });

            container.innerHTML = `
            <div class="flex flex-col h-full animate-up">
                <div class="p-5 pb-2 shrink-0 z-10 bg-[#f8fafc]">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-black text-slate-800">å¸³ç›®æ˜ç´°</h2>
                        <button onclick="window.app.exportToExcel()" class="bg-emerald-600 text-white px-3 py-1.5 rounded-lg text-[10px] font-black flex items-center gap-1 shadow-md active:scale-95 transition"><i data-lucide="file-spreadsheet" class="w-3.5 h-3.5"></i>åŒ¯å‡º</button>
                    </div>
                    
                    <div class="flex items-center justify-between bg-white p-2 rounded-xl shadow-sm mb-4 border border-slate-100">
                        <button onclick="window.app.changeMonth(-1)" class="p-2 text-slate-400 hover:text-indigo-600"><i data-lucide="chevron-left" class="w-5 h-5"></i></button>
                        <span class="font-black text-slate-700 text-sm tracking-widest">${dateStr}</span>
                        <button onclick="window.app.changeMonth(1)" class="p-2 text-slate-400 hover:text-indigo-600"><i data-lucide="chevron-right" class="w-5 h-5"></i></button>
                    </div>

                    <div class="flex gap-2 mb-2">
                        <div class="flex-1 bg-rose-50 p-3 rounded-xl border border-rose-100">
                            <p class="text-[9px] text-rose-400 font-bold mb-1">ç¸½æ”¯å‡º</p>
                            <p class="text-lg font-black text-rose-600 num-font">$${totalExp.toLocaleString()}</p>
                        </div>
                        <div class="flex-1 bg-emerald-50 p-3 rounded-xl border border-emerald-100">
                            <p class="text-[9px] text-emerald-400 font-bold mb-1">ç¸½æ”¶å…¥</p>
                            <p class="text-lg font-black text-emerald-600 num-font">$${totalInc.toLocaleString()}</p>
                        </div>
                    </div>
                </div>

                <div class="flex-1 overflow-y-auto p-5 pt-2 pb-24 no-scrollbar">
                    <div class="space-y-2">
                        ${filtered.length === 0 ? `<div class="text-center py-10 text-slate-300 text-xs font-bold">æœ¬æœˆç„¡è³‡æ–™</div>` : 
                        filtered.map(t=>`
                            <div onclick="window.app.editTx('${t.id}')" class="bg-white p-4 rounded-2xl flex justify-between items-center shadow-sm border border-slate-100 active:scale-[0.98] transition cursor-pointer group">
                                <div>
                                    <div class="flex items-center gap-2">
                                        <span class="font-bold text-slate-800 text-sm group-hover:text-indigo-600 transition-colors">${t.subCat}</span>
                                        <span class="text-[8px] px-1.5 py-0.5 bg-slate-100 text-slate-400 rounded font-bold">${t.mainCatName}</span>
                                    </div>
                                    <div class="flex gap-2 items-center mt-1">
                                         <p class="text-[9px] text-indigo-400 font-bold num-font bg-indigo-50 px-1 rounded">${t.dateString} ${t.timeString}</p>
                                         ${t.note ? `<p class="text-[9px] text-slate-400 truncate max-w-[100px]">${t.note}</p>` : ''}
                                    </div>
                                </div>
                                <div class="flex items-center gap-3">
                                    <p class="font-black text-base num-font ${t.type==='income'?'text-emerald-500':'text-rose-500'}">${t.type==='income'?'+':'-'}${t.amount.toLocaleString()}</p>
                                    <button onclick="window.app.deleteTx('${t.id}', event)" class="p-1.5 text-slate-200 hover:text-rose-500 hover:bg-rose-50 rounded-full transition"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>`;
        },

        renderStats(container) {
            const s = this.state;
            const filtered = this.getFilteredTransactions().filter(t => t.type === s.statsType);
            
            // å¦‚æœæœ‰é¸ä¸­æŸå€‹åˆ†é¡ï¼Œé¡¯ç¤ºè©²åˆ†é¡çš„æ˜ç´° (Drill-down View)
            if (s.statsDetailCategory) {
                this.renderStatsDetail(container, filtered, s.statsDetailCategory);
                return;
            }

            // ä¸€èˆ¬åˆ†æç¸½è¦½ (Overview)
            const total = filtered.reduce((a, b) => a + b.amount, 0);
            const dataMap = {};
            filtered.forEach(t => { dataMap[t.mainCatName] = (dataMap[t.mainCatName] || 0) + t.amount; });
            const labels = Object.keys(dataMap);
            const data = Object.values(dataMap);
            const colors = ['#f43f5e', '#ec4899', '#d946ef', '#a855f7', '#8b5cf6', '#6366f1', '#3b82f6', '#0ea5e9', '#06b6d4', '#14b8a6'];

            container.innerHTML = `
                <div class="flex flex-col h-full animate-up">
                    <div class="p-5 pb-0 shrink-0">
                        <h2 class="text-lg font-black text-slate-800 mb-4">æ”¶æ”¯åˆ†æ</h2>
                        
                        <div class="flex items-center justify-between bg-white p-2 rounded-xl shadow-sm mb-4 border border-slate-100">
                            <button onclick="window.app.changeMonth(-1)" class="p-2 text-slate-400"><i data-lucide="chevron-left" class="w-5 h-5"></i></button>
                            <span class="font-black text-slate-700 text-sm tracking-widest">${s.viewDate.toLocaleDateString('zh-TW', { year: 'numeric', month: 'long' })}</span>
                            <button onclick="window.app.changeMonth(1)" class="p-2 text-slate-400"><i data-lucide="chevron-right" class="w-5 h-5"></i></button>
                        </div>

                        <div class="flex bg-slate-200 p-1 rounded-xl mb-4">
                            <button onclick="window.app.state.statsType='expense'; window.app.render();" class="flex-1 py-1.5 rounded-lg text-xs font-bold ${s.statsType==='expense'?'bg-white shadow text-rose-500':'text-slate-500'}">æ”¯å‡º</button>
                            <button onclick="window.app.state.statsType='income'; window.app.render();" class="flex-1 py-1.5 rounded-lg text-xs font-bold ${s.statsType==='income'?'bg-white shadow text-emerald-500':'text-slate-500'}">æ”¶å…¥</button>
                        </div>
                    </div>

                    <div class="flex-1 overflow-y-auto p-5 pt-0 pb-24 no-scrollbar">
                         ${total === 0 ? `<div class="text-center py-10 text-slate-300 text-xs font-bold">ç„¡æ•¸æ“š</div>` : `
                            <div class="bg-white p-4 rounded-[2rem] shadow-sm border border-slate-100 mb-4 h-64 relative">
                                <canvas id="chartCanvas"></canvas>
                            </div>
                            <div class="space-y-2">
                                ${labels.map((l, i) => {
                                    const pct = Math.round((data[i] / total) * 100);
                                    return `
                                    <div onclick="window.app.state.statsDetailCategory='${l}'; window.app.render();" class="flex items-center justify-between p-3 bg-white rounded-xl border border-slate-100 active:scale-[0.98] transition cursor-pointer">
                                        <div class="flex items-center gap-2">
                                            <div class="w-3 h-3 rounded-full" style="background:${colors[i%colors.length]}"></div>
                                            <span class="text-xs font-bold text-slate-700">${l}</span>
                                        </div>
                                        <div class="flex items-center gap-3">
                                            <span class="text-xs font-bold text-slate-400">${pct}%</span>
                                            <span class="num-font font-bold text-sm text-slate-800">$${data[i].toLocaleString()}</span>
                                            <i data-lucide="chevron-right" class="w-3 h-3 text-slate-300"></i>
                                        </div>
                                    </div>`;
                                }).join('')}
                            </div>
                        `}
                    </div>
                </div>`;

            if (total > 0) {
                setTimeout(() => {
                    const ctx = document.getElementById('chartCanvas').getContext('2d');
                    if (chartInstance) chartInstance.destroy();
                    chartInstance = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: labels,
                            datasets: [{
                                data: data,
                                backgroundColor: colors,
                                borderWidth: 0
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            onClick: (evt, elements) => {
                                if (elements.length > 0) {
                                    const index = elements[0].index;
                                    const label = labels[index];
                                    window.app.state.statsDetailCategory = label;
                                    window.app.render();
                                }
                            }
                        }
                    });
                }, 0);
            }
        },

        // åˆ†æé é¢çš„é‘½å–è©³ç´°åˆ—è¡¨ (Drill-down)
        renderStatsDetail(container, allTransactions, categoryName) {
            const txs = allTransactions.filter(t => t.mainCatName === categoryName).sort((a,b) => b.timestamp - a.timestamp);
            const total = txs.reduce((a,b) => a + b.amount, 0);

            container.innerHTML = `
            <div class="flex flex-col h-full animate-up">
                <div class="p-5 pb-2 shrink-0 bg-[#f8fafc]">
                    <div class="flex items-center gap-2 mb-4">
                        <button onclick="window.app.state.statsDetailCategory=null; window.app.render();" class="p-2 bg-white border border-slate-200 rounded-full text-slate-500 hover:text-indigo-600 active:scale-90 transition"><i data-lucide="arrow-left" class="w-5 h-5"></i></button>
                        <div>
                            <p class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">Category Analysis</p>
                            <h2 class="text-lg font-black text-slate-800">${categoryName}</h2>
                        </div>
                    </div>
                    <div class="bg-indigo-600 text-white p-4 rounded-2xl shadow-lg shadow-indigo-200 mb-2">
                        <p class="text-[10px] text-indigo-200 font-bold mb-1">æ­¤é¡åˆ¥ç¸½è¨ˆ</p>
                        <p class="text-2xl font-black num-font">$${total.toLocaleString()}</p>
                    </div>
                </div>

                <div class="flex-1 overflow-y-auto p-5 pt-2 pb-24 no-scrollbar">
                    <div class="space-y-2">
                        ${txs.map(t => `
                            <div onclick="window.app.editTx('${t.id}')" class="bg-white p-4 rounded-2xl flex justify-between items-center shadow-sm border border-slate-100 active:scale-[0.98] transition cursor-pointer group">
                                <div>
                                    <div class="flex items-center gap-2">
                                        <span class="font-bold text-slate-800 text-sm group-hover:text-indigo-600 transition-colors">${t.subCat}</span>
                                    </div>
                                    <div class="flex gap-2 items-center mt-1">
                                         <p class="text-[9px] text-indigo-400 font-bold num-font bg-indigo-50 px-1 rounded">${t.dateString} ${t.timeString}</p>
                                         ${t.note ? `<p class="text-[9px] text-slate-400 truncate max-w-[100px]">${t.note}</p>` : ''}
                                    </div>
                                </div>
                                <div class="flex items-center gap-3">
                                    <p class="font-black text-base num-font ${t.type==='income'?'text-emerald-500':'text-rose-500'}">$${t.amount.toLocaleString()}</p>
                                    <i data-lucide="edit-3" class="w-3.5 h-3.5 text-slate-200 group-hover:text-indigo-300"></i>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>`;
        },

        renderSettings(container) {
            const s = this.state;
            const cats = s.categories.filter(c=>c.type===s.settingsType).sort((a,b)=>(a.order||0)-(b.order||0));

            container.innerHTML = `
            <div class="flex flex-col h-full animate-up p-5 pb-24">
                <h2 class="text-lg font-black text-slate-800 mb-4">åˆ†é¡ç®¡ç†</h2>
                 <div class="flex bg-slate-200 p-1 rounded-xl mb-4">
                    <button onclick="window.app.state.settingsType='expense'; window.app.render();" class="flex-1 py-1.5 rounded-lg text-xs font-bold ${s.settingsType==='expense'?'bg-white shadow text-rose-500':'text-slate-500'}">æ”¯å‡º</button>
                    <button onclick="window.app.state.settingsType='income'; window.app.render();" class="flex-1 py-1.5 rounded-lg text-xs font-bold ${s.settingsType==='income'?'bg-white shadow text-emerald-500':'text-slate-500'}">æ”¶å…¥</button>
                </div>
                <div class="flex-1 overflow-y-auto no-scrollbar space-y-3">
                    <div class="text-center py-10 text-slate-400 text-xs">åˆ†é¡ç®¡ç†åŠŸèƒ½é–‹ç™¼ä¸­...</div>
                </div>
            </div>`;
        }
    };

    window.app.init();
</script>
</body>
</html>
