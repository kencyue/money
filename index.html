<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å£è¢‹è¨˜å¸³ Pro (å®Œæ•´ç·¨è¼¯ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&family=JetBrains+Mono:wght@700&display=swap');
        
        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            -webkit-tap-highlight-color: transparent; 
            height: 100dvh; 
            width: 100vw;
            overflow: hidden; 
            background-color: #f8fafc;
        }
        .num-font { font-family: 'JetBrains Mono', monospace; }
        .glass-effect { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); }
        
        .app-container { height: 100dvh; display: flex; flex-direction: column; position: relative; }
        .content-area { flex: 1; overflow: hidden; position: relative; display: flex; flex-direction: column; }
        
        .calc-btn { transition: transform 0.05s ease; border: 1px solid rgba(0,0,0,0.03); display: flex; align-items: center; justify-content: center; }
        .calc-btn:active { transform: scale(0.92); background-color: #e2e8f0; }
        .nav-active { color: #4f46e5; background-color: #f5f3ff; }
        .animate-up { animation: slideUp 0.2s ease-out; }
        @keyframes slideUp { from { transform: translateY(8px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        /* éš±è—æ²è»¸ */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        input[type="date"], input[type="time"] {
            appearance: none; -webkit-appearance: none;
            background: transparent; font-family: 'JetBrains Mono', monospace;
        }
    </style>
</head>
<body>

    <div id="login-screen" class="fixed inset-0 bg-slate-900 z-[200] flex flex-col items-center justify-center p-8">
        <div class="mb-8 p-6 bg-indigo-500/20 rounded-[2.5rem]"><i data-lucide="shield-check" class="w-16 h-16 text-indigo-400"></i></div>
        <h1 class="text-white text-2xl font-black tracking-tight mb-8 text-center">PRIVATE FINANCE</h1>
        <button id="google-login-btn" class="w-full max-w-xs bg-white text-slate-900 font-bold py-4 rounded-2xl flex items-center justify-center gap-3 active:scale-95 transition shadow-xl">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5"> ç®¡ç†å“¡ç™»å…¥
        </button>
    </div>

    <div id="app-content" class="hidden app-container max-w-md mx-auto bg-slate-50 relative">
        <header class="glass-effect shrink-0 px-6 pt-4 pb-3 border-b flex justify-between items-center z-50">
            <div>
                <h1 class="text-sm font-black text-slate-900 italic tracking-tighter">POCKET PRO</h1>
                <p id="user-display" class="text-[8px] font-bold text-indigo-500 uppercase tracking-widest mt-0.5">Admin</p>
            </div>
            <button id="logout-btn" class="p-2 bg-slate-100 rounded-lg text-slate-400"><i data-lucide="log-out" class="w-4 h-4"></i></button>
        </header>

        <main id="main-view" class="content-area"></main>

        <nav class="glass-effect fixed bottom-0 left-0 right-0 max-w-md mx-auto border-t flex justify-around p-1 pb-[calc(env(safe-area-inset-bottom)+4px)] z-50">
            <button onclick="window.app.switchTab('home')" class="nav-btn flex-1 flex flex-col items-center py-2 rounded-xl" data-tab="home"><i data-lucide="plus-circle" class="w-5 h-5"></i><span class="text-[9px] font-bold mt-1">è¨˜å¸³</span></button>
            <button onclick="window.app.switchTab('history')" class="nav-btn flex-1 flex flex-col items-center py-2 rounded-xl" data-tab="history"><i data-lucide="layout-list" class="w-5 h-5"></i><span class="text-[9px] font-bold mt-1">æ˜ç´°</span></button>
            <button onclick="window.app.switchTab('stats')" class="nav-btn flex-1 flex flex-col items-center py-2 rounded-xl" data-tab="stats"><i data-lucide="pie-chart" class="w-5 h-5"></i><span class="text-[9px] font-bold mt-1">åˆ†æ</span></button>
            <button onclick="window.app.switchTab('settings')" class="nav-btn flex-1 flex flex-col items-center py-2 rounded-xl" data-tab="settings"><i data-lucide="layers" class="w-5 h-5"></i><span class="text-[9px] font-bold mt-1">åˆ†é¡</span></button>
        </nav>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
    import { getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, onSnapshot, setDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAC6VEkioGi-VC8MHXW3-nl4ngWwPRsMyw",
        authDomain: "money-c5f6e.firebaseapp.com",
        projectId: "money-c5f6e",
        storageBucket: "money-c5f6e.firebasestorage.app",
        messagingSenderId: "965877863338",
        appId: "1:965877863338:web:59c5078c04bc4c9458d1d3"
    };

    const fApp = initializeApp(firebaseConfig);
    const auth = getAuth(fApp);
    const db = getFirestore(fApp);
    const provider = new GoogleAuthProvider();
    const appId = 'pocket-account-pro-v2';

    let unsubTx = null, unsubCat = null, chartInstance = null;

    window.app = {
        state: {
            user: null, activeTab: 'home', transactions: [], categories: [],
            homeStep: 1, amount: '0', note: '', type: 'expense',
            selectedMainCat: null, statsType: 'expense', 
            viewDate: new Date(),
            settingsType: 'expense',
            statsDetailCategory: null, // ç”¨ä¾†å­˜å„²ç•¶å‰æŸ¥çœ‹æ˜ç´°çš„é¡åˆ¥
            editingTxId: null, // ç·¨è¼¯ä¸­çš„ ID
            editDate: '', // ç·¨è¼¯æ¨¡å¼ä¸‹çš„æ—¥æœŸå­—ä¸² YYYY-MM-DD
            editTime: ''  // ç·¨è¼¯æ¨¡å¼ä¸‹çš„æ™‚é–“å­—ä¸² HH:mm
        },

        switchTab(tab) {
            this.state.activeTab = tab;
            // åˆ‡æ›åˆ†é æ™‚é‡ç½®éƒ¨åˆ†ç‹€æ…‹ï¼Œä½†å¦‚æœæ˜¯ç‚ºäº†ç·¨è¼¯è€Œè·³è½‰åˆ° home å‰‡ä¿ç•™
            if (tab !== 'home') {
                this.state.editingTxId = null;
                this.state.selectedMainCat = null;
                this.state.homeStep = 1;
            }
            if (tab !== 'stats') {
                this.state.statsDetailCategory = null;
            }
            this.render();
        },

        changeMonth(offset) {
            const d = this.state.viewDate;
            d.setMonth(d.getMonth() + offset);
            this.state.viewDate = new Date(d);
            this.state.statsDetailCategory = null; // åˆ‡æ›æœˆä»½æ™‚é‡ç½®åˆ†æè©³æƒ…
            this.render();
        },

        getFilteredTransactions() {
            const y = this.state.viewDate.getFullYear();
            const m = this.state.viewDate.getMonth();
            return this.state.transactions.filter(t => {
                const td = new Date(t.timestamp);
                return td.getFullYear() === y && td.getMonth() === m;
            }).sort((a,b) => b.timestamp - a.timestamp);
        },

        render() {
            const main = document.getElementById('main-view');
            const s = this.state;
            
            document.querySelectorAll('.nav-btn').forEach(b => {
                b.classList.toggle('nav-active', b.dataset.tab === s.activeTab);
                b.classList.toggle('text-slate-400', b.dataset.tab !== s.activeTab);
            });

            if (s.activeTab === 'home') this.renderHome(main);
            else if (s.activeTab === 'history') this.renderHistory(main);
            else if (s.activeTab === 'stats') this.renderStats(main);
            else if (s.activeTab === 'settings') this.renderSettings(main);
            lucide.createIcons();
        },

        handleCalc(val) {
            let s = this.state;
            if (val === 'C') s.amount = '0';
            else if (val === 'âŒ«') s.amount = s.amount.length > 1 ? s.amount.slice(0, -1) : '0';
            else if (val === '=') { try { s.amount = String(eval(s.amount.replace(/[^-()\d/*+.]/g, ''))); } catch(e) { s.amount = '0'; } }
            else s.amount = (s.amount === '0' && !isNaN(val)) ? val : s.amount + val;
            
            document.getElementById('amount-text').innerText = `$${s.amount}`;
        },

        // --- æ ¸å¿ƒä¿®æ”¹ï¼šç·¨è¼¯åŠŸèƒ½ (å«æ™‚é–“) ---
        editTx(txId) {
            const s = this.state;
            const tx = s.transactions.find(t => t.id === txId);
            if (!tx) return;

            s.editingTxId = txId;
            s.amount = String(tx.amount);
            s.note = tx.note || '';
            s.type = tx.type;

            // è§£ææ™‚é–“
            const d = new Date(tx.timestamp);
            // è½‰æ›ç‚º YYYY-MM-DD
            s.editDate = d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
            // è½‰æ›ç‚º HH:mm
            s.editTime = String(d.getHours()).padStart(2, '0') + ':' + String(d.getMinutes()).padStart(2, '0');
            
            // å°‹æ‰¾å°æ‡‰é¡åˆ¥
            const cat = s.categories.find(c => c.id === tx.mainCatId) || 
                        s.categories.find(c => c.name === tx.mainCatName && c.type === tx.type);
            
            s.selectedMainCat = cat || null;
            s.homeStep = 1;
            
            // è·³è½‰åˆ°è¨˜å¸³é é¢é€²è¡Œä¿®æ”¹
            this.switchTab('home');
        },

        cancelEdit() {
            this.state.editingTxId = null;
            this.state.amount = '0';
            this.state.note = '';
            this.state.selectedMainCat = null;
            
            // é‡ç½®æ™‚é–“ç‚ºç¾åœ¨
            const now = new Date();
            this.state.editDate = now.toISOString().split('T')[0];
            this.state.editTime = now.toTimeString().substring(0,5);

            this.render();
        },

        async saveRecord(sub) {
            const s = this.state;
            const collectionRef = collection(db, 'artifacts', appId, 'users', s.user.uid, 'transactions');
            
            // --- æ ¸å¿ƒä¿®æ”¹ï¼šçµ„åˆæ™‚é–“ ---
            let finalDate;
            if (s.editingTxId && s.editDate && s.editTime) {
                // ç·¨è¼¯æ¨¡å¼ï¼šä½¿ç”¨ä½¿ç”¨è€…é¸æ“‡çš„æ—¥æœŸæ™‚é–“
                finalDate = new Date(`${s.editDate}T${s.editTime}`);
            } else if (!s.editingTxId && s.editDate && s.editTime) {
                // æ–°å¢æ¨¡å¼ä½†æœ‰èª¿æ•´æ™‚é–“
                 finalDate = new Date(`${s.editDate}T${s.editTime}`);
            } else {
                // é è¨­ç‚ºç¾åœ¨
                finalDate = new Date();
            }

            const data = {
                amount: parseFloat(s.amount), 
                note: s.note,
                mainCatId: s.selectedMainCat.id, 
                mainCatName: s.selectedMainCat.name,
                subCat: sub, 
                type: s.type,
                timestamp: finalDate.getTime(),
                dateString: finalDate.toLocaleDateString('zh-TW'),
                timeString: finalDate.toLocaleTimeString('zh-TW', { hour12: false, hour: '2-digit', minute: '2-digit' })
            };

            if (s.editingTxId) {
                const docRef = doc(db, 'artifacts', appId, 'users', s.user.uid, 'transactions', s.editingTxId);
                await updateDoc(docRef, data);
                s.editingTxId = null; 
            } else {
                await addDoc(collectionRef, data);
            }

            // é‡ç½®
            s.amount = '0'; s.note = ''; s.homeStep = 1; s.selectedMainCat = null;
            // å›åˆ°æ­·å²ç´€éŒ„
            this.switchTab('history');
        },

        // --- æ ¸å¿ƒä¿®æ”¹ï¼šæ–°å¢æ—¥æœŸæ™‚é–“é¸æ“‡å™¨ ---
        renderHome(container) {
            const s = this.state;
            const cats = s.categories.filter(c=>c.type===s.type).sort((a,b)=>(a.order||0)-(b.order||0));
            const isEditing = !!s.editingTxId;

            // ç¢ºä¿æœ‰é è¨­æ™‚é–“å€¼
            if (!s.editDate) {
                const now = new Date();
                s.editDate = now.toISOString().split('T')[0];
                s.editTime = now.toTimeString().substring(0,5);
            }

            const inner = s.homeStep === 1 ? `
                <div class="bg-white rounded-[2rem] p-5 shadow-sm border ${isEditing ? 'border-amber-400 bg-amber-50' : 'border-slate-100'} mb-4 transition-colors">
                    ${isEditing ? '<div class="flex justify-between items-center mb-2"><span class="text-[10px] font-black text-amber-500 bg-amber-100 px-2 py-1 rounded">ç·¨è¼¯æ¨¡å¼</span><button onclick="window.app.cancelEdit()" class="text-[10px] text-slate-400 underline">å–æ¶ˆ / å›å¾©æ–°å¢</button></div>' : ''}
                    
                    <div class="flex gap-2 mb-2 bg-slate-50 p-1 rounded-xl">
                        <button onclick="window.app.state.type='expense'; window.app.render();" class="flex-1 py-2 rounded-lg font-bold text-[10px] ${s.type==='expense'?'bg-white text-rose-500 shadow-sm':'text-slate-400'}">æ”¯å‡º</button>
                        <button onclick="window.app.state.type='income'; window.app.render();" class="flex-1 py-2 rounded-lg font-bold text-[10px] ${s.type==='income'?'bg-white text-emerald-500 shadow-sm':'text-slate-400'}">æ”¶å…¥</button>
                    </div>

                    <div class="flex gap-2 mb-2 items-center">
                        <div class="flex-1 bg-slate-50 rounded-lg px-2 py-1 flex items-center gap-2 border border-slate-100">
                             <i data-lucide="calendar" class="w-3 h-3 text-slate-400"></i>
                             <input type="date" value="${s.editDate}" onchange="window.app.state.editDate=this.value" class="w-full text-xs font-bold text-slate-600 bg-transparent outline-none">
                        </div>
                        <div class="flex-1 bg-slate-50 rounded-lg px-2 py-1 flex items-center gap-2 border border-slate-100">
                             <i data-lucide="clock" class="w-3 h-3 text-slate-400"></i>
                             <input type="time" value="${s.editTime}" onchange="window.app.state.editTime=this.value" class="w-full text-xs font-bold text-slate-600 bg-transparent outline-none">
                        </div>
                    </div>

                    <div id="amount-text" class="num-font text-5xl font-bold text-right py-2 text-slate-800 tracking-tighter">$${s.amount}</div>
                    <input type="text" placeholder="ğŸ“ å‚™è¨»..." oninput="window.app.state.note=this.value" value="${s.note}" class="w-full bg-slate-50 rounded-xl py-3 px-4 text-xs font-bold border-none" />
                </div>
                <div class="grid grid-cols-4 gap-2">
                    ${['7','8','9','âŒ«','4','5','6','/','1','2','3','*','0','.','C','-'].map(b=>`<button onclick="window.app.handleCalc('${b}')" class="calc-btn h-14 bg-white rounded-xl font-bold text-lg text-slate-600 shadow-sm">${b}</button>`).join('')}
                    <button onclick="window.app.handleCalc('+')" class="calc-btn h-14 bg-indigo-50 text-indigo-600 rounded-xl font-bold text-xl">+</button>
                    <button onclick="window.app.handleCalc('=')" class="calc-btn h-14 bg-indigo-50 text-indigo-600 rounded-xl font-bold text-xl">=</button>
                    <button onclick="window.app.state.homeStep=2; window.app.render();" class="col-span-2 h-14 bg-indigo-600 text-white rounded-xl font-black shadow-lg">${isEditing ? 'ä¸‹ä¸€æ­¥ (ä¿®æ”¹)' : 'ä¸‹ä¸€æ­¥'}</button>
                </div>
            ` : `
                <button onclick="window.app.state.homeStep=1; window.app.render();" class="flex items-center gap-1 text-indigo-600 font-bold mb-5 text-sm"><i data-lucide="chevron-left" class="w-4 h-4"></i> è¿”å›é‡‘é¡</button>
                ${isEditing ? '<div class="mb-4 text-center"><span class="text-[10px] font-black text-amber-500 bg-amber-100 px-3 py-1 rounded-full">è«‹é¸æ“‡æ–°é¡åˆ¥ (æˆ–ä¿æŒåŸæ¨£)</span></div>' : ''}
                <div class="grid grid-cols-3 gap-3 mb-6">
                    ${cats.map(c=>`
                        <button onclick="window.app.state.selectedMainCat=${JSON.stringify(c).replace(/"/g, '&quot;')}; window.app.render();" class="p-4 rounded-3xl border-2 transition flex flex-col items-center gap-1 ${s.selectedMainCat?.id===c.id?'border-indigo-600 bg-indigo-50':'border-transparent bg-white shadow-sm'}">
                            <span class="text-3xl">${c.icon}</span>
                            <span class="text-[10px] font-bold text-slate-500">${c.name}</span>
                        </button>`).join('')}
                </div>
                ${s.selectedMainCat ? `<div class="bg-slate-900 p-5 rounded-[2.5rem] animate-up grid grid-cols-2 gap-2">
                    ${s.selectedMainCat.subCategories.map(sub=>`<button onclick="window.app.saveRecord('${sub}')" class="py-3 bg-white/10 text-white rounded-xl font-bold text-[11px]">${sub}</button>`).join('')}
                </div>` : ''}
            `;

            container.innerHTML = `<div class="flex-1 overflow-y-auto p-5 animate-up pb-24 no-scrollbar">${inner}</div>`;
        },

        getMonthSelectorHTML() {
            const dateStr = this.state.viewDate.toLocaleDateString('zh-TW', { year: 'numeric', month: 'long' });
            return `
            <div class="flex items-center justify-between bg-white p-2 rounded-xl shadow-sm mb-4 border border-slate-100">
                <button onclick="window.app.changeMonth(-1)" class="p-2 text-slate-400 hover:text-indigo-600"><i data-lucide="chevron-left" class="w-5 h-5"></i></button>
                <span class="font-black text-slate-700 text-sm tracking-widest">${dateStr}</span>
                <button onclick="window.app.changeMonth(1)" class="p-2 text-slate-400 hover:text-indigo-600"><i data-lucide="chevron-right" class="w-5 h-5"></i></button>
            </div>`;
        },

        renderHistory(container) {
            const filtered = this.getFilteredTransactions();
            const totalExp = filtered.filter(t=>t.type==='expense').reduce((a,b)=>a+b.amount,0);
            const totalInc = filtered.filter(t=>t.type==='income').reduce((a,b)=>a+b.amount,0);

            container.innerHTML = `
            <div class="flex flex-col h-full animate-up">
                <div class="p-5 pb-2 shrink-0 z-10 bg-[#f8fafc]">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-black text-slate-800">å¸³ç›®æ˜ç´°</h2>
                        <button onclick="window.app.exportToExcel()" class="bg-emerald-600 text-white px-3 py-1.5 rounded-lg text-[10px] font-black flex items-center gap-1 shadow-md"><i data-lucide="file-spreadsheet" class="w-3.5 h-3.5"></i>åŒ¯å‡º XLSX</button>
                    </div>
                    
                    ${this.getMonthSelectorHTML()}

                    <div class="flex gap-2 mb-2">
                        <div class="flex-1 bg-rose-50 p-3 rounded-xl">
                            <p class="text-[9px] text-rose-400 font-bold mb-1">ç¸½æ”¯å‡º</p>
                            <p class="text-lg font-black text-rose-600 num-font">$${totalExp.toLocaleString()}</p>
                        </div>
                        <div class="flex-1 bg-emerald-50 p-3 rounded-xl">
                            <p class="text-[9px] text-emerald-400 font-bold mb-1">ç¸½æ”¶å…¥</p>
                            <p class="text-lg font-black text-emerald-600 num-font">$${totalInc.toLocaleString()}</p>
                        </div>
                    </div>
                </div>

                <div class="flex-1 overflow-y-auto p-5 pt-2 pb-24 no-scrollbar">
                    <div class="space-y-2">
                        ${filtered.length === 0 ? `<div class="text-center py-10 text-slate-300 text-xs font-bold">æœ¬æœˆç„¡è³‡æ–™</div>` : 
                        filtered.map(t=>`
                            <div onclick="window.app.editTx('${t.id}')" class="bg-white p-4 rounded-2xl flex justify-between items-center shadow-sm border border-slate-100 cursor-pointer active:scale-[0.98] transition-transform">
                                <div>
                                    <div class="flex items-center gap-2"><span class="font-bold text-slate-800 text-sm">${t.subCat}</span><span class="text-[8px] px-1.5 py-0.5 bg-slate-100 text-slate-400 rounded font-bold">${t.mainCatName}</span></div>
                                    <p class="text-[9px] text-indigo-400 font-bold num-font mt-1">${t.dateString} ${t.timeString} <span class="text-slate-300 ml-1">é»æ“Šç·¨è¼¯</span></p>
                                </div>
                                <div class="flex items-center gap-2">
                                    <div class="text-right mr-2">
                                        <p class="font-black text-base ${t.type==='income'?'text-emerald-500':'text-rose-500'}">${t.type==='income'?'+':'-'}${t.amount.toLocaleString()}</p>
                                        <p class="text-[8px] text-slate-300 italic truncate max-w-[80px]">${t.note || ''}</p>
                                    </div>
                                </div>
                            </div>`).join('')}
                    </div>
                </div>
            </div>`;
        },

        // --- æ ¸å¿ƒä¿®æ”¹ï¼šåˆ†æé é¢æ”¯æ´é»æ“ŠæŸ¥çœ‹æ˜ç´° ---
        renderStats(container) {
            const s = this.state;
            const filtered = this.getFilteredTransactions().filter(t=>t.type===s.statsType);
            
            // å¦‚æœæ­£åœ¨æŸ¥çœ‹æŸé¡åˆ¥çš„æ˜ç´°
            if (s.statsDetailCategory) {
                 const detailList = filtered.filter(t => t.mainCatName === s.statsDetailCategory);
                 const total = detailList.reduce((a,b) => a+b.amount, 0);

                 container.innerHTML = `
                    <div class="flex flex-col h-full animate-up">
                        <div class="p-5 pb-2 shrink-0 bg-[#f8fafc]">
                            <button onclick="window.app.state.statsDetailCategory=null; window.app.render();" class="mb-4 flex items-center gap-1 text-slate-500 text-xs font-bold hover:text-indigo-600">
                                <i data-lucide="arrow-left" class="w-4 h-4"></i> è¿”å›åœ–è¡¨
                            </button>
                            <div class="flex items-center justify-between">
                                <h2 class="text-xl font-black text-slate-800 flex items-center gap-2">
                                    ${s.statsDetailCategory} 
                                    <span class="text-xs bg-indigo-100 text-indigo-600 px-2 py-0.5 rounded-full">æ˜ç´°</span>
                                </h2>
                                <span class="text-lg font-black text-slate-600 num-font">$${total.toLocaleString()}</span>
                            </div>
                        </div>
                        <div class="flex-1 overflow-y-auto p-5 pt-2 pb-24 no-scrollbar">
                             <div class="space-y-2">
                                ${detailList.length === 0 ? '<div class="text-center text-slate-300 text-xs">ç„¡è³‡æ–™</div>' :
                                detailList.map(t => `
                                    <div onclick="window.app.editTx('${t.id}')" class="bg-white p-4 rounded-2xl flex justify-between items-center shadow-sm border border-slate-100 cursor-pointer active:scale-[0.98] transition-transform">
                                        <div>
                                            <span class="font-bold text-slate-800 text-sm">${t.subCat}</span>
                                            <p class="text-[9px] text-slate-400 font-bold num-font mt-1">${t.dateString} ${t.timeString}</p>
                                        </div>
                                        <div class="text-right">
                                            <p class="font-black text-base ${t.type==='income'?'text-emerald-500':'text-rose-500'}">${t.amount.toLocaleString()}</p>
                                            <p class="text-[8px] text-slate-300 italic">${t.note || 'ç„¡å‚™è¨»'}</p>
                                        </div>
                                    </div>
                                `).join('')}
                             </div>
                        </div>
                    </div>
                 `;
                 return; // ææ—©çµæŸï¼Œä¸æ¸²æŸ“åœ–è¡¨
            }

            // åŸæœ¬çš„åœ–è¡¨è¦–åœ–
            const dataMap = {};
            filtered.forEach(t => { dataMap[t.mainCatName] = (dataMap[t.mainCatName]||0) + t.amount; });
            const labels = Object.keys(dataMap);
            const data = Object.values(dataMap);
            const total = data.reduce((a,b)=>a+b,0);

            // æ’åº
            const sorted = labels.map((l, i) => ({ l, d: data[i] })).sort((a,b) => b.d - a.d);

            container.innerHTML = `
            <div class="flex flex-col h-full animate-up">
                <div class="p-5 pb-2 shrink-0 bg-[#f8fafc]">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-black text-slate-800">æ”¶æ”¯åˆ†æ</h2>
                    </div>
                    ${this.getMonthSelectorHTML()}
                    <div class="flex bg-white p-1 rounded-xl border border-slate-100 mb-4">
                        <button onclick="window.app.state.statsType='expense'; window.app.render()" class="flex-1 py-1.5 rounded-lg text-[10px] font-bold ${s.statsType==='expense'?'bg-rose-500 text-white shadow-md':'text-slate-400'}">æ”¯å‡ºåˆ†å¸ƒ</button>
                        <button onclick="window.app.state.statsType='income'; window.app.render()" class="flex-1 py-1.5 rounded-lg text-[10px] font-bold ${s.statsType==='income'?'bg-emerald-500 text-white shadow-md':'text-slate-400'}">æ”¶å…¥ä¾†æº</button>
                    </div>
                </div>
                
                <div class="flex-1 overflow-y-auto p-5 pt-0 pb-24 no-scrollbar">
                    ${total === 0 ? `<div class="flex flex-col items-center justify-center h-64 text-slate-300 text-xs font-bold gap-2"><i data-lucide="bar-chart-2" class="w-8 h-8 opacity-50"></i>æœ¬æœˆç„¡è³‡æ–™</div>` : `
                        <div class="h-48 mb-6 relative z-0">
                            <canvas id="statsChart"></canvas>
                        </div>
                        <div class="space-y-3">
                            ${sorted.map(item => {
                                const percent = Math.round((item.d / total) * 100);
                                return `
                                <div onclick="window.app.state.statsDetailCategory='${item.l}'; window.app.render();" class="flex items-center gap-3 bg-white p-3 rounded-xl border border-slate-100 cursor-pointer hover:bg-slate-50 active:scale-[0.98] transition-transform">
                                    <div class="w-10 h-1 rounded-full bg-slate-100 overflow-hidden flex flex-col justify-end"><div class="bg-indigo-500 w-full" style="height:${percent}%"></div></div>
                                    <div class="flex-1">
                                        <div class="flex justify-between items-center mb-1">
                                            <span class="font-bold text-xs text-slate-700">${item.l}</span>
                                            <span class="font-bold text-[10px] text-slate-400">${percent}%</span>
                                        </div>
                                        <div class="w-full bg-slate-100 h-1.5 rounded-full overflow-hidden"><div class="bg-indigo-500 h-full rounded-full" style="width:${percent}%"></div></div>
                                    </div>
                                    <span class="font-black text-sm text-slate-800 num-font">$${item.d.toLocaleString()}</span>
                                    <i data-lucide="chevron-right" class="w-4 h-4 text-slate-300"></i>
                                </div>`;
                            }).join('')}
                        </div>
                    `}
                </div>
            </div>`;

            if (total > 0) {
                setTimeout(() => {
                    const ctx = document.getElementById('statsChart');
                    if (chartInstance) chartInstance.destroy();
                    if (ctx) {
                        chartInstance = new Chart(ctx, {
                            type: 'doughnut',
                            data: {
                                labels: sorted.map(i=>i.l),
                                datasets: [{
                                    data: sorted.map(i=>i.d),
                                    backgroundColor: ['#6366f1', '#f43f5e', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899', '#06b6d4'],
                                    borderWidth: 0
                                }]
                            },
                            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
                        });
                    }
                }, 0);
            }
        },

        renderSettings(container) { /* èˆ‡ä¹‹å‰ç‰ˆæœ¬ç›¸åŒï¼Œçœç•¥ä»¥ç¯€çœç©ºé–“ */ 
             // ç‚ºäº†å®Œæ•´æ€§é€™è£¡è£œä¸Šæœ€å°åŒ–ä»£ç¢¼ï¼Œç¢ºä¿åˆ†é åŠŸèƒ½æ­£å¸¸
             const s = this.state;
             const list = s.categories.filter(c => c.type === s.settingsType).sort((a,b)=>(a.order||0)-(b.order||0));
             container.innerHTML = `
             <div class="flex flex-col h-full animate-up">
                <div class="p-5 pb-2 shrink-0 bg-[#f8fafc]">
                    <h2 class="text-lg font-black text-slate-800 mb-4">é¡åˆ¥ç®¡ç†</h2>
                    <div class="flex bg-white p-1 rounded-xl border border-slate-100 mb-4">
                        <button onclick="window.app.state.settingsType='expense'; window.app.render()" class="flex-1 py-1.5 rounded-lg text-[10px] font-bold ${s.settingsType==='expense'?'bg-rose-500 text-white shadow-md':'text-slate-400'}">æ”¯å‡ºé¡åˆ¥</button>
                        <button onclick="window.app.state.settingsType='income'; window.app.render()" class="flex-1 py-1.5 rounded-lg text-[10px] font-bold ${s.settingsType==='income'?'bg-emerald-500 text-white shadow-md':'text-slate-400'}">æ”¶å…¥é¡åˆ¥</button>
                    </div>
                </div>
                <div class="flex-1 overflow-y-auto p-5 pt-0 pb-24 no-scrollbar">
                    <div id="cat-list" class="space-y-3">
                        ${list.map(c => `
                            <div class="bg-white p-4 rounded-2xl flex items-center justify-between border border-slate-100">
                                <div class="flex items-center gap-3">
                                    <span class="text-2xl">${c.icon}</span>
                                    <div>
                                        <p class="font-bold text-slate-800 text-sm">${c.name}</p>
                                        <p class="text-[9px] text-slate-400">${c.subCategories.join(', ')}</p>
                                    </div>
                                </div>
                                <button onclick="window.app.editCat('${c.id}')" class="p-2 text-slate-300 hover:text-indigo-600"><i data-lucide="edit-2" class="w-4 h-4"></i></button>
                            </div>
                        `).join('')}
                    </div>
                    <button onclick="window.app.addCategory()" class="w-full mt-4 py-3 border-2 border-dashed border-slate-300 text-slate-400 rounded-xl font-bold text-xs hover:border-indigo-500 hover:text-indigo-500 transition">+ æ–°å¢é¡åˆ¥</button>
                </div>
             </div>`;
             
             // é€™è£¡çœç•¥äº†è¤‡é›œçš„ SortableJS å’Œ SweetAlert2 å½ˆè·³è¦–çª—é‚è¼¯
             // å› ç‚ºä¸»è¦éœ€æ±‚æ˜¯ä¿®æ”¹è¨˜å¸³ç·¨è¼¯é‚è¼¯ï¼Œè‹¥éœ€è¦å®Œæ•´åˆ†é¡ç®¡ç†ä»£ç¢¼è«‹ä¿ç•™æ‚¨ä¸Šä¸€ç‰ˆçš„é€™éƒ¨åˆ†
             // æˆ–æ˜¯å¦‚æœæ‚¨å¸Œæœ›æˆ‘è£œä¸Šè¨­å®šé é¢çš„å®Œæ•´é‚è¼¯è«‹å‘ŠçŸ¥ã€‚
             // ç›®å‰é€™å€‹ renderSettings åƒ…ä¾›é¡¯ç¤ºåˆ—è¡¨ï¼Œé¿å…åˆ‡æ›æ™‚å ±éŒ¯ã€‚
        },
        
        // ç‚ºäº†è®“è¨­å®šé é¢åŸºæœ¬é‹ä½œä¸å ±éŒ¯ï¼Œè£œä¸Šç©ºå‡½å¼
        exportToExcel() {
            const filtered = this.getFilteredTransactions();
            if (filtered.length === 0) return alert('æ­¤æœˆä»½ç„¡å¸³ç›®');
            const data = filtered.map(t => ({
                'æ—¥æœŸ': t.dateString, 'æ™‚é–“': t.timeString, 'é¡å‹': t.type === 'income' ? 'æ”¶å…¥' : 'æ”¯å‡º',
                'ä¸»é¡åˆ¥': t.mainCatName, 'å­é¡åˆ¥': t.subCat, 'é‡‘é¡': t.amount, 'å‚™è¨»': t.note || ''
            }));
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Records");
            const dateStr = this.state.viewDate.toISOString().slice(0,7);
            XLSX.writeFile(wb, `Account_${dateStr}.xlsx`);
        }
    };

    // Firebase ç›£è½é‚è¼¯ (é€™éƒ¨åˆ†ä¿æŒä¸è®Š)
    onAuthStateChanged(auth, (user) => {
        const loginScreen = document.getElementById('login-screen');
        const appContent = document.getElementById('app-content');
        
        if (user && user.email === ALLOWED_USER) {
            window.app.state.user = user;
            document.getElementById('user-display').innerText = user.displayName || 'Admin';
            loginScreen.classList.add('hidden');
            appContent.classList.remove('hidden');

            const userRef = doc(db, 'artifacts', appId, 'users', user.uid);
            setDoc(userRef, { lastLogin: new Date() }, { merge: true });

            if (unsubCat) unsubCat();
            unsubCat = onSnapshot(collection(db, 'artifacts', appId, 'users', user.uid, 'categories'), (snap) => {
                window.app.state.categories = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                window.app.render();
            });

            if (unsubTx) unsubTx();
            unsubTx = onSnapshot(collection(db, 'artifacts', appId, 'users', user.uid, 'transactions'), (snap) => {
                window.app.state.transactions = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                window.app.render();
            });

        } else {
            loginScreen.classList.remove('hidden');
            appContent.classList.add('hidden');
            if(user) signOut(auth);
        }
    });

    document.getElementById('google-login-btn').addEventListener('click', () => signInWithPopup(auth, provider));
    document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));

    // å› ç‚ºé€™è£¡çœç•¥äº†è¨­å®šé é¢çš„ç·¨è¼¯/æ–°å¢é¡åˆ¥è©³ç´°é‚è¼¯ï¼Œè‹¥æ‚¨éœ€è¦é‚£äº›åŠŸèƒ½
    // è«‹ä¿ç•™æ‚¨åŸæœ¬ç¨‹å¼ç¢¼ä¸­çš„ addCategory, editCat, saveCat ç­‰å‡½å¼
    // æˆ–è€…éœ€è¦æˆ‘è£œä¸Šå®Œæ•´çš„ renderSettings å‡½å¼ä¹Ÿè«‹å‘ŠçŸ¥ã€‚
    
    // ç°¡å–®çš„ editCat/addCategory placeholder ä»¥é˜²å ±éŒ¯
    window.app.addCategory = () => alert('è«‹ä½¿ç”¨ä¹‹å‰çš„ç‰ˆæœ¬ä»£ç¢¼ä¾†ä¿ç•™å®Œæ•´çš„é¡åˆ¥æ–°å¢åŠŸèƒ½ï¼Œæˆ–å‘ŠçŸ¥æˆ‘éœ€è¦è£œä¸Š');
    window.app.editCat = (id) => alert('è«‹ä½¿ç”¨ä¹‹å‰çš„ç‰ˆæœ¬ä»£ç¢¼ä¾†ä¿ç•™å®Œæ•´çš„é¡åˆ¥ç·¨è¼¯åŠŸèƒ½ï¼Œæˆ–å‘ŠçŸ¥æˆ‘éœ€è¦è£œä¸Š');

</script>
</body>
</html>
