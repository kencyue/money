<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å£è¢‹è¨˜å¸³ Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&family=JetBrains+Mono:wght@700&display=swap');
        
        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            -webkit-tap-highlight-color: transparent; 
            height: 100dvh; 
            width: 100vw;
            overflow: hidden; 
            background-color: #f8fafc;
        }
        .num-font { font-family: 'JetBrains Mono', monospace; }
        .glass-effect { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); }
        
        .app-container { 
            height: 100dvh; 
            display: flex; 
            flex-direction: column; 
            position: relative;
        }
        
        .content-area { 
            flex: 1; 
            overflow: hidden; 
            position: relative;
            display: flex;
            flex-direction: column;
        }
        
        .calc-btn { transition: transform 0.05s ease; border: 1px solid rgba(0,0,0,0.03); display: flex; align-items: center; justify-content: center; }
        .calc-btn:active { transform: scale(0.92); background-color: #e2e8f0; }
        .nav-active { color: #4f46e5; background-color: #f5f3ff; }
        .animate-up { animation: slideUp 0.2s ease-out; }
        @keyframes slideUp { from { transform: translateY(8px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .sortable-ghost { opacity: 0.4; background: #e0e7ff; }
        .sortable-drag { cursor: grabbing; opacity: 1; background: white; transform: scale(1.02); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        
        /* è‡ªå®šç¾©æ²è»¸æ¨£å¼ */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* æ—¥æœŸè¼¸å…¥æ¡†æ¨£å¼å„ªåŒ– */
        input[type="datetime-local"]::-webkit-calendar-picker-indicator {
            background: transparent;
            bottom: 0;
            color: transparent;
            cursor: pointer;
            height: auto;
            left: 0;
            position: absolute;
            right: 0;
            top: 0;
            width: auto;
        }
    </style>
</head>
<body>

    <div id="login-screen" class="fixed inset-0 bg-slate-900 z-[200] flex flex-col items-center justify-center p-8">
        <div class="mb-8 p-6 bg-indigo-500/20 rounded-[2.5rem]"><i data-lucide="shield-check" class="w-16 h-16 text-indigo-400"></i></div>
        <h1 class="text-white text-2xl font-black tracking-tight mb-8 text-center">PRIVATE FINANCE</h1>
        <button id="google-login-btn" class="w-full max-w-xs bg-white text-slate-900 font-bold py-4 rounded-2xl flex items-center justify-center gap-3 active:scale-95 transition shadow-xl">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5"> ç®¡ç†å“¡ç™»å…¥
        </button>
    </div>

    <div id="app-content" class="hidden app-container max-w-md mx-auto bg-slate-50 relative">
        <header class="glass-effect shrink-0 px-6 pt-4 pb-3 border-b flex justify-between items-center z-50">
            <div>
                <h1 class="text-sm font-black text-slate-900 italic tracking-tighter">POCKET PRO</h1>
                <p id="user-display" class="text-[8px] font-bold text-indigo-500 uppercase tracking-widest mt-0.5">Admin</p>
            </div>
            <button id="logout-btn" class="p-2 bg-slate-100 rounded-lg text-slate-400"><i data-lucide="log-out" class="w-4 h-4"></i></button>
        </header>

        <main id="main-view" class="content-area"></main>

        <nav class="glass-effect fixed bottom-0 left-0 right-0 max-w-md mx-auto border-t flex justify-around p-1 pb-[calc(env(safe-area-inset-bottom)+4px)] z-50">
            <button onclick="window.app.switchTab('home')" class="nav-btn flex-1 flex flex-col items-center py-2 rounded-xl" data-tab="home"><i data-lucide="plus-circle" class="w-5 h-5"></i><span class="text-[9px] font-bold mt-1">è¨˜å¸³</span></button>
            <button onclick="window.app.switchTab('history')" class="nav-btn flex-1 flex flex-col items-center py-2 rounded-xl" data-tab="history"><i data-lucide="layout-list" class="w-5 h-5"></i><span class="text-[9px] font-bold mt-1">æ˜ç´°</span></button>
            <button onclick="window.app.switchTab('stats')" class="nav-btn flex-1 flex flex-col items-center py-2 rounded-xl" data-tab="stats"><i data-lucide="pie-chart" class="w-5 h-5"></i><span class="text-[9px] font-bold mt-1">åˆ†æ</span></button>
            <button onclick="window.app.switchTab('settings')" class="nav-btn flex-1 flex flex-col items-center py-2 rounded-xl" data-tab="settings"><i data-lucide="layers" class="w-5 h-5"></i><span class="text-[9px] font-bold mt-1">åˆ†é¡</span></button>
        </nav>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
    import { getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, onSnapshot, setDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAC6VEkioGi-VC8MHXW3-nl4ngWwPRsMyw",
        authDomain: "money-c5f6e.firebaseapp.com",
        projectId: "money-c5f6e",
        storageBucket: "money-c5f6e.firebasestorage.app",
        messagingSenderId: "965877863338",
        appId: "1:965877863338:web:59c5078c04bc4c9458d1d3"
    };

    const fApp = initializeApp(firebaseConfig);
    const auth = getAuth(fApp);
    const db = getFirestore(fApp);
    const provider = new GoogleAuthProvider();
    const ALLOWED_USER = "jingsyuan@gmail.com";
    const appId = 'pocket-account-pro-v2';

    let unsubTx = null, unsubCat = null;
    let chartInstance = null;

    const getLocalISOString = (date) => {
        const offset = date.getTimezoneOffset() * 60000;
        return new Date(date.getTime() - offset).toISOString().slice(0, 16);
    };

    window.app = {
        state: {
            user: null, activeTab: 'home', transactions: [], categories: [],
            homeStep: 1, amount: '0', note: '', type: 'expense',
            selectedMainCat: null, statsType: 'expense', 
            isAdding: false, editingCatId: null,
            viewDate: new Date(),
            settingsType: 'expense',
            statsDetailCategory: null,
            editingTxId: null,
            selectedDate: getLocalISOString(new Date())
        },

        switchTab(tab) {
            this.state.activeTab = tab;
            this.state.isAdding = false;
            this.state.editingCatId = null;
            this.state.statsDetailCategory = null;
            
            if (tab !== 'home' || !this.state.editingTxId) {
                 this.state.editingTxId = null;
                 if(tab === 'home') {
                     this.state.amount = '0';
                     this.state.note = '';
                     this.state.homeStep = 1;
                     this.state.selectedMainCat = null;
                     this.state.selectedDate = getLocalISOString(new Date());
                 }
            }
            this.render();
        },

        changeMonth(offset) {
            const d = this.state.viewDate;
            d.setMonth(d.getMonth() + offset);
            this.state.viewDate = new Date(d);
            this.render();
        },

        getFilteredTransactions() {
            const y = this.state.viewDate.getFullYear();
            const m = this.state.viewDate.getMonth();
            return this.state.transactions.filter(t => {
                const td = new Date(t.timestamp);
                return td.getFullYear() === y && td.getMonth() === m;
            });
        },

        render() {
            const main = document.getElementById('main-view');
            const s = this.state;
            
            document.querySelectorAll('.nav-btn').forEach(b => {
                b.classList.toggle('nav-active', b.dataset.tab === s.activeTab);
                b.classList.toggle('text-slate-400', b.dataset.tab !== s.activeTab);
            });

            if (s.activeTab === 'home') this.renderHome(main);
            else if (s.activeTab === 'history') this.renderHistory(main);
            else if (s.activeTab === 'stats') this.renderStats(main);
            else if (s.activeTab === 'settings') this.renderSettings(main);
            lucide.createIcons();
        },

        handleCalc(val) {
            let s = this.state;
            const ops = ['+', '-', '*', '/', '.']; 
            const lastChar = s.amount.slice(-1);

            if (val === 'C') {
                s.amount = '0';
            } else if (val === 'âŒ«') {
                s.amount = s.amount.length > 1 ? s.amount.slice(0, -1) : '0';
            } else if (val === '=') {
                try {
                    let safeAmount = s.amount;
                    if (ops.includes(lastChar)) {
                        safeAmount = s.amount.slice(0, -1);
                    }
                    s.amount = String(eval(safeAmount.replace(/[^-()\d/*+.]/g, ''))); 
                } catch(e) { 
                    s.amount = '0'; 
                }
            } else {
                if (ops.includes(val) && ops.includes(lastChar)) {
                    s.amount = s.amount.slice(0, -1) + val;
                } else if (s.amount === '0' && !ops.includes(val)) {
                    s.amount = val;
                } else {
                    s.amount += val;
                }
            }
            
            const display = document.getElementById('amount-text');
            if (display) display.innerText = `$${s.amount}`;
        },

        editTx(txId) {
            const s = this.state;
            const tx = s.transactions.find(t => t.id === txId);
            if (!tx) return;

            s.editingTxId = txId;
            s.amount = String(tx.amount);
            s.note = tx.note || '';
            s.type = tx.type;
            s.selectedDate = getLocalISOString(new Date(tx.timestamp));
            
            const cat = s.categories.find(c => c.id === tx.mainCatId) || 
                        s.categories.find(c => c.name === tx.mainCatName && c.type === tx.type);
            
            s.selectedMainCat = cat || null;
            s.homeStep = 1;
            s.activeTab = 'home';
            this.render();
        },

        cancelEdit() {
            this.state.editingTxId = null;
            this.state.amount = '0';
            this.state.note = '';
            this.state.selectedMainCat = null;
            this.state.selectedDate = getLocalISOString(new Date());
            this.render();
        },

        async saveRecord(sub) {
            const s = this.state;
            const collectionRef = collection(db, 'artifacts', appId, 'users', s.user.uid, 'transactions');
            const recordDate = new Date(s.selectedDate);
            
            const data = {
                amount: parseFloat(s.amount), 
                note: s.note,
                mainCatId: s.selectedMainCat.id, 
                mainCatName: s.selectedMainCat.name,
                subCat: sub, 
                type: s.type,
                timestamp: recordDate.getTime(),
                dateString: recordDate.toLocaleDateString('zh-TW'),
                timeString: recordDate.toLocaleTimeString('zh-TW', { hour12: false, hour: '2-digit', minute: '2-digit' })
            };

            if (s.editingTxId) {
                const docRef = doc(db, 'artifacts', appId, 'users', s.user.uid, 'transactions', s.editingTxId);
                await updateDoc(docRef, data);
                s.editingTxId = null; 
            } else {
                await addDoc(collectionRef, data);
            }

            s.amount = '0'; s.note = ''; s.homeStep = 1; s.selectedMainCat = null;
            s.selectedDate = getLocalISOString(new Date());
            this.switchTab('history');
        },

        exportToExcel() {
            const filtered = this.getFilteredTransactions();
            if (filtered.length === 0) return alert('æ­¤æœˆä»½ç„¡å¸³ç›®');
            const data = filtered.map(t => ({
                'æ—¥æœŸ': t.dateString, 'æ™‚é–“': t.timeString, 'é¡å‹': t.type === 'income' ? 'æ”¶å…¥' : 'æ”¯å‡º',
                'ä¸»é¡åˆ¥': t.mainCatName, 'å­é¡åˆ¥': t.subCat, 'é‡‘é¡': t.amount, 'å‚™è¨»': t.note || ''
            }));
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Records");
            const dateStr = this.state.viewDate.toISOString().slice(0,7);
            XLSX.writeFile(wb, `Account_${dateStr}.xlsx`);
        },

        renderHome(container) {
            const s = this.state;
            const cats = s.categories.filter(c=>c.type===s.type).sort((a,b)=>(a.order||0)-(b.order||0));
            const isEditing = !!s.editingTxId;

            const inner = s.homeStep === 1 ? `
                <div class="bg-white rounded-[2rem] p-5 shadow-sm border ${isEditing ? 'border-amber-400 bg-amber-50' : 'border-slate-100'} mb-4 transition-colors">
                    
                    <div class="flex justify-between items-center mb-2">
                        ${isEditing ? '<span class="text-[10px] font-black text-amber-500 bg-amber-100 px-2 py-1 rounded">ç·¨è¼¯æ¨¡å¼</span>' : '<div></div>'}
                        
                        <div class="relative group">
                            <div class="flex items-center gap-1.5 bg-slate-100 hover:bg-indigo-50 px-3 py-1.5 rounded-full transition cursor-pointer">
                                <i data-lucide="calendar-clock" class="w-3.5 h-3.5 text-slate-400 group-hover:text-indigo-500"></i>
                                <span class="text-[10px] font-bold text-slate-500 group-hover:text-indigo-600 num-font tracking-tight">
                                    ${s.selectedDate.replace('T', ' ')}
                                </span>
                            </div>
                            <input type="datetime-local" 
                                   value="${s.selectedDate}" 
                                   onchange="window.app.state.selectedDate = this.value; window.app.render();"
                                   class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" />
                        </div>
                    </div>
                     ${isEditing ? '<div class="flex justify-end mb-2"><button onclick="window.app.cancelEdit()" class="text-[10px] text-slate-400 underline">å–æ¶ˆ</button></div>' : ''}
                    
                    <div class="flex gap-2 mb-4 bg-slate-50 p-1 rounded-xl">
                        <button onclick="window.app.state.type='expense'; window.app.render();" class="flex-1 py-2 rounded-lg font-bold text-[10px] ${s.type==='expense'?'bg-white text-rose-500 shadow-sm':'text-slate-400'}">æ”¯å‡º</button>
                        <button onclick="window.app.state.type='income'; window.app.render();" class="flex-1 py-2 rounded-lg font-bold text-[10px] ${s.type==='income'?'bg-white text-emerald-500 shadow-sm':'text-slate-400'}">æ”¶å…¥</button>
                    </div>
                    <div id="amount-text" class="num-font text-5xl font-bold text-right py-4 text-slate-800 tracking-tighter">$${s.amount}</div>
                    <input type="text" placeholder="ğŸ“ å‚™è¨»..." oninput="window.app.state.note=this.value" value="${s.note}" class="w-full bg-slate-50 rounded-xl py-3 px-4 text-xs font-bold border-none" />
                </div>
                <div class="grid grid-cols-4 gap-2">
                    ${['7','8','9','âŒ«','4','5','6','/','1','2','3','*','0','.','C','-'].map(b=>`<button onclick="window.app.handleCalc('${b}')" class="calc-btn h-14 bg-white rounded-xl font-bold text-lg text-slate-600 shadow-sm">${b}</button>`).join('')}
                    <button onclick="window.app.handleCalc('+')" class="calc-btn h-14 bg-indigo-50 text-indigo-600 rounded-xl font-bold text-xl">+</button>
                    <button onclick="window.app.handleCalc('=')" class="calc-btn h-14 bg-indigo-50 text-indigo-600 rounded-xl font-bold text-xl">=</button>
                    <button onclick="window.app.state.homeStep=2; window.app.render();" class="col-span-2 h-14 bg-indigo-600 text-white rounded-xl font-black shadow-lg">${isEditing ? 'ä¸‹ä¸€æ­¥ (ä¿®æ”¹)' : 'ä¸‹ä¸€æ­¥'}</button>
                </div>
            ` : `
                <button onclick="window.app.state.homeStep=1; window.app.render();" class="flex items-center gap-1 text-indigo-600 font-bold mb-5 text-sm"><i data-lucide="chevron-left" class="w-4 h-4"></i> è¿”å›é‡‘é¡</button>
                ${isEditing ? '<div class="mb-4 text-center"><span class="text-[10px] font-black text-amber-500 bg-amber-100 px-3 py-1 rounded-full">è«‹é¸æ“‡æ–°é¡åˆ¥ (æˆ–ä¿æŒåŸæ¨£)</span></div>' : ''}
                <div class="grid grid-cols-3 gap-3 mb-6">
                    ${cats.map(c=>`
                        <button onclick="window.app.state.selectedMainCat=${JSON.stringify(c).replace(/"/g, '&quot;')}; window.app.render();" class="p-4 rounded-3xl border-2 transition flex flex-col items-center gap-1 ${s.selectedMainCat?.id===c.id?'border-indigo-600 bg-indigo-50':'border-transparent bg-white shadow-sm'}">
                            <span class="text-3xl">${c.icon}</span>
                            <span class="text-[10px] font-bold text-slate-500">${c.name}</span>
                        </button>`).join('')}
                </div>
                ${s.selectedMainCat ? `<div class="bg-slate-900 p-5 rounded-[2.5rem] animate-up grid grid-cols-2 gap-2">
                    ${s.selectedMainCat.subCategories.map(sub=>`<button onclick="window.app.saveRecord('${sub}')" class="py-3 bg-white/10 text-white rounded-xl font-bold text-[11px]">${sub}</button>`).join('')}
                </div>` : ''}
            `;

            container.innerHTML = `<div class="flex-1 overflow-y-auto p-5 animate-up pb-24">${inner}</div>`;
        },

        getMonthSelectorHTML() {
            const dateStr = this.state.viewDate.toLocaleDateString('zh-TW', { year: 'numeric', month: 'long' });
            return `
            <div class="flex items-center justify-between bg-white p-2 rounded-xl shadow-sm mb-4 border border-slate-100">
                <button onclick="window.app.changeMonth(-1)" class="p-2 text-slate-400 hover:text-indigo-600"><i data-lucide="chevron-left" class="w-5 h-5"></i></button>
                <span class="font-black text-slate-700 text-sm tracking-widest">${dateStr}</span>
                <button onclick="window.app.changeMonth(1)" class="p-2 text-slate-400 hover:text-indigo-600"><i data-lucide="chevron-right" class="w-5 h-5"></i></button>
            </div>`;
        },

        renderHistory(container) {
            const filtered = this.getFilteredTransactions();
            const totalExp = filtered.filter(t=>t.type==='expense').reduce((a,b)=>a+b.amount,0);
            const totalInc = filtered.filter(t=>t.type==='income').reduce((a,b)=>a+b.amount,0);

            container.innerHTML = `
            <div class="flex flex-col h-full animate-up">
                <div class="p-5 pb-2 shrink-0 z-10 bg-[#f8fafc]">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-black text-slate-800">å¸³ç›®æ˜ç´°</h2>
                        <button onclick="window.app.exportToExcel()" class="bg-emerald-600 text-white px-3 py-1.5 rounded-lg text-[10px] font-black flex items-center gap-1 shadow-md"><i data-lucide="file-spreadsheet" class="w-3.5 h-3.5"></i>åŒ¯å‡º XLSX</button>
                    </div>
                    
                    ${this.getMonthSelectorHTML()}

                    <div class="flex gap-2 mb-2">
                        <div class="flex-1 bg-rose-50 p-3 rounded-xl">
                            <p class="text-[9px] text-rose-400 font-bold mb-1">ç¸½æ”¯å‡º</p>
                            <p class="text-lg font-black text-rose-600 num-font">$${totalExp.toLocaleString()}</p>
                        </div>
                        <div class="flex-1 bg-emerald-50 p-3 rounded-xl">
                            <p class="text-[9px] text-emerald-400 font-bold mb-1">ç¸½æ”¶å…¥</p>
                            <p class="text-lg font-black text-emerald-600 num-font">$${totalInc.toLocaleString()}</p>
                        </div>
                    </div>
                </div>

                <div class="flex-1 overflow-y-auto p-5 pt-2 pb-24 no-scrollbar">
                    <div class="space-y-2">
                        ${filtered.length === 0 ? `<div class="text-center py-10 text-slate-300 text-xs font-bold">æœ¬æœˆç„¡è³‡æ–™</div>` : 
                        filtered.map(t=>`
                            <div class="bg-white p-4 rounded-2xl flex justify-between items-center shadow-sm border border-slate-100">
                                <div>
                                    <div class="flex items-center gap-2"><span class="font-bold text-slate-800 text-sm">${t.subCat}</span><span class="text-[8px] px-1.5 py-0.5 bg-slate-100 text-slate-400 rounded font-bold">${t.mainCatName}</span></div>
                                    <p class="text-[9px] text-indigo-400 font-bold num-font mt-1">${t.dateString} ${t.timeString}</p>
                                </div>
                                <div class="flex items-center gap-2">
                                    <div class="text-right mr-2">
                                        <p class="font-black text-base ${t.type==='income'?'text-emerald-500':'text-rose-500'}">${t.type==='income'?'+':'-'}${t.amount.toLocaleString()}</p>
                                        <p class="text-[8px] text-zinc-950 italic truncate max-w-[80px]">${t.note || ''}</p>
                                    </div>
                                    <button onclick="window.app.editTx('${t.id}')" class="w-8 h-8 flex items-center justify-center rounded-full bg-slate-50 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50"><i data-lucide="pencil" class="w-3.5 h-3.5"></i></button>
                                    <button onclick="window.app.deleteTx('${t.id}')" class="w-8 h-8 flex items-center justify-center rounded-full bg-slate-50 text-slate-400 hover:text-rose-600 hover:bg-rose-50"><i data-lucide="trash-2" class="w-3.5 h-3.5"></i></button>
                                </div>
                            </div>`).join('')}
                    </div>
                </div>
            </div>`;
        },

        renderStats(container) {
            const s = this.state;
            const filtered = this.getFilteredTransactions().filter(t => t.type === s.statsType);
            const total = filtered.reduce((acc, t) => acc + t.amount, 0);

            // --- ä¿®æ”¹è™•ï¼šä½¿ç”¨èˆ‡ renderHistory ç›¸åŒçš„å¡ç‰‡çµæ§‹ ---
            if (s.statsDetailCategory) {
                const catTxs = filtered.filter(t => t.mainCatName === s.statsDetailCategory);
                container.innerHTML = `
                <div class="flex flex-col h-full animate-up">
                    <div class="p-5 pb-2 shrink-0 bg-[#f8fafc] z-10">
                        <button onclick="window.app.state.statsDetailCategory=null; window.app.render();" class="flex items-center gap-1 text-indigo-600 font-bold mb-5 text-sm"><i data-lucide="chevron-left" class="w-4 h-4"></i> è¿”å›åœ–è¡¨</button>
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-lg font-black text-slate-800">${s.statsDetailCategory}</h2>
                            <span class="num-font font-bold text-slate-500">$${catTxs.reduce((a,b)=>a+b.amount,0).toLocaleString()}</span>
                        </div>
                    </div>
                    <div class="flex-1 overflow-y-auto p-5 pt-0 pb-24 no-scrollbar">
                        <div class="space-y-2">
                            ${catTxs.length === 0 ? `<div class="text-center py-10 text-slate-300 text-xs font-bold">ç„¡è³‡æ–™</div>` : 
                            catTxs.map(t=>`
                                <div class="bg-white p-4 rounded-2xl flex justify-between items-center shadow-sm border border-slate-100">
                                    <div>
                                        <div class="flex items-center gap-2">
                                            <span class="font-bold text-slate-800 text-sm">${t.subCat}</span>
                                            <span class="text-[8px] px-1.5 py-0.5 bg-slate-100 text-slate-400 rounded font-bold">${t.mainCatName}</span>
                                        </div>
                                        <p class="text-[9px] text-indigo-400 font-bold num-font mt-1">${t.dateString} ${t.timeString}</p>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <div class="text-right mr-2">
                                            <p class="font-black text-base ${t.type==='income'?'text-emerald-500':'text-rose-500'}">${t.amount.toLocaleString()}</p>
                                            <p class="text-[8px] text-zinc-950 italic truncate max-w-[80px]">${t.note || ''}</p>
                                        </div>
                                        <button onclick="window.app.editTx('${t.id}')" class="w-8 h-8 flex items-center justify-center rounded-full bg-slate-50 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50"><i data-lucide="pencil" class="w-3.5 h-3.5"></i></button>
                                        <button onclick="window.app.deleteTx('${t.id}')" class="w-8 h-8 flex items-center justify-center rounded-full bg-slate-50 text-slate-400 hover:text-rose-600 hover:bg-rose-50"><i data-lucide="trash-2" class="w-3.5 h-3.5"></i></button>
                                    </div>
                                </div>`).join('')}
                        </div>
                    </div>
                </div>`;
                return;
            }
            // ----------------------------------------------------

            const groups = filtered.reduce((acc, t) => { acc[t.mainCatName] = (acc[t.mainCatName] || 0) + t.amount; return acc; }, {});
            const sorted = Object.entries(groups).sort((a,b) => b[1] - a[1]);
            const colors = ['#6366f1', '#ec4899', '#8b5cf6', '#14b8a6', '#f59e0b', '#3b82f6', '#ef4444', '#10b981'];

            container.innerHTML = `
            <div class="flex flex-col h-full animate-up">
                <div class="p-5 pb-2 shrink-0 bg-[#f8fafc] z-10">
                    ${this.getMonthSelectorHTML()}
                    
                    <div class="flex gap-2 mb-4 bg-white p-1 rounded-xl shadow-sm">
                        <button onclick="window.app.state.statsType='expense'; window.app.render();" class="flex-1 py-2 rounded-lg font-bold text-[10px] ${s.statsType==='expense'?'bg-rose-500 text-white shadow-md':'text-slate-400'}">æ”¯å‡º</button>
                        <button onclick="window.app.state.statsType='income'; window.app.render();" class="flex-1 py-2 rounded-lg font-bold text-[10px] ${s.statsType==='income'?'bg-emerald-500 text-white shadow-md':'text-slate-400'}">æ”¶å…¥</button>
                    </div>

                    <div class="bg-white p-4 rounded-[2.5rem] shadow-sm border border-slate-100 mb-4 relative">
                        <div class="absolute inset-0 flex items-center justify-center pointer-events-none flex-col pt-4">
                            <span class="text-[10px] text-slate-400 font-bold">Total</span>
                            <span class="text-base font-black text-slate-700 num-font">$${total.toLocaleString()}</span>
                        </div>
                        <canvas id="statsChart" class="max-h-[120px]"></canvas>
                    </div>
                </div>

                <div class="flex-1 overflow-y-auto p-5 pt-0 pb-24 no-scrollbar">
                    <div class="space-y-4">
                        ${sorted.length === 0 ? `<div class="text-center py-5 text-slate-300 text-xs font-bold">ç„¡æ•¸æ“šå¯åˆ†æ</div>` :
                        sorted.map(([n, v], idx) => `
                        <div onclick="window.app.state.statsDetailCategory='${n}'; window.app.render();" class="bg-white p-3 rounded-xl border border-slate-50 flex items-center gap-3 active:scale-95 transition cursor-pointer hover:bg-slate-50">
                            <div class="w-3 h-3 rounded-full shrink-0" style="background-color: ${colors[idx % colors.length]}"></div>
                            <div class="flex-1 space-y-1">
                                <div class="flex justify-between text-[11px] font-black text-slate-600">
                                    <span>${n} <span class="text-[9px] text-indigo-300 ml-1 font-normal">(é»æ“ŠæŸ¥çœ‹)</span></span>
                                    <span>$${v.toLocaleString()}</span>
                                </div>
                                <div class="text-[9px] text-slate-400 font-bold text-right">${Math.round(v/total*100)}%</div>
                            </div>
                        </div>`).join('')}
                    </div>
                </div>
            </div>`;

            if (sorted.length > 0 && !s.statsDetailCategory) {
                if (chartInstance) chartInstance.destroy();
                setTimeout(() => {
                    const ctx = document.getElementById('statsChart');
                    if (ctx) {
                        chartInstance = new Chart(ctx, {
                            type: 'doughnut',
                            data: {
                                labels: sorted.map(i => i[0]),
                                datasets: [{
                                    data: sorted.map(i => i[1]),
                                    backgroundColor: colors,
                                    borderWidth: 0,
                                    hoverOffset: 4
                                }]
                            },
                            options: { responsive: true, cutout: '70%', plugins: { legend: { display: false } } }
                        });
                    }
                }, 50);
            } else { if (chartInstance) chartInstance.destroy(); }
        },

        renderSettings(container) {
            const s = this.state;
            const cats = s.categories
                .filter(c => c.type === s.settingsType)
                .sort((a, b) => (a.order || 0) - (b.order || 0));

            container.innerHTML = `
                <div class="flex flex-col h-full animate-up">
                    <div class="p-5 pb-2 shrink-0 bg-[#f8fafc] z-10">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-lg font-black text-slate-800">åˆ†é¡ç®¡ç†</h2>
                            <button onclick="window.app.state.isAdding=true; window.app.state.editingCatId=null; window.app.render();" class="bg-indigo-600 text-white p-2 rounded-xl shadow-lg"><i data-lucide="plus" class="w-5 h-5"></i></button>
                        </div>

                        <div class="flex gap-2 mb-4 bg-white p-1 rounded-xl shadow-sm border border-slate-100">
                            <button onclick="window.app.state.settingsType='expense'; window.app.render();" class="flex-1 py-2 rounded-lg font-bold text-[10px] ${s.settingsType==='expense'?'bg-rose-50 text-rose-600 shadow-sm ring-1 ring-rose-100':'text-slate-400 hover:bg-slate-50'}">æ”¯å‡ºé …ç›®</button>
                            <button onclick="window.app.state.settingsType='income'; window.app.render();" class="flex-1 py-2 rounded-lg font-bold text-[10px] ${s.settingsType==='income'?'bg-emerald-50 text-emerald-600 shadow-sm ring-1 ring-emerald-100':'text-slate-400 hover:bg-slate-50'}">æ”¶å…¥é …ç›®</button>
                        </div>

                        ${s.isAdding ? `<div class="bg-white p-5 rounded-[2rem] shadow-xl border border-indigo-50 mb-4 space-y-4 animate-up relative z-20">
                            <div class="flex gap-3"><input id="new-cat-icon" placeholder="åœ–ç¤º" class="w-16 bg-slate-50 p-3 rounded-xl text-center text-xl" maxlength="2"/><input id="new-cat-name" placeholder="åç¨±" class="flex-1 bg-slate-50 p-3 rounded-xl text-xs font-bold"/></div>
                            <div class="text-[10px] font-bold text-slate-400 pl-1">é¡åˆ¥ï¼š${s.settingsType==='expense'?'æ”¯å‡º':'æ”¶å…¥'}</div>
                            <input id="new-cat-subs" placeholder="å­é¡åˆ¥ (ä»¥é€—è™Ÿéš”é–‹)" class="w-full bg-slate-50 p-3 rounded-xl text-xs font-bold"/>
                            <div class="flex gap-2 pt-2">
                                <button onclick="window.app.saveCategory()" class="flex-1 bg-indigo-600 text-white py-3 rounded-xl font-bold text-xs">å„²å­˜</button>
                                <button onclick="window.app.state.isAdding=false; window.app.state.editingCatId=null; window.app.render();" class="flex-1 bg-slate-100 text-slate-500 py-3 rounded-xl font-bold text-xs">å–æ¶ˆ</button>
                            </div>
                        </div>` : ''}
                    </div>

                    <div class="flex-1 overflow-y-auto p-5 pt-0 pb-24 no-scrollbar">
                        <div id="sortable-list" class="space-y-2">
                            ${cats.map(c => `
                                <div data-id="${c.id}" class="bg-white p-3 pr-4 rounded-2xl flex items-center shadow-sm border border-slate-50 cursor-pointer active:scale-[0.99] transition group select-none">
                                    <div class="drag-handle px-3 text-slate-300 cursor-grab active:cursor-grabbing hover:text-slate-500"><i data-lucide="grip-vertical" class="w-5 h-5"></i></div>
                                    <div onclick="window.app.editCat('${c.id}')" class="flex-1 flex items-center gap-4">
                                        <span class="text-2xl">${c.icon}</span>
                                        <p class="font-bold text-sm text-slate-700">${c.name}</p>
                                    </div>
                                    <button onclick="window.app.deleteCat('${c.id}')" class="text-slate-400 hover:text-rose-500 p-2 transition"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                </div>`).join('')}
                        </div>
                    </div>
                </div>`;

            if (s.isAdding && s.editingCatId) {
                const cat = s.categories.find(c => c.id === s.editingCatId);
                if (cat) {
                    const iconInput = document.getElementById('new-cat-icon');
                    if (iconInput) {
                        iconInput.value = cat.icon;
                        document.getElementById('new-cat-name').value = cat.name;
                        document.getElementById('new-cat-subs').value = cat.subCategories.join(',');
                    }
                }
            }

            const list = document.getElementById('sortable-list');
            if (list) {
                new Sortable(list, {
                    handle: '.drag-handle',
                    animation: 150,
                    ghostClass: 'sortable-ghost',
                    dragClass: 'sortable-drag',
                    onEnd: function (evt) {
                        window.app.updateCategoryOrder();
                    }
                });
            }
        },

        async updateCategoryOrder() {
            const list = document.getElementById('sortable-list');
            const items = list.querySelectorAll('[data-id]');
            const batch = writeBatch(db);
            items.forEach((item, index) => {
                const id = item.getAttribute('data-id');
                const docRef = doc(db, 'artifacts', appId, 'users', this.state.user.uid, 'categories', id);
                batch.update(docRef, { order: index });
            });
            await batch.commit();
        },

        editCat(catId) {
            this.state.isAdding = true;
            this.state.editingCatId = catId;
            this.render();
        },

        async saveCategory() {
            const name = document.getElementById('new-cat-name').value;
            const icon = document.getElementById('new-cat-icon').value || 'ğŸ“';
            const subs = document.getElementById('new-cat-subs').value;
            const type = this.state.settingsType; 
            
            if (!name) return alert('å¿…å¡«åç¨±');
            
            const id = this.state.editingCatId || ('cat_' + Date.now());
            
            let order = 0;
            if (!this.state.editingCatId) {
                const existing = this.state.categories.filter(c => c.type === type);
                const maxOrder = existing.length > 0 ? Math.max(...existing.map(c => c.order || 0)) : -1;
                order = maxOrder + 1;
            }

            const data = {
                id, name, type, icon, 
                subCategories: subs.split(/[,ï¼Œ]/).map(s => s.trim()).filter(Boolean)
            };

            if (!this.state.editingCatId) {
                data.order = order;
            } else {
                const old = this.state.categories.find(c => c.id === id);
                data.order = old ? (old.order || 0) : 0;
            }

            await setDoc(doc(db, 'artifacts', appId, 'users', this.state.user.uid, 'categories', id), data);
            
            this.state.isAdding = false;
            this.state.editingCatId = null;
            this.render();
        },

        async deleteCat(id) { if (confirm('åˆªé™¤åˆ†é¡ï¼Ÿ')) await deleteDoc(doc(db, 'artifacts', appId, 'users', this.state.user.uid, 'categories', id)); },
        async deleteTx(id) { if (confirm('åˆªé™¤æ­¤å¸³ç›®ï¼Ÿ')) await deleteDoc(doc(db, 'artifacts', appId, 'users', this.state.user.uid, 'transactions', id)); }
    };

    onAuthStateChanged(auth, async (user) => {
        if (user && user.email === ALLOWED_USER) {
            window.app.state.user = user;
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('app-content').classList.remove('hidden');
            document.getElementById('user-display').innerText = user.email;
            unsubTx = onSnapshot(collection(db, 'artifacts', appId, 'users', user.uid, 'transactions'), snap => { window.app.state.transactions = snap.docs.map(d => ({ id: d.id, ...d.data() })).sort((a,b)=>b.timestamp-a.timestamp); window.app.render(); });
            unsubCat = onSnapshot(collection(db, 'artifacts', appId, 'users', user.uid, 'categories'), snap => { window.app.state.categories = snap.docs.map(d => ({ id: d.id, ...d.data() })); window.app.render(); });
        } else {
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('app-content').classList.add('hidden');
            if (user) { alert("ç„¡æ¬Šé™"); await signOut(auth); }
        }
    });

    document.getElementById('google-login-btn').onclick = () => signInWithPopup(auth, provider);
    document.getElementById('logout-btn').onclick = () => signOut(auth);
    // â˜…â˜…â˜… æ–°å¢é€™ä¸€è¡Œï¼šé é¢è¼‰å…¥æ™‚å…ˆåˆå§‹åŒ–åœ–ç¤ºï¼Œé€™æ¨£ç™»å…¥ç•«é¢çš„åœ–ç¤ºæ‰æœƒé¡¯ç¤º â˜…â˜…â˜…
    lucide.createIcons();
</script>
</body>
</html>
